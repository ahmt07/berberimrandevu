<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Ahmet Tekeli Kuaför • Online Randevu</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#111827">
<link rel="manifest" href="manifest.webmanifest">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#e5e7eb;
  --ink:#111827;
  --muted:#6b7280;
  --brand:#d4af37;
  --danger:#ef4444;
  --ok:#10b981;
}

/* RESET */
*{box-sizing:border-box;margin:0;padding:0}

/* === GENEL === */
html,body{
  font:15px/1.5 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--ink);
}

/* === ARKA PLAN === */
.bg{
  position:fixed;
  inset:0;
  z-index:-2;
  background:
    url("arka-plan.jpg") center/cover no-repeat,
    radial-gradient(circle at 10% 0%,rgba(148,163,184,.4),transparent 22%);
  filter:blur(10px);
}
.bg-overlay{
  position:fixed;
  inset:0;
  z-index:-1;
  background:
    linear-gradient(to bottom,rgba(255,255,255,.82),rgba(209,213,219,.96)),
    radial-gradient(circle at top,rgba(255,255,255,.72),transparent 55%);
}

/* INTRO ANİMASYON */
body{
  min-height:100vh;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:18px 10px 28px;
  animation:bodyFade 0.7s ease-out;
}
@keyframes bodyFade{
  from{opacity:0;transform:translateY(18px);}
  to{opacity:1;transform:translateY(0);}
}

/* dış çerçeve – cam panel */
.wrap{
  width:100%;
  max-width:420px;
  position:relative;
  border-radius:32px;
  padding:18px 16px 22px;
  background:
    linear-gradient(145deg,rgba(243,244,246,.92),rgba(229,231,235,.97));
  box-shadow:
    0 22px 70px rgba(15,23,42,.4),
    0 0 0 1px rgba(148,163,184,.35);
  backdrop-filter:blur(22px) saturate(145%);
}

/* === LOGO & ÜST BUTONLAR === */
.logo-wrap{
  display:flex;
  justify-content:center;
  margin-bottom:8px;
}
.logo-circle{
  width:92px;
  height:92px;
  border-radius:999px;
  background:url("logo.png") center/100% 100% no-repeat;
  position:relative;
  box-shadow:0 20px 46px rgba(0,0,0,.45);
}
.logo-circle::before{
  content:"";
  position:absolute;
  inset:-4px;
  border-radius:999px;
  background:
    conic-gradient(from 230deg,var(--brand),#fbbf24,#fef3c7,var(--brand));
  opacity:.9;
  z-index:-1;
  filter:blur(1.2px);
}
.logo-circle::after{
  content:"";
  position:absolute;
  inset:4px;
  border-radius:999px;
  background:
    radial-gradient(circle at 10% 0%,rgba(255,255,255,.9),transparent 55%);
  mix-blend-mode:screen;
}

/* üst sağ: admin & müşteri giriş */
.top-actions{
  position:absolute;
  top:12px;
  right:12px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.btn-top{
  border-radius:999px;
  padding:7px 13px;
  border:1px solid rgba(209,213,219,.9);
  cursor:pointer;
  font-size:12px;
  font-weight:600;
  background:rgba(255,255,255,.96);
  color:#111827;
  box-shadow:0 10px 26px rgba(15,23,42,.25);
  backdrop-filter:blur(18px);
  position:relative;
  overflow:hidden;
}
.btn-top span{opacity:.95}
.btn-top::after{
  content:"";
  position:absolute;
  inset:-40%;
  background:linear-gradient(120deg,transparent,rgba(255,255,255,.6),transparent);
  transform:translateX(-120%);
  transition:transform .7s ease-out;
}
.btn-top:hover::after{
  transform:translateX(120%);
}

/* === ANA KART === */
.card{
  border-radius:26px;
  padding:16px 14px 18px;
  border:1px solid rgba(209,213,219,.95);
  background:
    radial-gradient(circle at 0 0,rgba(255,255,255,1),rgba(243,244,246,.98));
  box-shadow:
    0 20px 50px rgba(15,23,42,.32),
    0 0 0 1px rgba(148,163,184,.25);
  color:var(--ink);
}

/* üst başlık */
.card-header{
  text-align:center;
  margin-bottom:14px;
}
.brand-title{
  font-size:24px;
  font-weight:800;
  letter-spacing:.14em;
  text-transform:uppercase;
}
.brand-sub{
  margin-top:2px;
  font-size:11px;
  letter-spacing:.25em;
  text-transform:uppercase;
  color:var(--muted);
}
.rating{
  margin-top:8px;
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  background:rgba(255,255,255,.98);
  border:1px solid rgba(209,213,219,.95);
  box-shadow:0 10px 24px rgba(15,23,42,.2);
}
.rating .star{
  width:12px;
  height:12px;
  clip-path:polygon(50% 0%,63% 38%,100% 38%,69% 59%,82% 100%,50% 76%,18% 100%,31% 59%,0 38%,37% 38%);
  background:var(--brand);
}

/* === FORM GENEL === */
.section-title{
  font-size:12px;
  font-weight:600;
  margin:8px 0 4px;
  color:#111827;
}
.input,
.select,
.date-input{
  width:100%;
  border-radius:13px;
  padding:8px 11px;
  border:1px solid rgba(209,213,219,.95);
  background:linear-gradient(135deg,rgba(255,255,255,.99),rgba(249,250,251,.99));
  color:#0f172a;
  font-size:13px;
}
.input::placeholder{color:#9ca3af}
.date-input{
  padding:6px 9px;
  font-size:10px;
}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.row > *{
  flex:1;
  min-width:0;
}

/* === BERBER SEÇİMİ – CHIPLER === */
.barber-choices{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.barber-chip{
  display:flex;
  align-items:center;
  gap:6px;
  padding:5px 9px;
  border-radius:999px;
  background:linear-gradient(135deg,rgba(243,244,246,1),rgba(229,231,235,1));
  border:1px solid rgba(209,213,219,1);
  cursor:pointer;
  font-size:11px;
  box-shadow:0 6px 14px rgba(15,23,42,.12);
}
.barber-chip.selected{
  background:linear-gradient(135deg,#fde68a,var(--brand));
  color:#111827;
  border-color:transparent;
}
.barber-avatar{
  width:24px;
  height:24px;
  border-radius:999px;
  overflow:hidden;
  flex-shrink:0;
  background:rgba(31,41,55,.08);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:10px;
  font-weight:700;
  text-transform:uppercase;
}
.barber-avatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* === SAAT GRID === */
.slot-grid{
  margin-top:6px;
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:7px;
}
.slot{
  border-radius:12px;
  padding:7px 0;
  border:1px solid rgba(209,213,219,1);
  background:rgba(255,255,255,.99);
  color:#111827;
  font-weight:600;
  font-size:11px;
  cursor:pointer;
  box-shadow:0 10px 22px rgba(15,23,42,.15);
}
.slot.selected{
  background:linear-gradient(135deg,#fde68a,var(--brand));
  color:#111827;
  border-color:transparent;
}
.slot.disabled{
  opacity:.28;
  pointer-events:none;
}

/* === RANDEVU AL BUTONU === */
.btn-book{
  width:100%;
  margin-top:14px;
  border-radius:999px;
  padding:11px 18px;
  border:none;
  cursor:pointer;
  font-size:13px;
  font-weight:800;
  letter-spacing:.18em;
  text-transform:uppercase;
  background:linear-gradient(135deg,#fef3c7,#facc15,var(--brand));
  color:#111827;
  box-shadow:
    0 18px 42px rgba(0,0,0,.22),
    0 0 0 1px rgba(180,148,60,.55);
  position:relative;
  overflow:hidden;
}
.btn-book::after{
  content:"";
  position:absolute;
  inset:-60%;
  background:linear-gradient(120deg,transparent,rgba(255,255,255,.7),transparent);
  transform:translateX(-130%);
  transition:transform .8s ease-out;
}
.btn-book:hover::after{
  transform:translateX(130%);
}

/* küçük açıklama */
.helper{
  margin-top:6px;
  font-size:11px;
  color:var(--muted);
}

/* === LİSTELER === */
.app-list{
  list-style:none;
  margin-top:4px;
}
.app-item{
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  gap:6px;
  padding:7px 7px;
  border-radius:13px;
  border:1px solid rgba(148,163,184,.7);
  background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.98));
  font-size:11px;
  backdrop-filter:blur(14px);
  color:#e5e7eb;
}
.app-main{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.app-title{font-weight:600;}
.app-meta{color:#cbd5f5;}
.app-actions{
  display:flex;
  gap:5px;
  align-items:center;
}
.btn-mini{
  border-radius:999px;
  border:none;
  padding:4px 9px;
  font-size:10px;
  cursor:pointer;
  font-weight:600;
}
.btn-mini.edit{
  background:rgba(16,185,129,.12);
  color:var(--ok);
  border:1px solid rgba(16,185,129,.7);
}
.btn-mini.del{
  background:rgba(239,68,68,.12);
  color:var(--danger);
  border:1px solid rgba(248,113,113,.7);
}
.btn-mini.wp{
  background:rgba(34,197,94,.12);
  color:#22c55e;
  border:1px solid rgba(34,197,94,.7);
}
.btn-mini.note{
  background:rgba(59,130,246,.12);
  color:#60a5fa;
  border:1px solid rgba(59,130,246,.7);
}

/* panel */
.panel{
  margin-top:10px;
  background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.99));
  border-radius:20px;
  padding:9px 9px 10px;
  border:1px solid rgba(148,163,184,.6);
  backdrop-filter:blur(16px);
  color:#e5e7eb;
}

/* === MODAL === */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.82);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:30;
}
.modal{
  width:100%;
  max-width:380px;
  background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.99));
  border-radius:24px;
  padding:14px 14px 14px;
  border:1px solid rgba(148,163,184,.7);
  box-shadow:0 24px 70px rgba(0,0,0,.9);
  backdrop-filter:blur(22px);
  color:#e5e7eb;
}
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}
.modal-title{font-size:14px;font-weight:700;}
.modal-close{
  border:none;
  background:none;
  color:#9ca3af;
  font-size:20px;
  cursor:pointer;
}

/* modal içi */
.tabs{
  display:flex;
  gap:6px;
  margin-bottom:10px;
}
.tab-btn{
  flex:1;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
  background:rgba(15,23,42,.9);
  color:#9ca3af;
  padding:6px 0;
  font-size:12px;
  font-weight:600;
  cursor:pointer;
}
.tab-btn.active{
  background:linear-gradient(135deg,#facc15,var(--brand));
  color:#111827;
  border-color:transparent;
}

.btn-full{
  width:100%;
  margin-top:9px;
  padding:9px 0;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,#fef3c7,#facc15,var(--brand));
  color:#111827;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 14px 40px rgba(0,0,0,.85);
  position:relative;
  overflow:hidden;
}
.btn-full::after{
  content:"";
  position:absolute;
  inset:-60%;
  background:linear-gradient(120deg,transparent,rgba(255,255,255,.7),transparent);
  transform:translateX(-130%);
  transition:transform .8s ease-out;
}
.btn-full:hover::after{
  transform:translateX(130%);
}

/* === ADMIN ÖZET & TABS === */
.admin-summary{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-bottom:10px;
}
.summary-card{
  flex:1;
  min-width:120px;
  padding:8px 10px;
  border-radius:16px;
  background:radial-gradient(circle at top,rgba(15,23,42,.95),rgba(15,23,42,1));
  border:1px solid rgba(250,204,21,.4);
  box-shadow:0 14px 40px rgba(0,0,0,.7);
  backdrop-filter:blur(18px) saturate(160%);
  display:flex;
  flex-direction:column;
  gap:2px;
}
.summary-label{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.12em;
  color:#e5e7eb;
  opacity:.85;
}
.summary-value{
  font-size:17px;
  font-weight:800;
  color:#facc15;
}
.summary-sub{
  font-size:11px;
  color:#cbd5f5;
}

.admin-tabs{
  display:flex;
  flex-wrap:wrap;
  gap:5px;
  margin-bottom:9px;
  background:linear-gradient(135deg,rgba(15,23,42,.9),rgba(15,23,42,.98));
  padding:4px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.7);
}
.admin-tab{
  flex:1;
  border-radius:999px;
  border:none;
  background:transparent;
  color:#9ca3af;
  padding:5px 0;
  font-size:11px;
  font-weight:600;
  cursor:pointer;
}
.admin-tab.active{
  background:linear-gradient(135deg,#facc15,var(--brand));
  color:#111827;
  box-shadow:0 10px 26px rgba(0,0,0,.85);
}
.admin-section{display:none;}
.admin-section.active{display:block;}

.admin-filter-row{
  display:flex;
  flex-direction:column;
  gap:8px;
  margin:6px 0 10px;
}

/* kapalı günler paneli */
.closed-panel-title{
  margin-top:10px;
  font-size:11px;
  font-weight:600;
  color:#e5e7eb;
}
.closed-date-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:4px 6px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.6);
  margin-top:4px;
  font-size:11px;
  color:#e5e7eb;
}
.closed-date-item span{color:#cbd5f5;}

/* === TOAST (VIP) === */
.toast{
  position:fixed;
  left:50%;
  top:14px;
  transform:translateX(-50%) scale(.9);
  background:radial-gradient(circle at top,rgba(15,23,42,.98),rgba(15,23,42,1));
  color:#f9fafb;
  padding:7px 14px 7px 32px;
  border-radius:999px;
  font-size:12px;
  border:1px solid rgba(148,163,184,.9);
  box-shadow:0 20px 60px rgba(0,0,0,.9);
  display:none;
  z-index:50;
  align-items:center;
  gap:6px;
}
.toast-icon{
  position:absolute;
  left:10px;
  font-size:13px;
}
.toast.ok{border-color:rgba(16,185,129,.7);}
.toast.err{border-color:rgba(248,113,113,.9);}
.toast.show{
  display:flex;
  animation:toastPop .25s ease-out;
}
@keyframes toastPop{
  from{opacity:0;transform:translateX(-50%) translateY(-8px) scale(.9);}
  to{opacity:1;transform:translateX(-50%) translateY(0) scale(1);}
}

/* === ÇALIŞMA SAATİ MODAL === */
.schedule-wrapper{
  max-height:65vh;
  overflow:auto;
  padding-right:4px;
}
.schedule-row{
  border-radius:14px;
  border:1px solid rgba(148,163,184,.6);
  padding:6px 7px;
  margin-bottom:6px;
  background:radial-gradient(circle at top,rgba(15,23,42,.97),rgba(15,23,42,1));
}
.schedule-row-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:11px;
  margin-bottom:4px;
}
.schedule-day-name{font-weight:600;}
.schedule-intervals{
  display:flex;
  flex-direction:column;
  gap:4px;
  margin-top:3px;
}
.schedule-interval{
  display:flex;
  gap:4px;
  align-items:center;
}
.schedule-interval select{
  flex:1;
  border-radius:10px;
  padding:4px 6px;
  border:1px solid rgba(148,163,184,.7);
  background:rgba(15,23,42,.95);
  color:#e5e7eb;
  font-size:11px;
}
.schedule-interval button{
  border:none;
  border-radius:999px;
  padding:3px 7px;
  font-size:10px;
  cursor:pointer;
  background:rgba(239,68,68,.12);
  color:var(--danger);
  border:1px solid rgba(248,113,113,.7);
}
.btn-add-interval{
  margin-top:4px;
  border-radius:999px;
  border:none;
  padding:3px 8px;
  font-size:10px;
  cursor:pointer;
  background:rgba(59,130,246,.12);
  color:#60a5fa;
  border:1px solid rgba(59,130,246,.7);
}
.day-active-label{
  font-size:10px;
  display:flex;
  align-items:center;
  gap:4px;
}
.day-active-label input{accent-color:var(--brand);}

/* === HIZLI MÜŞTERİ POPUP === */
.quick-backdrop{
  position:fixed;
  inset:0;
  z-index:45;
  display:none;
  align-items:flex-start;
  justify-content:center;
  background:rgba(15,23,42,.5);
}
.quick-card{
  margin-top:70px;
  width:90%;
  max-width:360px;
  border-radius:22px;
  padding:10px 12px 12px;
  background:radial-gradient(circle at top,rgba(15,23,42,.98),rgba(15,23,42,1));
  border:1px solid rgba(250,204,21,.65);
  box-shadow:0 28px 80px rgba(0,0,0,.95);
  color:#f9fafb;
}
.quick-head{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:4px;
}
.quick-icon{
  width:26px;
  height:26px;
  border-radius:999px;
  background:radial-gradient(circle at 30% 0,#facc15,#f97316);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:15px;
}
.quick-title{
  font-size:13px;
  font-weight:700;
}
.quick-body{
  font-size:11px;
  color:#e5e7eb;
  margin-top:4px;
}

/* === RESPONSIVE === */
@media(max-width:480px){
  .wrap{
    padding:16px 10px 18px;
    border-radius:28px;
  }
  .card{
    padding:14px 10px 16px;
  }
  .brand-title{font-size:22px;}
  .slot-grid{
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:6px;
  }
  .date-input{
    font-size:11px;
    padding:5px 8px;
  }
}
@media(min-width:600px){
  .admin-filter-row{
    flex-direction:row;
    align-items:flex-end;
    gap:12px;
  }
}

/* === YAZDIRMA === */
@media print{
  body{
    background:#ffffff;
    padding:0;
  }
  .bg,
  .bg-overlay,
  .wrap > .logo-wrap,
  .top-actions,
  .card,
  #customerModal,
  #scheduleModal,
  .toast,
  .quick-backdrop{
    display:none !important;
  }
  #adminModal{
    position:static;
    display:block !important;
    background:#ffffff;
  }
  #adminModal .modal{
    max-width:100%;
    border:none;
    box-shadow:none;
    padding:10px;
    background:#ffffff;
  }
  #adminLoginArea{display:none !important;}
  #adminPanelArea{
    display:block !important;
    max-height:none;
    overflow:visible;
  }
  .admin-tabs{display:none !important;}
  .admin-section{display:none !important;}
  .admin-section.active{display:block !important;}
  .btn-full{display:none !important;}
  .app-item{
    box-shadow:none;
    border:1px solid #ddd;
    background:#fff;
    color:#000;
  }
  .app-title,
  .app-meta{color:#000;}
}
</style>
</head>
<body>
<div class="bg"></div>
<div class="bg-overlay"></div>

<div class="wrap">
  <div class="logo-wrap">
    <div class="logo-circle"></div>
  </div>

  <div class="top-actions">
    <button class="btn-top" type="button" id="btnAdminOpen">
      <span id="adminBtnLabel">Admin Girişi</span>
    </button>
    <button class="btn-top" type="button" id="btnCustomerOpen">
      <span id="customerBtnLabel">Müşteri Girişi</span>
    </button>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="brand-title">AHMET TEKELİ</div>
      <div class="brand-sub">ERKEK KUAFÖRÜ</div>
      <div class="rating">
        <div class="star"></div>
        <span>⭐️ONLİNE RANDEVU⭐️</span>
      </div>
    </div>

    <div>
      <div class="section-title">Ad Soyad</div>
      <input class="input" id="nameInput" placeholder="Adınız ve Soyadınız">

      <div class="section-title">Telefon</div>
      <input class="input" id="phoneInput" placeholder="05xxxxxxxxx">

      <div class="row">
        <div>
          <div class="section-title">Berber Seçimi</div>
          <div class="barber-choices" id="barberChoices"></div>
          <select class="select" id="barberSelect" style="display:none;"></select>
        </div>
        <div>
          <div class="section-title">İşlem Seçimi</div>
          <select class="select" id="serviceSelect"></select>
        </div>
      </div>

      <div class="section-title" style="margin-top:8px;">Tarih</div>
      <input type="date" class="date-input" id="dateInput">

      <div class="section-title" style="margin-top:8px;">Saat Seçimi</div>
      <div class="slot-grid" id="slotGrid"></div>

      <button class="btn-book" id="btnBook">RANDEVU AL</button>
      <div class="helper" id="bookingHelper">
        Randevu almak için önce müşteri girişi yapmalısın. Müşteri panelinden kayıt olabilirsin.
      </div>
      <div class="helper" id="dayInfoHelper"></div>
    </div>
  </div>
</div>

<!-- Müşteri Paneli Modal -->
<div class="modal-backdrop" id="customerModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Müşteri Paneli</div>
      <button class="modal-close" type="button" id="modalClose">&times;</button>
    </div>

    <div id="customerLoggedBox" style="display:none;">
      <div class="helper" id="customerLoggedText"></div>

      <!-- Sadakat puanı paneli -->
      <div class="panel" id="loyaltyPanel" style="margin-top:8px;display:none;">
        <div class="section-title" style="color:#e5e7eb;">Sadakat Puanın</div>
        <div class="helper" id="loyaltyText" style="color:#e5e7eb;margin-top:2px;"></div>
      </div>

      <div id="customerAppsBox" class="panel" style="margin-top:8px;display:none;">
        <div class="section-title">Randevularım</div>
        <ul class="app-list" id="appListModal"></ul>
      </div>

      <div id="customerNotifBox" class="panel" style="margin-top:8px;display:none;">
        <div class="section-title">Bildirimlerim</div>
        <ul class="app-list" id="notifList"></ul>
      </div>

      <button class="btn-full" id="btnCustomerLogout" style="margin-top:8px;background:rgba(31,41,55,1);color:#f9fafb;">
        Çıkış Yap
      </button>
    </div>

    <div class="tabs" id="tabsRow">
      <button class="tab-btn active" type="button" data-tab="login">Giriş Yap</button>
      <button class="tab-btn" type="button" data-tab="register">Kayıt Ol</button>
    </div>

    <div id="loginTab">
      <div class="section-title">Telefon</div>
      <input class="input" id="loginPhone" placeholder="05xxxxxxxxx">
      <div class="section-title">Şifre</div>
      <input class="input" id="loginPass" type="password" placeholder="••••••">
      <button class="btn-full" id="btnLogin">Giriş Yap</button>
      <div class="helper">İlk defa geliyorsan üstten <b>Kayıt Ol</b> sekmesine geç.</div>
    </div>

    <div id="registerTab" style="display:none;">
      <div class="section-title">Ad Soyad</div>
      <input class="input" id="regName" placeholder="Adınız Soyadınız">
      <div class="section-title">Telefon</div>
      <input class="input" id="regPhone" placeholder="05xxxxxxxxx">
      <div class="section-title">Şifre</div>
      <input class="input" id="regPass" type="password" placeholder="En az 4 karakter">
      <button class="btn-full" id="btnRegister">Kayıt Ol</button>
      <div class="helper">Kayıt sonrası müşteri panelinden <b>Randevularım</b> & <b>Sadakat Puanın</b> alanlarına erişirsin.</div>
    </div>
  </div>
</div>

<!-- Admin Panel Modal -->
<div class="modal-backdrop" id="adminModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Admin Paneli</div>
      <button class="modal-close" type="button" id="adminModalClose">&times;</button>
    </div>

    <div id="adminLoginArea">
      <div class="section-title">Telefon</div>
      <input class="input" id="adminPhone" placeholder="Admin telefon">
      <div class="section-title">Şifre</div>
      <input class="input" id="adminPass" type="password" placeholder="Şifre">
      <button class="btn-full" id="btnAdminLogin">Admin Giriş Yap</button>
      <div class="helper">Bu alan sadece işletme sahibi içindir.</div>
    </div>

    <div id="adminPanelArea" style="display:none;max-height:70vh;overflow:auto;padding-right:4px;">

      <!-- Admin özet kutucukları -->
      <div class="admin-summary">
        <div class="summary-card">
          <div class="summary-label">Bugün Randevu</div>
          <div class="summary-value" id="sumTodayCount">0</div>
          <div class="summary-sub" id="sumTodayRevenue">0 ₺</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Toplam Randevu</div>
          <div class="summary-value" id="sumAllCount">0</div>
          <div class="summary-sub" id="sumAllRevenue">0 ₺</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Bugün Aktif Berber</div>
          <div class="summary-value" id="sumActiveBarber">0</div>
          <div class="summary-sub">Çalışma planına göre</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">En Çok Yapılan İşlem</div>
          <div class="summary-value" id="sumTopServiceName">-</div>
          <div class="summary-sub" id="sumTopServiceCount">0 adet</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">En Çok Randevu Alan Berber</div>
          <div class="summary-value" id="sumTopBarberName">-</div>
          <div class="summary-sub" id="sumTopBarberCount">0 adet</div>
        </div>
      </div>

      <div class="admin-tabs">
        <button class="admin-tab active" data-admin-section="adminSectionRapor">Raporlar</button>
        <button class="admin-tab" data-admin-section="adminSectionRandevu">Randevular</button>
        <button class="admin-tab" data-admin-section="adminSectionHizmet">Hizmet Yönetimi</button>
        <button class="admin-tab" data-admin-section="adminSectionBerber">Berber Yönetimi & Çalışma Saatleri</button>
      </div>

      <!-- RAPORLAR -->
      <div class="admin-section active" id="adminSectionRapor">
        <div class="section-title">Raporlar</div>
        <ul class="app-list" id="reportList"></ul>

        <button class="btn-full" id="btnPrintReports" style="margin-top:8px;">
          Raporları PDF Olarak Çıkar
        </button>

        <!-- Gün sonu özet metni -->
        <button class="btn-full" id="btnCopyTodaySummary" style="margin-top:8px;background:rgba(34,197,94,.18);color:#bbf7d0;">
          Bugün İçin Hikaye / Mesaj Metni Oluştur (Kopyala)
        </button>
      </div>

      <!-- RANDEVU YÖNETİMİ -->
      <div class="admin-section" id="adminSectionRandevu">
        <div class="section-title">Randevu Yönetimi</div>
        <div class="admin-filter-row">
          <div>
            <div class="section-title">Tarih Filtresi</div>
            <input type="date" class="date-input" id="adminDateFilter">
          </div>
          <div>
            <div class="section-title">Berber Filtresi</div>
            <select class="select" id="adminBarberFilter"></select>
          </div>
        </div>
        <ul class="app-list" id="adminAppList"></ul>
        <div class="helper" id="adminCountInfo"></div>

        <button class="btn-full" id="btnPrintAppointments" style="margin-top:8px;">
          Randevu Listesini PDF Olarak Çıkar
        </button>

        <div class="closed-panel-title">Kapalı Günler (Özel tatil / dükkân kapalı)</div>
        <div class="row" style="margin-top:4px;">
          <input type="date" class="date-input" id="closedDateInput">
          <button class="btn-full" id="btnAddClosedDate" style="margin-top:0;">Kapalı Gün Ekle</button>
        </div>
        <div id="closedDateList"></div>
      </div>

      <!-- HİZMET YÖNETİMİ -->
      <div class="admin-section" id="adminSectionHizmet">
        <div class="section-title">Hizmet Yönetimi</div>
        <ul class="app-list" id="serviceList"></ul>
        <div class="row" style="margin-top:6px;">
          <input class="input" id="newServiceName" placeholder="Hizmet adı (Saç Kesim)">
          <input class="input" id="newServicePrice" type="number" min="0" step="10" placeholder="Fiyat">
          <input class="input" id="newServiceDuration" type="number" min="15" step="15" placeholder="Süre (dk)">
        </div>
        <button class="btn-full" id="btnAddService" style="margin-top:6px;">Hizmet Ekle</button>
      </div>

      <!-- BERBER YÖNETİMİ & ÇALIŞMA SAATLERİ -->
      <div class="admin-section" id="adminSectionBerber">
        <div class="section-title">Berber Yönetimi & Çalışma Saatleri</div>
        <ul class="app-list" id="barberList"></ul>

        <div class="section-title" style="margin-top:10px;">Yeni Berber</div>
        <input class="input" id="newBarberName" placeholder="Örn: Ahmet TEKELİ">
        <div class="section-title">Fotoğraf Yükle (isteğe bağlı)</div>
        <input class="input" id="newBarberPhotoFile" type="file" accept="image/*" style="padding:6px 10px;">
        <button class="btn-full" id="btnAddBarber" style="margin-top:6px;">Berber Ekle</button>

        <button class="btn-full" id="btnResetData" style="margin-top:10px;background:#991b1b;color:#fef2f2;">
          Tüm Yerel Veriyi Sıfırla
        </button>
      </div>

      <button class="btn-full" id="btnAdminLogout" style="margin-top:14px;background:rgba(31,41,55,1);color:#f9fafb;">
        Admin Çıkış
      </button>
    </div>
  </div>
</div>

<!-- BERBER ÇALIŞMA SAATİ MODAL -->
<div class="modal-backdrop" id="scheduleModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="scheduleModalTitle">Çalışma Saatleri</div>
      <button class="modal-close" type="button" id="scheduleModalClose">&times;</button>
    </div>
    <div class="schedule-wrapper" id="scheduleWrapper"></div>
    <button class="btn-full" id="btnSaveSchedule">Çalışma Saatlerini Kaydet</button>
  </div>
</div>

<!-- Hızlı müşteri bildirim popup -->
<div class="quick-backdrop" id="quickNotify">
  <div class="quick-card">
    <div class="quick-head">
      <div class="quick-icon">✔</div>
      <div class="quick-title">Randevun Oluşturuldu</div>
    </div>
    <div class="quick-body" id="quickBodyText"></div>
  </div>
</div>

<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon">✔</span>
  <span id="toastText"></span>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  getDocs,
  setDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyD3S0XgKgNJLCJr3xQ-ASgr1gHz9MCou-4",
  authDomain: "randevularim-92ac2.firebaseapp.com",
  projectId: "randevularim-92ac2",
  storageBucket: "randevularim-92ac2.firebasestorage.app",
  messagingSenderId: "1092355095676",
  appId: "1:1092355095676:web:085921b2dff9d607b7ddf9"
};
const fbApp = initializeApp(firebaseConfig);
const db    = getFirestore(fbApp);

/* SABİTLER */
const SLOT_TIMES = [
  "08:00","08:30","09:00","09:30",
  "10:00","10:30","11:00","11:30",
  "12:00","12:30","13:00","13:30",
  "14:00","14:30","15:00","15:30",
  "16:00","16:30","17:00","17:30",
  "18:00","18:30","19:00","19:30",
  "20:00","20:30","21:00","21:30",
  "22:00","22:30","23:00","23:30"
];
const ADMIN_PHONE = "05356749243";
const ADMIN_PASS  = "ahmetgs";
const MAX_DAYS_AHEAD = 30;
const DAY_NAMES = ["Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi","Pazar"];
const LOYALTY_TARGET = 10;

/* LocalStorage keyleri */
const LS_SERVICES   = "ahmet_services";
const LS_BARBERS    = "ahmet_barbers_plain";
const LS_SCHEDULES  = "ahmet_barber_schedules";
const LS_CUSTOMERS  = "ahmet_customers";
const LS_CLOSED     = "ahmet_closed_dates";
const LS_ADMIN      = "ahmet_admin_logged";
const LS_CURRENT_CUST = "ahmet_current_customer";

/* STATE */
let services   = [];
let barbers    = [];
let schedules  = {};
let appointments = [];
let customers  = [];
let closedDates= [];
let currentCustomer = null;
let isAdminLoggedIn = false;
let selectedTime = null;
let currentScheduleBarberId = null;
let selectedBarberId = null;

/* DOM */
const slotGrid  = document.getElementById("slotGrid");
const dateInput = document.getElementById("dateInput");
const btnBook   = document.getElementById("btnBook");
const nameInput = document.getElementById("nameInput");
const phoneInput= document.getElementById("phoneInput");
const barberSel = document.getElementById("barberSelect");
const barberChoicesEl = document.getElementById("barberChoices");
const servSel   = document.getElementById("serviceSelect");
const toastEl   = document.getElementById("toast");
const toastText = document.getElementById("toastText");
const toastIcon = document.getElementById("toastIcon");
const bookingHelper = document.getElementById("bookingHelper");
const dayInfoHelper = document.getElementById("dayInfoHelper");

/* müşteri DOM */
const customerModal      = document.getElementById("customerModal");
const btnCustomerOpen    = document.getElementById("btnCustomerOpen");
const modalClose         = document.getElementById("modalClose");
const tabBtns            = document.querySelectorAll(".tab-btn");
const loginTab           = document.getElementById("loginTab");
const registerTab        = document.getElementById("registerTab");
const btnLogin           = document.getElementById("btnLogin");
const btnRegister        = document.getElementById("btnRegister");
const customerLoggedBox  = document.getElementById("customerLoggedBox");
const customerLoggedText = document.getElementById("customerLoggedText");
const btnCustomerLogout  = document.getElementById("btnCustomerLogout");
const customerBtnLabel   = document.getElementById("customerBtnLabel");
const customerAppsBox    = document.getElementById("customerAppsBox");
const customerNotifBox   = document.getElementById("customerNotifBox");
const appListModal       = document.getElementById("appListModal");
const notifList          = document.getElementById("notifList");
const tabsRow            = document.getElementById("tabsRow");
const loginPhone         = document.getElementById("loginPhone");
const loginPass          = document.getElementById("loginPass");
const regName            = document.getElementById("regName");
const regPhone           = document.getElementById("regPhone");
const regPass            = document.getElementById("regPass");
const loyaltyPanel       = document.getElementById("loyaltyPanel");
const loyaltyText        = document.getElementById("loyaltyText");

/* admin DOM */
const adminModalEl     = document.getElementById("adminModal");
const btnAdminOpen     = document.getElementById("btnAdminOpen");
const adminModalClose  = document.getElementById("adminModalClose");
const adminLoginArea   = document.getElementById("adminLoginArea");
const adminPanelArea   = document.getElementById("adminPanelArea");
const btnAdminLogin    = document.getElementById("btnAdminLogin");
const btnAdminLogout   = document.getElementById("btnAdminLogout");
const adminBtnLabel    = document.getElementById("adminBtnLabel");
const adminTabBtns     = document.querySelectorAll(".admin-tab");
const adminSections    = document.querySelectorAll(".admin-section");
const adminPhoneInput  = document.getElementById("adminPhone");
const adminPassInput   = document.getElementById("adminPass");

const serviceListEl  = document.getElementById("serviceList");
const newServiceNameEl  = document.getElementById("newServiceName");
const newServicePriceEl = document.getElementById("newServicePrice");
const newServiceDurationEl = document.getElementById("newServiceDuration");
const btnAddService  = document.getElementById("btnAddService");

const barberListEl   = document.getElementById("barberList");
const newBarberNameEl= document.getElementById("newBarberName");
const newBarberPhotoFileEl= document.getElementById("newBarberPhotoFile");
const btnAddBarber   = document.getElementById("btnAddBarber");
const btnResetData   = document.getElementById("btnResetData");

const adminDateFilter   = document.getElementById("adminDateFilter");
const adminBarberFilter = document.getElementById("adminBarberFilter");
const adminAppList      = document.getElementById("adminAppList");
const adminCountInfo    = document.getElementById("adminCountInfo");
const reportListEl      = document.getElementById("reportList");
const btnPrintReports   = document.getElementById("btnPrintReports");
const btnPrintAppointments = document.getElementById("btnPrintAppointments");
const btnCopyTodaySummary = document.getElementById("btnCopyTodaySummary");

/* kapalı günler */
const closedDateInput   = document.getElementById("closedDateInput");
const btnAddClosedDate  = document.getElementById("btnAddClosedDate");
const closedDateList    = document.getElementById("closedDateList");

/* çalışma saatleri */
const scheduleModal    = document.getElementById("scheduleModal");
const scheduleModalTitle = document.getElementById("scheduleModalTitle");
const scheduleModalClose = document.getElementById("scheduleModalClose");
const scheduleWrapper  = document.getElementById("scheduleWrapper");
const btnSaveSchedule  = document.getElementById("btnSaveSchedule");

/* hızlı popup */
const quickNotify      = document.getElementById("quickNotify");
const quickBodyText    = document.getElementById("quickBodyText");

/* özet elemanlar */
const sumTodayCountEl   = document.getElementById("sumTodayCount");
const sumTodayRevenueEl = document.getElementById("sumTodayRevenue");
const sumAllCountEl     = document.getElementById("sumAllCount");
const sumAllRevenueEl   = document.getElementById("sumAllRevenue");
const sumActiveBarberEl = document.getElementById("sumActiveBarber");
const sumTopServiceNameEl  = document.getElementById("sumTopServiceName");
const sumTopServiceCountEl = document.getElementById("sumTopServiceCount");
const sumTopBarberNameEl   = document.getElementById("sumTopBarberName");
const sumTopBarberCountEl  = document.getElementById("sumTopBarberCount");

/* YARDIMCI */
function showToast(message,type="ok"){
  toastText.textContent = message;
  toastEl.className = "toast "+type+" show";
  toastIcon.textContent = type==="ok"?"✔":"!";
  try{
    if(window.navigator && navigator.vibrate){
      navigator.vibrate(40);
    }
  }catch(e){}
  setTimeout(()=>{
    toastEl.classList.remove("show");
    toastEl.style.display="none";
    setTimeout(()=>{toastEl.style.display="flex";},10);
  },2600);
  toastEl.style.display="flex";
}
function todayStr(){
  return new Date().toISOString().slice(0,10);
}
function timeToMinutes(t){
  const [h,m]=t.split(":").map(Number);
  return h*60+m;
}
function createDefaultSchedule(){
  const arr=[];
  for(let i=0;i<7;i++){
    arr.push({
      active: i<6,
      intervals:[{start:"09:00",end:"19:00"}]
    });
  }
  return arr;
}

/* müşteri bildirimleri */
function getNotificationKey(){
  if(!currentCustomer) return null;
  return "ahmet_notif_"+currentCustomer.phone;
}
function pushCustomerNotification(type,msg){
  const key = getNotificationKey();
  if(!key) return;
  let list = [];
  try{list = JSON.parse(localStorage.getItem(key)||"[]");}catch(e){}
  list.unshift({
    type,
    msg,
    at: new Date().toLocaleString("tr-TR")
  });
  localStorage.setItem(key,JSON.stringify(list));
  renderNotifications();
}
function renderNotifications(){
  if(!currentCustomer){
    customerNotifBox.style.display="none";
    notifList.innerHTML="";
    return;
  }
  const key = getNotificationKey();
  let list = [];
  try{list = JSON.parse(localStorage.getItem(key)||"[]");}catch(e){}
  if(!list.length){
    customerNotifBox.style.display="none";
    notifList.innerHTML="";
    return;
  }
  customerNotifBox.style.display="block";
  notifList.innerHTML = list.map(n=>{
    let label = "Bilgi";
    let color = "#22c55e";
    if(n.type==="deleted"){label="İptal"; color="#f97373";}
    if(n.type==="updated"){label="Güncelleme"; color="#60a5fa";}
    return `
      <li class="app-item">
        <div class="app-main">
          <div class="app-title" style="color:${color}">${label}</div>
          <div class="app-meta">${n.msg}</div>
        </div>
        <div class="app-meta">${n.at}</div>
      </li>
    `;
  }).join("");
}
function showQuickPopupFor(app){
  const text = `${app.date} ${app.time} • ${app.barberName} • ${app.serviceName}`;
  quickBodyText.textContent = text;
  quickNotify.style.display="flex";
  setTimeout(()=>{quickNotify.style.display="none";},1800);
}

/* FIRESTORE – randevular */
async function loadAppointmentsFromFirestore(){
  try{
    const snap = await getDocs(collection(db,"appointments"));
    const arr = [];

    snap.forEach(d => {
      const data = d.data();

      // eski kayıtların id'si yoksa doc.id kullan
      if(!data.id){
        data.id = d.id;
      }
      // status yoksa aktif say
      if(!data.status){
        data.status = "active";
      }

      arr.push(data);
    });

    appointments = arr.sort((a,b)=>{
      const k1 = `${a.date || ""} ${a.time || ""}`;
      const k2 = `${b.date || ""} ${b.time || ""}`;
      return k1.localeCompare(k2);
    });

    renderAll();
    console.log("Randevular yüklendi:", appointments.length);

  }catch(err){
    console.error("Firestore randevu yükleme hatası:", err);
  }
}
async function saveAppointmentToFirestore(app){
  try{await setDoc(doc(db,"appointments",app.id),app);}catch(err){
    console.error("Randevu kaydet hata:",err);
  }
}
async function deleteAppointmentFromFirestore(id){
  try{await deleteDoc(doc(db,"appointments",id));}catch(err){
    console.error("Randevu sil hata:",err);
  }
}

/* LOCAL DATA */
function loadLocalData(){
  try{services = JSON.parse(localStorage.getItem(LS_SERVICES)||"[]");}catch(e){services=[];}
  try{barbers  = JSON.parse(localStorage.getItem(LS_BARBERS)||"[]");}catch(e){barbers=[];}
  try{schedules= JSON.parse(localStorage.getItem(LS_SCHEDULES)||"{}");}catch(e){schedules={};}
  try{customers= JSON.parse(localStorage.getItem(LS_CUSTOMERS)||"[]");}catch(e){customers=[];}
  try{closedDates=JSON.parse(localStorage.getItem(LS_CLOSED)||"[]");}catch(e){closedDates=[];}

  if(!services.length){
    services = [
      {id:"svc-sac",name:"Saç Kesim",price:250,duration:30},
      {id:"svc-sac-sakal",name:"Saç + Sakal",price:400,duration:60},
      {id:"svc-sakal",name:"Sakal",price:200,duration:20}
    ];
  }
  if(!barbers.length){
    barbers = [
      {id:"brb-ahmet",name:"Ahmet TEKELİ",photo:null},
      {id:"brb-cirak", name:"Çırak",photo:null}
    ];
  }

  // müşteri puan alanını normalize et
  customers.forEach(c=>{
    if(typeof c.points!=="number" || isNaN(c.points)){
      c.points = 0;
    }
  });

  barbers.forEach(b=>{
    if(!Array.isArray(schedules[b.id]) || schedules[b.id].length!==7){
      schedules[b.id] = createDefaultSchedule();
    }
  });
  saveSchedules();

  const currentCustPhone = localStorage.getItem(LS_CURRENT_CUST);
  if(currentCustPhone){
    currentCustomer = customers.find(c=>c.phone===currentCustPhone) || null;
  }
  isAdminLoggedIn = localStorage.getItem(LS_ADMIN)==="1";
}
function saveServices(){localStorage.setItem(LS_SERVICES,JSON.stringify(services));}
function saveBarbers(){localStorage.setItem(LS_BARBERS,JSON.stringify(barbers));}
function saveSchedules(){localStorage.setItem(LS_SCHEDULES,JSON.stringify(schedules));}
function saveCustomers(){localStorage.setItem(LS_CUSTOMERS,JSON.stringify(customers));}
function saveClosedDates(){localStorage.setItem(LS_CLOSED,JSON.stringify(closedDates));}

/* RENDER */
function renderServices(){
  servSel.innerHTML = services.map(s=>`
    <option value="${s.id}">
      ${s.name} • ${s.price}₺ • ${s.duration}dk
    </option>
  `).join("");
  serviceListEl.innerHTML = services.map(s=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${s.name}</div>
        <div class="app-meta">${s.price} ₺ • ${s.duration} dk</div>
      </div>
      <div class="app-actions">
        <button class="btn-mini del" onclick="window.deleteService('${s.id}')">Sil</button>
      </div>
    </li>
  `).join("");
}

/* BERBER RENDER */
function renderBarbers(){
  barberSel.innerHTML = barbers.map(b=>`
    <option value="${b.id}">${b.name}</option>
  `).join("");

  if(!selectedBarberId && barbers[0]){
    selectedBarberId = barbers[0].id;
  }
  if(selectedBarberId && !barbers.some(b=>b.id===selectedBarberId) && barbers[0]){
    selectedBarberId = barbers[0].id;
  }
  if(selectedBarberId){
    barberSel.value = selectedBarberId;
  }

  const chips = barbers.map(b=>{
    const initials = b.name.split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase();
    const selClass = b.id===selectedBarberId ? "barber-chip selected" : "barber-chip";
    return `
      <div class="${selClass}" data-id="${b.id}">
        <div class="barber-avatar">${initials}</div>
        <span>${b.name}</span>
      </div>
    `;
  }).join("");
  barberChoicesEl.innerHTML = chips;

  adminBarberFilter.innerHTML = `
    <option value="">Tümü</option>
    ${barbers.map(b=>`<option value="${b.id}">${b.name}</option>`).join("")}
  `;

  barberListEl.innerHTML = barbers.map(b=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${b.name}</div>
        <div class="app-meta">Çalışma saatlerini düzenle</div>
      </div>
      <div class="app-actions">
        <button class="btn-mini note" onclick="window.openSchedule('${b.id}')">Saat</button>
        <button class="btn-mini del" onclick="window.deleteBarber('${b.id}')">Sil</button>
      </div>
    </li>
  `).join("");

  Array.from(barberChoicesEl.querySelectorAll(".barber-chip")).forEach(chip=>{
    chip.addEventListener("click",()=>{
      const id = chip.getAttribute("data-id");
      setSelectedBarber(id);
    });
  });
}
function setSelectedBarber(id){
  selectedBarberId = id;
  if(id) barberSel.value = id;
  Array.from(barberChoicesEl.querySelectorAll(".barber-chip")).forEach(ch=>{
    ch.classList.toggle("selected", ch.getAttribute("data-id")===id);
  });
  renderSlots();
}

/* SAATLER */
function renderSlots(){
  const dateVal = dateInput.value;
  slotGrid.innerHTML = "";
  selectedTime = null;

  if(!dateVal){
    dayInfoHelper.textContent = "Lütfen bir tarih seç.";
    return;
  }

  const today = todayStr();
  const todayDate = new Date(today);
  const pickedDate = new Date(dateVal);

  if(pickedDate < todayDate){
    dayInfoHelper.textContent = "Geçmiş tarihe randevu alınamaz.";
    return;
  }
  const diffDay = (pickedDate - todayDate)/86400000;
  if(diffDay>MAX_DAYS_AHEAD){
    dayInfoHelper.textContent = `En fazla ${MAX_DAYS_AHEAD} gün sonrasına randevu alabilirsin.`;
    return;
  }

  if(closedDates.some(d=>d===dateVal)){
    dayInfoHelper.textContent = "Bu tarih için dükkân kapalı.";
    return;
  }

  const barberId = selectedBarberId || (barbers[0]?.id||null);
  const brb = barbers.find(b=>b.id===barberId) || null;

  const jsDay = pickedDate.getDay();
  const dayIndex = (jsDay+6)%7;

  const sch = schedules[barberId];
  const daySch = sch ? sch[dayIndex] : null;

  if(daySch){
    if(!daySch.active){
      dayInfoHelper.textContent = `${brb?brb.name:"Berber"} bu gün için pasif.`;
      return;
    }
    if(!daySch.intervals || !daySch.intervals.length){
      dayInfoHelper.textContent = `${brb?brb.name:"Berber"} için bu güne saat tanımlı değil.`;
      return;
    }
  }

  const isToday = (dateVal===today);
  const nowMinutes = new Date().getHours()*60 + new Date().getMinutes();

  const btns=[];
  for(const t of SLOT_TIMES){
    const tm = timeToMinutes(t);

    if(isToday && tm <= nowMinutes+2){
      continue;
    }

    if(daySch){
      let inInterval=false;
      for(const it of daySch.intervals){
        const sMin=timeToMinutes(it.start);
        const eMin=timeToMinutes(it.end);
        if(tm>=sMin && tm<eMin){
          inInterval=true;break;
        }
      }
      if(!inInterval) continue;
    }

    let disabled=false;
    if(appointments.some(a=>a.date===dateVal && a.barberId===barberId && a.time===t)){
      disabled=true;
    }

    const cls=["slot"];
    if(disabled) cls.push("disabled");
    btns.push(`
      <button type="button" class="${cls.join(" ")}" data-time="${t}" ${disabled?"disabled":""}>
        ${t}
      </button>
    `);
  }

  if(!btns.length){
    dayInfoHelper.textContent = `${brb?brb.name:"Berber"} için bu tarih/saatte uygun boşluk yok.`;
    return;
  }

  slotGrid.innerHTML = btns.join("");
  dayInfoHelper.textContent = "";

  Array.from(slotGrid.querySelectorAll(".slot")).forEach(btn=>{
    btn.addEventListener("click",()=>{
      Array.from(slotGrid.querySelectorAll(".slot")).forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedTime = btn.getAttribute("data-time");
    });
  });
}

function renderClosedDateList(){
  closedDateList.innerHTML = closedDates.map(d=>`
    <div class="closed-date-item">
      <span>${d}</span>
      <button class="btn-mini del" onclick="window.deleteClosedDate('${d}')">Sil</button>
    </div>
  `).join("");
}

/* müşteri randevuları */
function renderMyAppointments(){
  if(!currentCustomer){
    customerAppsBox.style.display="none";
    appListModal.innerHTML="";
    return;
  }
  const list = appointments.filter(a=>a.phone===currentCustomer.phone);
  if(!list.length){
    customerAppsBox.style.display="none";
    appListModal.innerHTML="";
    return;
  }
  customerAppsBox.style.display="block";
  appListModal.innerHTML = list.map(a=>{
    const status = a.status || "active";
    const statusLabel = status==="noshow" ? ' • <span style="color:#f97373;">(Gelmedi)</span>' : "";
    return `
      <li class="app-item">
        <div class="app-main">
          <div class="app-title">${a.date} • ${a.time}</div>
          <div class="app-meta">${a.serviceName} • ${a.barberName}${statusLabel}</div>
        </div>
        <div class="app-actions">
          <button class="btn-mini del" onclick="window.cancelMyAppointment('${a.id}')">İptal</button>
        </div>
      </li>
    `;
  }).join("");
}

/* admin randevu listesi */
function renderAdminAppointments(){
  let list=[...appointments];
  const fDate=adminDateFilter.value;
  const fBarber=adminBarberFilter.value;

  if(fDate) list=list.filter(a=>a.date===fDate);
  if(fBarber) list=list.filter(a=>a.barberId===fBarber);

  adminAppList.innerHTML = list.map(a=>{
    const status = a.status || "active";
    const statusBadge = status==="noshow"
      ? '<span style="color:#f97373;font-weight:600;">(Gelmedi)</span>'
      : "";
    const noshowBtn = status==="noshow"
      ? ""
      : `<button class="btn-mini note" onclick="window.markNoShow('${a.id}')">Gelmedi</button>`;
    return `
      <li class="app-item">
        <div class="app-main">
          <div class="app-title">${a.date} • ${a.time} ${statusBadge}</div>
          <div class="app-meta">${a.name} • ${a.phone}</div>
          <div class="app-meta">${a.serviceName} • ${a.price} ₺ • ${a.barberName}</div>
        </div>
        <div class="app-actions">
          ${noshowBtn}
          <button class="btn-mini del" onclick="window.deleteAppointment('${a.id}')">Sil</button>
          <button class="btn-mini wp" onclick="window.sendWp('${a.phone}','${encodeURIComponent("Randevunuz "+a.date+" "+a.time+" için oluşturulmuştur")}')">WP</button>
        </div>
      </li>
    `;
  }).join("");
  adminCountInfo.textContent = `${list.length} adet randevu listelendi.`;
  updateAdminSummary();
}

/* raporlar – no-show'lar ciroya dahil değil */
function renderReports(){
  const map={};
  appointments.forEach(a=>{
    const status = a.status || "active";
    if(status==="noshow") return;
    const key=`${a.date}#${a.serviceName}`;
    if(!map[key]) map[key]={count:0,total:0,date:a.date,service:a.serviceName};
    map[key].count++;
    map[key].total += Number(a.price||0);
  });
  const rows = Object.values(map).sort((a,b)=>a.date.localeCompare(b.date));
  reportListEl.innerHTML = rows.map(r=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${r.date} • ${r.service}</div>
        <div class="app-meta">${r.count} adet • ${r.total} ₺</div>
      </div>
    </li>
  `).join("");
  updateAdminSummary();
}

/* admin özet – no-show hariç */
function updateAdminSummary(){
  const tStr = todayStr();
  const todays = appointments.filter(a=>{
    const status = a.status || "active";
    return a.date===tStr && status!=="noshow";
  });
  let todayRevenue=0; todays.forEach(a=>todayRevenue+=Number(a.price||0));
  const validApps = appointments.filter(a=>{
    const status = a.status || "active";
    return status!=="noshow";
  });
  let allRevenue=0; validApps.forEach(a=>allRevenue+=Number(a.price||0));

  const today = new Date();
  const jsDay = today.getDay();
  const idx = (jsDay+6)%7;

  const activeBarbers = barbers.filter(b=>{
    const sch = schedules[b.id];
    const day = sch && sch[idx];
    return day && day.active && day.intervals && day.intervals.length>0;
  }).length;

  sumTodayCountEl.textContent   = todays.length;
  sumTodayRevenueEl.textContent = todayRevenue+" ₺";
  sumAllCountEl.textContent     = validApps.length;
  sumAllRevenueEl.textContent   = allRevenue+" ₺";
  sumActiveBarberEl.textContent = activeBarbers;

  let topServiceId=null, topCount=0;
  const sCounts={};
  validApps.forEach(a=>{
    if(!a.serviceId) return;
    sCounts[a.serviceId]=(sCounts[a.serviceId]||0)+1;
  });
  Object.keys(sCounts).forEach(id=>{
    if(sCounts[id]>topCount){topCount=sCounts[id];topServiceId=id;}
  });
  if(topServiceId){
    const svc = services.find(s=>s.id===topServiceId);
    sumTopServiceNameEl.textContent = svc?svc.name:"Bilinmiyor";
    sumTopServiceCountEl.textContent = `${topCount} adet`;
  }else{
    sumTopServiceNameEl.textContent="-";
    sumTopServiceCountEl.textContent="0 adet";
  }

  let topBarberId=null, topBarberCount=0;
  const bCounts={};
  validApps.forEach(a=>{
    if(!a.barberId) return;
    bCounts[a.barberId]=(bCounts[a.barberId]||0)+1;
  });
  Object.keys(bCounts).forEach(id=>{
    if(bCounts[id]>topBarberCount){topBarberCount=bCounts[id];topBarberId=id;}
  });
  if(topBarberId){
    const brb = barbers.find(b=>b.id===topBarberId);
    sumTopBarberNameEl.textContent = brb?brb.name:"Bilinmiyor";
    sumTopBarberCountEl.textContent = `${topBarberCount} adet`;
  }else{
    sumTopBarberNameEl.textContent="-";
    sumTopBarberCountEl.textContent="0 adet";
  }
}

/* Sadakat paneli */
function renderLoyalty(){
  if(!currentCustomer){
    loyaltyPanel.style.display="none";
    loyaltyText.textContent="";
    return;
  }
  const pts = currentCustomer.points || 0;
  const level = Math.floor(pts / LOYALTY_TARGET);
  const currentCycle = pts % LOYALTY_TARGET;
  const remain = (LOYALTY_TARGET - currentCycle) % LOYALTY_TARGET;

  loyaltyPanel.style.display="block";
  let line1 = `Toplam puanın: ${pts}`;
  let line2 = "";
  if(pts===0){
    line2 = `Her randevuda +1 puan. ${LOYALTY_TARGET} puanda 1 ücretsiz hizmet.`;
  }else if(remain===0){
    line2 = `Tebrikler! En az bir ücretsiz hizmet hakkın var. (${level} hak birikti)`;
  }else{
    line2 = `${remain} puan sonra 1 ücretsiz hizmet hakkı kazanırsın.`;
  }
  loyaltyText.innerHTML = `${line1}<br>${line2}`;
}

/* genel render */
function renderAll(){
  renderServices();
  renderBarbers();
  renderSlots();
  renderAdminAppointments();
  renderMyAppointments();
  renderReports();
  renderClosedDateList();
  renderNotifications();
  refreshBookingHelper();
  renderLoyalty();
}

/* müşteri UI */
function refreshCustomerUI(){
  if(currentCustomer){
    customerLoggedBox.style.display="block";
    tabsRow.style.display="none";
    loginTab.style.display="none";
    registerTab.style.display="none";
    customerLoggedText.innerHTML = `Hoş geldin <b>${currentCustomer.name}</b> • ${currentCustomer.phone}`;
    customerBtnLabel.textContent = "Müşteri Paneli";
    nameInput.value = currentCustomer.name || "";
    phoneInput.value = currentCustomer.phone || "";
    bookingHelper.textContent = "Hoş geldin, randevunu oluşturup aşağıdan saat seçebilirsin.";
  }else{
    customerLoggedBox.style.display="none";
    tabsRow.style.display="flex";
    loginTab.style.display="block";
    registerTab.style.display="none";
    tabBtns.forEach(b=>b.classList.toggle("active",b.dataset.tab==="login"));
    customerBtnLabel.textContent = "Müşteri Girişi";
    if(!nameInput.value && !phoneInput.value){
      bookingHelper.textContent = "Randevu almak için önce müşteri girişi yapmalısın. Müşteri panelinden kayıt olabilirsin.";
    }
  }
  renderMyAppointments();
  renderNotifications();
  renderLoyalty();
}
function refreshBookingHelper(){
  if(currentCustomer){
    bookingHelper.textContent = "Hoş geldin, randevunu oluşturup aşağıdan saat seçebilirsin.";
  }
}

/* EVENTLER */
dateInput.addEventListener("change",renderSlots);

btnBook.addEventListener("click",async ()=>{
  const name = nameInput.value.trim();
  const phone= phoneInput.value.trim();
  const serviceId = servSel.value;
  const barberId  = selectedBarberId || (barbers[0]?.id||null);
  const dateVal   = dateInput.value;
  const timeVal   = selectedTime;

  if(!currentCustomer){
    showToast("Lütfen önce müşteri girişi yap.","err");
    return;
  }
  if(!name || !phone || !serviceId || !barberId || !dateVal || !timeVal){
    showToast("Lütfen tüm alanları doldur ve saat seç.","err");
    return;
  }
  const tStr=todayStr();
  if(dateVal<tStr){
    showToast("Geçmiş tarihe randevu alınamaz.","err");
    return;
  }
  const diffDay=(new Date(dateVal)-new Date(tStr))/86400000;
  if(diffDay>MAX_DAYS_AHEAD){
    showToast(`En fazla ${MAX_DAYS_AHEAD} gün sonrasına randevu alabilirsin.`,"err");
    return;
  }
  if(appointments.some(a=>a.date===dateVal && a.barberId===barberId && a.time===timeVal)){
    showToast("Bu saat dolu, lütfen başka bir saat seç.","err");
    renderSlots();
    return;
  }

  const svc = services.find(s=>s.id===serviceId);
  const brb = barbers.find(b=>b.id===barberId);

  const app = {
    id:"app_"+Date.now(),
    name,
    phone,
    date:dateVal,
    time:timeVal,
    serviceId,
    serviceName:svc?svc.name:"İşlem",
    price:svc?svc.price:0,
    barberId,
    barberName:brb?brb.name:"Berber",
    createdAt:new Date().toISOString(),
    status:"active"
  };
  appointments.push(app);
  await saveAppointmentToFirestore(app);

  // Sadakat puanı arttır
  const custIndex = customers.findIndex(c=>c.phone===currentCustomer.phone);
  if(custIndex>-1){
    customers[custIndex].points = (customers[custIndex].points || 0) + 1;
    currentCustomer.points = customers[custIndex].points;
    saveCustomers();
  }

  renderAll();

  pushCustomerNotification("added",`${dateVal} ${timeVal} için randevunuz oluşturuldu.`);
  showQuickPopupFor(app);
  showToast("Randevun oluşturuldu. (+1 puan)","ok");

  try{
    if("Notification" in window){
      if(Notification.permission==="granted"){
        new Notification("Yeni Randevu",{
          body:`${app.date} ${app.time} • ${app.name} • ${app.serviceName}`,
        });
      }else if(Notification.permission!=="denied"){
        Notification.requestPermission();
      }
    }
  }catch(e){}
});

/* müşteri modal */
btnCustomerOpen.addEventListener("click",()=>{customerModal.style.display="flex";});
modalClose.addEventListener("click",()=>{customerModal.style.display="none";});

/* müşteri tabları */
tabBtns.forEach(btn=>{
  btn.addEventListener("click",()=>{
    const target=btn.dataset.tab;
    tabBtns.forEach(b=>b.classList.toggle("active",b===btn));
    loginTab.style.display=target==="login"?"block":"none";
    registerTab.style.display=target==="register"?"block":"none";
  });
});

/* kayıt */
btnRegister.addEventListener("click",()=>{
  const name = regName.value.trim();
  const phone= regPhone.value.trim();
  const pass = regPass.value.trim();
  if(!name || !phone || !pass){
    showToast("Lütfen tüm alanları doldur.","err");
    return;
  }
  if(pass.length<4){
    showToast("Şifre en az 4 karakter olmalı.","err");
    return;
  }
  if(customers.some(c=>c.phone===phone)){
    showToast("Bu telefon ile kayıt zaten var.","err");
    return;
  }
  const cust={id:"c_"+Date.now(),name,phone,pass,points:0};
  customers.push(cust);
  saveCustomers();
  currentCustomer=cust;
  localStorage.setItem(LS_CURRENT_CUST,cust.phone);
  refreshCustomerUI();
  renderMyAppointments();
  renderNotifications();
  showToast("Kayıt oluşturuldu, giriş yapıldı.","ok");
});

/* giriş */
btnLogin.addEventListener("click",()=>{
  const phone=loginPhone.value.trim();
  const pass =loginPass.value.trim();
  const cust = customers.find(c=>c.phone===phone && c.pass===pass);
  if(!cust){
    showToast("Telefon veya şifre hatalı.","err");
    return;
  }
  if(typeof cust.points!=="number" || isNaN(cust.points)) cust.points=0;
  currentCustomer=cust;
  localStorage.setItem(LS_CURRENT_CUST,cust.phone);
  refreshCustomerUI();
  renderMyAppointments();
  renderNotifications();
  showToast("Giriş başarılı.","ok");
});

/* müşteri çıkış */
btnCustomerLogout.addEventListener("click",()=>{
  currentCustomer=null;
  localStorage.removeItem(LS_CURRENT_CUST);
  refreshCustomerUI();
  showToast("Müşteri çıkış yapıldı.","ok");
});

/* admin modal */
btnAdminOpen.addEventListener("click",()=>{adminModalEl.style.display="flex";});
adminModalClose.addEventListener("click",()=>{adminModalEl.style.display="none";});

/* admin giriş */
btnAdminLogin.addEventListener("click",()=>{
  const phone=adminPhoneInput.value.trim();
  const pass =adminPassInput.value.trim();
  if(phone===ADMIN_PHONE && pass===ADMIN_PASS){
    isAdminLoggedIn=true;
    localStorage.setItem(LS_ADMIN,"1");
    adminLoginArea.style.display="none";
    adminPanelArea.style.display="block";
    adminBtnLabel.textContent="Admin Paneli";
    showToast("Admin giriş başarılı.","ok");
  }else{
    showToast("Admin bilgileri hatalı.","err");
  }
});

/* admin çıkış */
btnAdminLogout.addEventListener("click",()=>{
  isAdminLoggedIn=false;
  localStorage.removeItem(LS_ADMIN);
  adminLoginArea.style.display="block";
  adminPanelArea.style.display="none";
  adminBtnLabel.textContent="Admin Girişi";
  showToast("Admin çıkış yapıldı.","ok");
});

/* admin sekmeler */
adminTabBtns.forEach(btn=>{
  btn.addEventListener("click",()=>{
    const id=btn.dataset.adminSection;
    adminTabBtns.forEach(b=>b.classList.toggle("active",b===btn));
    adminSections.forEach(sec=>sec.classList.toggle("active",sec.id===id));
  });
});

/* hizmet ekle */
btnAddService.addEventListener("click",()=>{
  const name=newServiceNameEl.value.trim();
  const price=Number(newServicePriceEl.value||0);
  const dur=Number(newServiceDurationEl.value||0);
  if(!name || !dur){
    showToast("Hizmet adı ve süre gir.","err");
    return;
  }
  const svc={id:"svc_"+Date.now(),name,price,duration:dur};
  services.push(svc);
  saveServices();
  newServiceNameEl.value="";
  newServicePriceEl.value="";
  newServiceDurationEl.value="";
  renderServices();
  showToast("Hizmet eklendi.","ok");
});

/* berber ekle */
btnAddBarber.addEventListener("click",()=>{
  const name=newBarberNameEl.value.trim();
  if(!name){
    showToast("Berber adı gir.","err");
    return;
  }
  const brb={id:"brb_"+Date.now(),name,photo:null};
  barbers.push(brb);
  saveBarbers();
  schedules[brb.id]=createDefaultSchedule();
  saveSchedules();
  newBarberNameEl.value="";
  newBarberPhotoFileEl.value="";
  renderBarbers();
  setSelectedBarber(brb.id);
  showToast("Berber eklendi. Çalışma saatleri tamamen bağımsız.","ok");
});

/* tüm yerel veriyi sıfırla */
btnResetData.addEventListener("click",()=>{
  localStorage.removeItem(LS_SERVICES);
  localStorage.removeItem(LS_BARBERS);
  localStorage.removeItem(LS_SCHEDULES);
  localStorage.removeItem(LS_CUSTOMERS);
  localStorage.removeItem(LS_CLOSED);
  localStorage.removeItem(LS_CURRENT_CUST);
  localStorage.removeItem(LS_ADMIN);
  showToast("Yerel veriler sıfırlandı. Sayfa yenilenecek.","ok");
  setTimeout(()=>location.reload(),800);
});

/* admin filtreler */
adminDateFilter.addEventListener("change",renderAdminAppointments);
adminBarberFilter.addEventListener("change",renderAdminAppointments);

/* kapalı gün ekle */
btnAddClosedDate.addEventListener("click",()=>{
  const d=closedDateInput.value;
  if(!d) return;
  if(!closedDates.includes(d)){
    closedDates.push(d);
    saveClosedDates();
    renderClosedDateList();
    showToast("Kapalı gün eklendi.","ok");
  }
});

/* PDF */
btnPrintReports.addEventListener("click",()=>{
  adminTabBtns.forEach(b=>b.classList.remove("active"));
  document.querySelector('[data-admin-section="adminSectionRapor"]').classList.add("active");
  adminSections.forEach(sec=>sec.classList.toggle("active",sec.id==="adminSectionRapor"));
  window.print();
});
btnPrintAppointments.addEventListener("click",()=>{
  adminTabBtns.forEach(b=>b.classList.remove("active"));
  document.querySelector('[data-admin-section="adminSectionRandevu"]').classList.add("active");
  adminSections.forEach(sec=>sec.classList.toggle("active",sec.id==="adminSectionRandevu"));
  window.print();
});

/* Gün sonu özet metni – clipboard */
btnCopyTodaySummary.addEventListener("click",()=>{
  const tStr = todayStr();
  const todays = appointments.filter(a=>{
    const status = a.status || "active";
    return a.date===tStr && status!=="noshow";
  });
  let todayRevenue=0; todays.forEach(a=>todayRevenue+=Number(a.price||0));

  const sCounts={};
  const bCounts={};
  todays.forEach(a=>{
    if(a.serviceName) sCounts[a.serviceName]=(sCounts[a.serviceName]||0)+1;
    if(a.barberName)  bCounts[a.barberName]=(bCounts[a.barberName]||0)+1;
  });

  let topSvcName="-", topSvcCount=0;
  Object.keys(sCounts).forEach(name=>{
    if(sCounts[name]>topSvcCount){topSvcCount=sCounts[name];topSvcName=name;}
  });
  let topBarberName="-", topBarberCount=0;
  Object.keys(bCounts).forEach(name=>{
    if(bCounts[name]>topBarberCount){topBarberCount=bCounts[name];topBarberName=name;}
  });

  const text =
`Bugün Ahmet Tekeli Erkek Kuaförü'nde toplam ${todays.length} randevu tamamlandı.
Toplam ciro: ${todayRevenue} ₺.
En çok tercih edilen işlem: ${topSvcName}${topSvcName!=="-"?" ("+topSvcCount+" adet)":""}.
En çok randevu alan berber: ${topBarberName}${topBarberName!=="-"?" ("+topBarberCount+" adet)":""}.

💈 Online randevu için profilimizdeki linke tıkla.`;

  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>{
      showToast("Bugün özeti panoya kopyalandı.","ok");
    }).catch(()=>{
      showToast("Kopyalama desteklenmiyor, metni elle seç.","err");
      alert(text);
    });
  }else{
    showToast("Kopyalama desteklenmiyor, metni elle seç.","err");
    alert(text);
  }
});

/* çalışma saati modal */
scheduleModalClose.addEventListener("click",()=>{scheduleModal.style.display="none";});
btnSaveSchedule.addEventListener("click",()=>{
  if(!currentScheduleBarberId)return;
  const sch=[];
  for(let i=0;i<7;i++){
    const dayRow = scheduleWrapper.querySelector(`[data-day-index="${i}"]`);
    const active = dayRow.querySelector("input[type=checkbox]").checked;
    const intervalEls = dayRow.querySelectorAll(".schedule-interval");
    const intervals=[];
    intervalEls.forEach(row=>{
      const s=row.querySelector("select[data-role=start]").value;
      const e=row.querySelector("select[data-role=end]").value;
      if(s && e && s<e) intervals.push({start:s,end:e});
    });
    sch.push({active,intervals});
  }
  schedules[currentScheduleBarberId]=sch;
  saveSchedules();
  scheduleModal.style.display="none";
  showToast("Çalışma saatleri kaydedildi.","ok");
  setSelectedBarber(currentScheduleBarberId);
});

/* MERKEZİ SİLME & NO-SHOW */
async function deleteAppointmentById(id,source="admin"){
  const app = appointments.find(a=>a.id===id) || null;
  appointments = appointments.filter(a=>a.id!==id);
  await deleteAppointmentFromFirestore(id);
  renderAll();
  if(source==="customer" && app && currentCustomer && app.phone===currentCustomer.phone){
    pushCustomerNotification("deleted",`${app.date} ${app.time} randevunuz iptal edildi.`);
  }
  showToast(source==="customer"?"Randevun iptal edildi.":"Randevu silindi.","ok");
}

/* WINDOW GLOBAL */
window.deleteService = function(id){
  services=services.filter(s=>s.id!==id);
  saveServices();
  renderServices();
  showToast("Hizmet silindi.","ok");
};
window.deleteBarber = function(id){
  barbers = barbers.filter(b=>b.id!==id);
  delete schedules[id];
  saveBarbers();
  saveSchedules();
  if(selectedBarberId===id){
    selectedBarberId = barbers[0]?.id || null;
  }
  renderBarbers();
  renderSlots();
  showToast("Berber silindi.","ok");
};
window.deleteClosedDate = function(date){
  closedDates=closedDates.filter(d=>d!==date);
  saveClosedDates();
  renderClosedDateList();
  showToast("Kapalı gün silindi.","ok");
};
window.sendWp = function(phone,msg){
  const url=`https://wa.me/90${phone.replace(/\D/g,"").slice(-10)}?text=${msg}`;
  window.open(url,"_blank");
};
window.deleteAppointment = async function(id){
  await deleteAppointmentById(id,"admin");
};
window.cancelMyAppointment = async function(id){
  await deleteAppointmentById(id,"customer");
};
window.openSchedule = function(id){
  currentScheduleBarberId=id;
  const brb = barbers.find(b=>b.id===id);
  if(!brb)return;
  scheduleModalTitle.textContent=`${brb.name} • Çalışma Saatleri`;

  const sch = Array.isArray(schedules[id]) ? schedules[id] : createDefaultSchedule();
  scheduleWrapper.innerHTML="";
  for(let i=0;i<7;i++){
    const dayData = sch[i] || {active:(i<6),intervals:[{start:"09:00",end:"19:00"}]};
    const intervalsHtml = dayData.intervals.map(it=>`
      <div class="schedule-interval">
        <select data-role="start">
          ${SLOT_TIMES.map(t=>`<option value="${t}" ${t===it.start?"selected":""}>${t}</option>`).join("")}
        </select>
        <select data-role="end">
          ${SLOT_TIMES.map(t=>`<option value="${t}" ${t===it.end?"selected":""}>${t}</option>`).join("")}
        </select>
        <button type="button" onclick="this.closest('.schedule-interval').remove()">Sil</button>
      </div>
    `).join("");
    const rowHtml=`
      <div class="schedule-row" data-day-index="${i}">
        <div class="schedule-row-head">
          <div class="schedule-day-name">${DAY_NAMES[i]}</div>
          <label class="day-active-label">
            <input type="checkbox" ${dayData.active?"checked":""}>
            Aktif
          </label>
        </div>
        <div class="schedule-intervals">
          ${intervalsHtml || ""}
        </div>
        <button class="btn-add-interval" type="button">Aralık Ekle</button>
      </div>
    `;
    scheduleWrapper.insertAdjacentHTML("beforeend",rowHtml);
  }
  Array.from(scheduleWrapper.querySelectorAll(".btn-add-interval")).forEach(btn=>{
    btn.addEventListener("click",()=>{
      const parent=btn.closest(".schedule-row");
      const container=parent.querySelector(".schedule-intervals");
      const html=`
        <div class="schedule-interval">
          <select data-role="start">
            ${SLOT_TIMES.map(t=>`<option value="${t}">${t}</option>`).join("")}
          </select>
          <select data-role="end">
            ${SLOT_TIMES.map(t=>`<option value="${t}">${t}</option>`).join("")}
          </select>
          <button type="button" onclick="this.closest('.schedule-interval').remove()">Sil</button>
        </div>
      `;
      container.insertAdjacentHTML("beforeend",html);
    });
  });
  scheduleModal.style.display="flex";
};
window.markNoShow = async function(id){
  const app = appointments.find(a=>a.id===id);
  if(!app) return;
  app.status = "noshow";
  await saveAppointmentToFirestore(app);
  renderAll();
  showToast("Randevu 'gelmedi' olarak işaretlendi.","ok");
};

/* INIT */
function init(){
  loadLocalData();
  selectedBarberId = barbers[0]?.id || null;
  dateInput.value = todayStr();
  if(isAdminLoggedIn){
    adminLoginArea.style.display="none";
    adminPanelArea.style.display="block";
    adminBtnLabel.textContent="Admin Paneli";
  }
  refreshCustomerUI();
  renderAll();
  loadAppointmentsFromFirestore();

  // PWA service worker kaydı
  if("serviceWorker" in navigator){
    window.addEventListener("load",()=>{
      navigator.serviceWorker.register("sw.js").catch(err=>{
        console.log("SW kayıt hatası:",err);
      });
    });
  }
}
init();
</script>
</body>
</html>
