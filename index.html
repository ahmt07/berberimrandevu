<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Ahmet Tekeli Kuaför • Online Randevu</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f5f7;
  --card:#ffffff;
  --ink:#111827;
  --muted:#6b7280;
  --line:#e5e7eb;
  --gold:#d4af37;
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{
  background:var(--bg);
  color:var(--ink);
  font:15px/1.6 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
}

/* HEADER */
header{
  background:var(--card);
  padding:12px 16px;
  border-bottom:1px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}
.logo{
  font-size:20px;
  font-weight:700;
  letter-spacing:.12em;
  text-transform:uppercase;
  color:var(--gold);
}
#userStatus{
  font-size:12px;
  color:var(--muted);
}

/* ANA KART */
.card{
  background:var(--card);
  padding:18px;
  border-radius:12px;
  margin:16px;
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}

/* BUTON */
.btn{
  padding:10px 16px;
  background:var(--gold);
  color:#fff;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  width:100%;
  margin-top:10px;
  text-align:center;
}
.btn:hover{opacity:.9}
.btn-outline{
  background:#fff;
  color:var(--ink);
  border:1px solid var(--line);
}

/* INPUT / SELECT */
label{
  display:block;
  margin-top:10px;
  font-size:13px;
  font-weight:600;
}
input,select{
  width:100%;
  padding:9px 10px;
  border:1px solid var(--line);
  border-radius:8px;
  margin-top:4px;
  background:#fff;
  font-size:14px;
}
input::placeholder{color:#9ca3af}

/* LIST */
.list{
  list-style:none;
}
.list li{
  padding:12px;
  border:1px solid var(--line);
  border-radius:8px;
  margin-top:8px;
  background:#fff;
  font-size:13px;
}
.list li .meta{
  font-size:12px;
  color:var(--muted);
  margin-top:2px;
}
.list li .actions{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.list li .actions button{
  flex:1;
  padding:6px 8px;
  border-radius:6px;
  border:none;
  font-size:12px;
  cursor:pointer;
}
.btn-small-del{
  background:#fee2e2;
  color:#b91c1c;
}
.btn-small-edit{
  background:#dcfce7;
  color:#166534;
}

/* Modal */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:50;
}
.modal-box{
  width:92%;
  max-width:420px;
  background:white;
  padding:18px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.3);
}
.modal-box h3{
  margin-bottom:8px;
  font-size:18px;
}

/* TOAST */
#toast{
  position:fixed;
  left:50%;
  top:12px;
  transform:translateX(-50%);
  background:#111827;
  color:#f9fafb;
  padding:7px 14px;
  border-radius:999px;
  font-size:13px;
  display:none;
  z-index:60;
}
</style>
</head>
<body>

<header>
  <div class="logo">AHMET TEKELİ</div>
  <div id="userStatus"></div>
</header>

<!-- GİRİŞ KARTI -->
<div class="card" id="entryCard">
  <h2>Giriş Paneli</h2>
  <p style="font-size:13px;color:var(--muted);margin-top:6px;">
    Admin olarak tüm randevuları yönetebilir, müşteri olarak kendi randevularını görebilirsin.
  </p>
  <button class="btn" onclick="openAdminLogin()">Admin Girişi</button>
  <button class="btn btn-outline" onclick="openCustomerLogin()">Müşteri Girişi</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" style="display:none;">
  <div class="card">
    <h2>Admin Paneli</h2>
    <button class="btn" onclick="showAddBarber()">Berber Ekle</button>
    <button class="btn" onclick="showAddService()">Hizmet Ekle</button>
    <button class="btn" onclick="showAddAppointment()">Randevu Ekle</button>
    <button class="btn btn-outline" onclick="loadAppointments()">Tüm Randevuları Yenile</button>
  </div>

  <div class="card">
    <h3>Randevular</h3>
    <ul id="adminAppointments" class="list"></ul>
  </div>

  <div class="card">
    <h3>Berberler</h3>
    <ul id="adminBarbers" class="list"></ul>
  </div>

  <div class="card">
    <h3>Hizmetler</h3>
    <ul id="adminServices" class="list"></ul>
  </div>
</div>

<!-- MÜŞTERİ PANEL -->
<div id="customerPanel" style="display:none;">
  <div class="card">
    <h2>Müşteri Paneli</h2>
    <p id="customerInfo" style="font-size:13px;color:var(--muted);margin-bottom:6px;"></p>
    <button class="btn" onclick="showAddAppointment()">Yeni Randevu Al</button>
    <button class="btn btn-outline" onclick="loadCustomerAppointments()">Randevularımı Göster</button>
  </div>

  <div class="card">
    <h3>Randevularım</h3>
    <ul id="customerAppointments" class="list"></ul>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>
    <div id="modalContent"></div>
    <button class="btn btn-outline" style="margin-top:12px;" onclick="closeModal()">Kapat</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- FIREBASE ve JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* === FIREBASE CONFIG (randevularim-92ac2) === */
const firebaseConfig = {
  apiKey: "AIzaSyD3S0XgKgNJLCJr3xQ-ASgr1gHz9MCou-4",
  authDomain: "randevularim-92ac2.firebaseapp.com",
  projectId: "randevularim-92ac2",
  storageBucket: "randevularim-92ac2.firebasestorage.app",
  messagingSenderId: "1092355095676",
  appId: "1:1092355095676:web:085921b2dff9d607b7ddf9"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

/* === SABİT === */
const ADMIN_PHONE = "05356749243";
const ADMIN_PASS  = "ahmetgs";

/* === STATE === */
let adminLogged = localStorage.getItem("atekeli_admin_logged") === "1";
let currentCustomerPhone = localStorage.getItem("atekeli_customer_phone") || null;
let currentCustomerName  = localStorage.getItem("atekeli_customer_name")  || "";

let barbers = [];
let services = [];
let appointments = [];

/* === DOM === */
const entryCard          = document.getElementById("entryCard");
const adminPanel         = document.getElementById("adminPanel");
const customerPanel      = document.getElementById("customerPanel");
const userStatusEl       = document.getElementById("userStatus");
const customerInfoEl     = document.getElementById("customerInfo");
const adminAppointmentsEl   = document.getElementById("adminAppointments");
const adminBarbersEl        = document.getElementById("adminBarbers");
const adminServicesEl       = document.getElementById("adminServices");
const customerAppointmentsEl = document.getElementById("customerAppointments");
const modalEl           = document.getElementById("modal");
const modalTitleEl      = document.getElementById("modalTitle");
const modalContentEl    = document.getElementById("modalContent");
const toastEl           = document.getElementById("toast");

/* === YARDIMCI === */
function showToast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  setTimeout(()=>toastEl.style.display="none",2300);
}

function openModal(title, html){
  modalTitleEl.textContent = title;
  modalContentEl.innerHTML = html;
  modalEl.style.display = "flex";
}
function closeModal(){
  modalEl.style.display = "none";
}

/* === PANEL GÖRÜNÜMÜ === */
function updateHeader(){
  if(adminLogged){
    userStatusEl.textContent = "Admin • " + ADMIN_PHONE;
  }else if(currentCustomerPhone){
    userStatusEl.textContent = "Müşteri • " + currentCustomerPhone;
  }else{
    userStatusEl.textContent = "";
  }
}

function refreshVisiblePanels(){
  if(adminLogged){
    entryCard.style.display = "none";
    adminPanel.style.display = "block";
    customerPanel.style.display = "none";
  }else if(currentCustomerPhone){
    entryCard.style.display = "none";
    adminPanel.style.display = "none";
    customerPanel.style.display = "block";
    customerInfoEl.textContent = currentCustomerName + " (" + currentCustomerPhone + ")";
  }else{
    entryCard.style.display = "block";
    adminPanel.style.display = "none";
    customerPanel.style.display = "none";
  }
  updateHeader();
}

/* === BARBER & SERVICE LOAD === */
async function loadBarbers(){
  const snap = await getDocs(collection(db,"barbers"));
  barbers = [];
  snap.forEach(d=>{
    const data = d.data();
    barbers.push({ id:d.id, name:data.name });
  });
  renderBarbers();
}
async function loadServices(){
  const snap = await getDocs(collection(db,"services"));
  services = [];
  snap.forEach(d=>{
    const data = d.data();
    services.push({
      id:d.id,
      name:data.name,
      price:data.price,
      duration:data.duration
    });
  });
  renderServices();
}

/* === RENDER BERBERLER === */
function renderBarbers(){
  adminBarbersEl.innerHTML = "";
  if(!barbers.length){
    adminBarbersEl.innerHTML = "<li>Henüz berber eklenmedi.</li>";
    return;
  }
  barbers.forEach(b=>{
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${b.name}</strong>
      <div class="actions">
        <button class="btn-small-del">Sil</button>
      </div>
    `;
    li.querySelector(".btn-small-del").onclick = async ()=>{
      if(!confirm(`${b.name} silinsin mi?`)) return;
      await deleteDoc(doc(db,"barbers",b.id));
      showToast("Berber silindi.");
      await loadBarbers();
    };
    adminBarbersEl.appendChild(li);
  });
}

/* === RENDER HİZMETLER === */
function renderServices(){
  adminServicesEl.innerHTML = "";
  if(!services.length){
    adminServicesEl.innerHTML = "<li>Henüz hizmet eklenmedi.</li>";
    return;
  }
  services.forEach(s=>{
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${s.name}</strong>
      <div class="meta">${s.price}₺ • ${s.duration} dk</div>
      <div class="actions">
        <button class="btn-small-del">Sil</button>
      </div>
    `;
    li.querySelector(".btn-small-del").onclick = async ()=>{
      if(!confirm(`${s.name} silinsin mi?`)) return;
      await deleteDoc(doc(db,"services",s.id));
      showToast("Hizmet silindi.");
      await loadServices();
    };
    adminServicesEl.appendChild(li);
  });
}

/* === RANDEVU LOAD & RENDER === */
async function loadAppointments(){
  const snap = await getDocs(collection(db,"appointments"));
  appointments = [];
  snap.forEach(d=>{
    const data = d.data();
    appointments.push({
      id:d.id,
      ...data
    });
  });
  renderAdminAppointments();
  renderCustomerAppointments();
}

function renderAdminAppointments(){
  adminAppointmentsEl.innerHTML = "";
  if(!adminLogged){
    adminAppointmentsEl.innerHTML = "<li>Admin girişi gerekli.</li>";
    return;
  }
  if(!appointments.length){
    adminAppointmentsEl.innerHTML = "<li>Henüz randevu yok.</li>";
    return;
  }
  // Tarihe göre sırala
  appointments.sort((a,b)=>{
    const ka = (a.date||"") + " " + (a.time||"");
    const kb = (b.date||"") + " " + (b.time||"");
    return ka.localeCompare(kb);
  });
  appointments.forEach(a=>{
    const li = document.createElement("li");
    const barberName  = a.barberName  || "Berber";
    const serviceName = a.serviceName || "Hizmet";
    const priceText   = a.price ? ` • ${a.price}₺` : "";
    li.innerHTML = `
      <strong>${a.date} • ${a.time}</strong>
      <div class="meta">${barberName} • ${serviceName}${priceText}</div>
      <div class="meta">${a.customerName} (${a.customerPhone})</div>
      <div class="actions">
        <button class="btn-small-edit">Düzenle</button>
        <button class="btn-small-del">Sil</button>
      </div>
    `;
    li.querySelector(".btn-small-del").onclick = async ()=>{
      if(!confirm("Bu randevu silinsin mi?")) return;
      await deleteDoc(doc(db,"appointments",a.id));
      showToast("Randevu silindi.");
      await loadAppointments();
    };
    li.querySelector(".btn-small-edit").onclick = ()=>{
      showAddAppointment(a); // düzenleme modunda aç
    };
    adminAppointmentsEl.appendChild(li);
  });
}

function renderCustomerAppointments(){
  customerAppointmentsEl.innerHTML = "";
  if(!currentCustomerPhone){
    customerAppointmentsEl.innerHTML = "<li>Önce müşteri girişi yap.</li>";
    return;
  }
  const mine = appointments.filter(a=>a.customerPhone === currentCustomerPhone);
  if(!mine.length){
    customerAppointmentsEl.innerHTML = "<li>Henüz randevun yok.</li>";
    return;
  }
  mine.sort((a,b)=>{
    const ka = (a.date||"") + " " + (a.time||"");
    const kb = (b.date||"") + " " + (b.time||"");
    return ka.localeCompare(kb);
  });
  mine.forEach(a=>{
    const li = document.createElement("li");
    const barberName  = a.barberName  || "Berber";
    const serviceName = a.serviceName || "Hizmet";
    const priceText   = a.price ? ` • ${a.price}₺` : "";
    li.innerHTML = `
      <strong>${a.date} • ${a.time}</strong>
      <div class="meta">${barberName} • ${serviceName}${priceText}</div>
      <div class="meta">${a.customerName} (${a.customerPhone})</div>
    `;
    customerAppointmentsEl.appendChild(li);
  });
}

/* === GİRİŞ İŞLEMLERİ === */
function openAdminLogin(){
  openModal("Admin Girişi", `
    <label>Telefon</label>
    <input id="adminPhoneInput" placeholder="Admin telefon">
    <label>Şifre</label>
    <input id="adminPassInput" type="password" placeholder="Şifre">
    <button class="btn" id="adminLoginBtn" style="margin-top:12px;">Giriş Yap</button>
  `);
  document.getElementById("adminLoginBtn").onclick = async ()=>{
    const phone = document.getElementById("adminPhoneInput").value.trim();
    const pass  = document.getElementById("adminPassInput").value;
    if(phone === ADMIN_PHONE && pass === ADMIN_PASS){
      adminLogged = true;
      localStorage.setItem("atekeli_admin_logged","1");
      closeModal();
      refreshVisiblePanels();
      await loadBarbers();
      await loadServices();
      await loadAppointments();
      showToast("Admin girişi başarılı.");
    }else{
      showToast("Admin bilgileri hatalı.");
    }
  };
}

function openCustomerLogin(){
  openModal("Müşteri Girişi", `
    <label>Ad Soyad</label>
    <input id="custNameInput" placeholder="Adınız">
    <label>Telefon</label>
    <input id="custPhoneInput" placeholder="05xxxxxxxxx">
    <button class="btn" id="custLoginBtn" style="margin-top:12px;">Giriş / Kayıt</button>
  `);
  document.getElementById("custLoginBtn").onclick = async ()=>{
    const name  = document.getElementById("custNameInput").value.trim();
    const phone = document.getElementById("custPhoneInput").value.trim();
    if(!name || !phone){
      showToast("Ad ve telefonu doldur.");
      return;
    }
    currentCustomerName  = name;
    currentCustomerPhone = phone;
    localStorage.setItem("atekeli_customer_name", name);
    localStorage.setItem("atekeli_customer_phone", phone);
    adminLogged = false;
    localStorage.removeItem("atekeli_admin_logged");
    closeModal();
    refreshVisiblePanels();
    await loadAppointments();
    showToast("Müşteri girişi yapıldı.");
  };
}

/* === BERBER & HİZMET EKLE === */
function showAddBarber(){
  if(!adminLogged){
    showToast("Bu işlem için admin girişi gerekli.");
    return;
  }
  openModal("Berber Ekle", `
    <label>Berber Adı</label>
    <input id="barberNameInput" placeholder="Örn: Ahmet Tekeli">
    <button class="btn" id="saveBarberBtn" style="margin-top:12px;">Kaydet</button>
  `);
  document.getElementById("saveBarberBtn").onclick = async ()=>{
    const name = document.getElementById("barberNameInput").value.trim();
    if(!name){
      showToast("Berber adını yaz.");
      return;
    }
    await addDoc(collection(db,"barbers"),{ name });
    closeModal();
    await loadBarbers();
    showToast("Berber eklendi.");
  };
}

function showAddService(){
  if(!adminLogged){
    showToast("Bu işlem için admin girişi gerekli.");
    return;
  }
  openModal("Hizmet Ekle", `
    <label>Hizmet Adı</label>
    <input id="serviceNameInput" placeholder="Örn: Saç Kesim">
    <label>Fiyat (₺)</label>
    <input id="servicePriceInput" type="number" min="0" step="10" placeholder="Örn: 400">
    <label>Süre (dakika)</label>
    <input id="serviceDurationInput" type="number" min="15" step="15" placeholder="Örn: 30">
    <button class="btn" id="saveServiceBtn" style="margin-top:12px;">Kaydet</button>
  `);
  document.getElementById("saveServiceBtn").onclick = async ()=>{
    const name     = document.getElementById("serviceNameInput").value.trim();
    const priceStr = document.getElementById("servicePriceInput").value;
    const durStr   = document.getElementById("serviceDurationInput").value;
    const price    = Number(priceStr);
    const duration = Number(durStr);
    if(!name || !priceStr || !durStr || isNaN(price) || isNaN(duration)){
      showToast("Tüm alanları doldur.");
      return;
    }
    await addDoc(collection(db,"services"),{ name, price, duration });
    closeModal();
    await loadServices();
    showToast("Hizmet eklendi.");
  };
}

/* === RANDEVU EKLE / DÜZENLE === */
async function showAddAppointment(existing = null){
  if(!adminLogged && !currentCustomerPhone){
    showToast("Önce admin veya müşteri girişi yap.");
    return;
  }
  await loadBarbers();
  await loadServices();

  const barberOptions = barbers.map(b=>{
    const sel = existing && (existing.barberId === b.id) ? "selected" : "";
    return `<option value="${b.id}" ${sel}>${b.name}</option>`;
  }).join("");

  const serviceOptions = services.map(s=>{
    const sel = existing && (existing.serviceId === s.id) ? "selected" : "";
    return `<option value="${s.id}" ${sel}>${s.name} (${s.price}₺)</option>`;
  }).join("");

  const title = existing ? "Randevu Düzenle" : "Yeni Randevu";
  const defName  = existing ? (existing.customerName  || "") : currentCustomerName;
  const defPhone = existing ? (existing.customerPhone || "") : currentCustomerPhone || "";
  const defDate  = existing ? (existing.date  || "") : "";
  const defTime  = existing ? (existing.time  || "") : "";

  openModal(title, `
    <label>Ad Soyad</label>
    <input id="appNameInput" placeholder="Ad Soyad" value="${defName || ""}">
    <label>Telefon</label>
    <input id="appPhoneInput" placeholder="05xxxxxxxxx" value="${defPhone || ""}">
    <label>Berber</label>
    <select id="appBarberSelect">
      <option value="">Seçiniz</option>
      ${barberOptions}
    </select>
    <label>Hizmet</label>
    <select id="appServiceSelect">
      <option value="">Seçiniz</option>
      ${serviceOptions}
    </select>
    <label>Tarih</label>
    <input id="appDateInput" type="date" value="${defDate}">
    <label>Saat</label>
    <input id="appTimeInput" type="time" value="${defTime}">
    <button class="btn" id="saveAppBtn" style="margin-top:12px;">Kaydet</button>
  `);

  document.getElementById("saveAppBtn").onclick = async ()=>{
    const name   = document.getElementById("appNameInput").value.trim();
    const phone  = document.getElementById("appPhoneInput").value.trim();
    const barberId = document.getElementById("appBarberSelect").value;
    const serviceId= document.getElementById("appServiceSelect").value;
    const date   = document.getElementById("appDateInput").value;
    const time   = document.getElementById("appTimeInput").value;

    if(!name || !phone || !barberId || !serviceId || !date || !time){
      showToast("Tüm alanları doldur.");
      return;
    }

    const barberObj  = barbers.find(b=>b.id===barberId);
    const serviceObj = services.find(s=>s.id===serviceId);
    const data = {
      customerName:name,
      customerPhone:phone,
      barberId,
      barberName:barberObj ? barberObj.name : "",
      serviceId,
      serviceName:serviceObj ? serviceObj.name : "",
      price:serviceObj ? serviceObj.price : null,
      date,
      time
    };

    if(existing && existing.id){
      await updateDoc(doc(db,"appointments",existing.id), data);
      showToast("Randevu güncellendi.");
    }else{
      const ref = await addDoc(collection(db,"appointments"), data);
      data.id = ref.id;
      showToast("Randevu oluşturuldu.");
    }

    closeModal();
    await loadAppointments();
  };
}

/* === MÜŞTERİ BUTONU === */
async function loadCustomerAppointments(){
  await loadAppointments();
}

/* === INIT === */
async function init(){
  refreshVisiblePanels();
  await loadBarbers();
  await loadServices();
  if(adminLogged || currentCustomerPhone){
    await loadAppointments();
  }
}
init();

/* === HTML'den erişim için window'a bağla === */
window.openAdminLogin       = openAdminLogin;
window.openCustomerLogin    = openCustomerLogin;
window.showAddBarber        = showAddBarber;
window.showAddService       = showAddService;
window.showAddAppointment   = showAddAppointment;
window.closeModal           = closeModal;
window.loadAppointments     = loadAppointments;
window.loadCustomerAppointments = loadCustomerAppointments;

</script>
</body>
</html>
