<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Ahmet Tekeli Kuaf√∂r ‚Ä¢ Online Randevu</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#111827">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#e5e7eb;
  --ink:#111827;
  --muted:#6b7280;
  --brand:#d4af37;
  --danger:#ef4444;
  --ok:#10b981;
  --info:#60a5fa;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{font:15px/1.5 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink);}
.bg{position:fixed;inset:0;z-index:-2;background:url("arka-plan.jpg") center/cover no-repeat,radial-gradient(circle at 10% 0%,rgba(148,163,184,.4),transparent 22%);filter:blur(10px);}
.bg-overlay{position:fixed;inset:0;z-index:-1;background:linear-gradient(to bottom,rgba(255,255,255,.82),rgba(209,213,219,.96)),radial-gradient(circle at top,rgba(255,255,255,.72),transparent 55%);}
body{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:18px 10px 28px;animation:bodyFade .7s ease-out;}
@keyframes bodyFade{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
.wrap{width:100%;max-width:420px;position:relative;border-radius:32px;padding:18px 16px 22px;background:linear-gradient(145deg,rgba(243,244,246,.92),rgba(229,231,235,.97));box-shadow:0 22px 70px rgba(15,23,42,.4),0 0 0 1px rgba(148,163,184,.35);backdrop-filter:blur(22px) saturate(145%);}
.logo-wrap{display:flex;justify-content:center;margin-bottom:8px;}
.logo-circle{width:92px;height:92px;border-radius:999px;background:url("logo.png") center/100% 100% no-repeat;position:relative;box-shadow:0 20px 46px rgba(0,0,0,.45);}
.logo-circle::before{content:"";position:absolute;inset:-4px;border-radius:999px;background:conic-gradient(from 230deg,var(--brand),#fbbf24,#fef3c7,var(--brand));opacity:.9;z-index:-1;filter:blur(1.2px);}
.logo-circle::after{content:"";position:absolute;inset:4px;border-radius:999px;background:radial-gradient(circle at 10% 0%,rgba(255,255,255,.9),transparent 55%);mix-blend-mode:screen;}
.top-actions{position:absolute;top:12px;right:12px;display:flex;flex-direction:column;gap:6px;}
.btn-top{border-radius:999px;padding:7px 13px;border:1px solid rgba(209,213,219,.9);cursor:pointer;font-size:12px;font-weight:600;background:rgba(255,255,255,.96);color:#111827;box-shadow:0 10px 26px rgba(15,23,42,.25);backdrop-filter:blur(18px);position:relative;overflow:hidden;}
.btn-top span{opacity:.95}
.btn-top::after{content:"";position:absolute;inset:-40%;background:linear-gradient(120deg,transparent,rgba(255,255,255,.6),transparent);transform:translateX(-120%);transition:transform .7s ease-out;}
.btn-top:hover::after{transform:translateX(120%);}
.card{border-radius:26px;padding:16px 14px 18px;border:1px solid rgba(209,213,219,.95);background:radial-gradient(circle at 0 0,rgba(255,255,255,1),rgba(243,244,246,.98));box-shadow:0 20px 50px rgba(15,23,42,.32),0 0 0 1px rgba(148,163,184,.25);color:var(--ink);}
.card-header{text-align:center;margin-bottom:14px;}
.brand-title{font-size:24px;font-weight:800;letter-spacing:.14em;text-transform:uppercase;}
.brand-sub{margin-top:2px;font-size:11px;letter-spacing:.25em;text-transform:uppercase;color:var(--muted);}
.rating{margin-top:8px;display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:11px;background:rgba(255,255,255,.98);border:1px solid rgba(209,213,219,.95);box-shadow:0 10px 24px rgba(15,23,42,.2);}
.rating .star{width:12px;height:12px;clip-path:polygon(50% 0%,63% 38%,100% 38%,69% 59%,82% 100%,50% 76%,18% 100%,31% 59%,0 38%,37% 38%);background:var(--brand);}
.section-title{font-size:12px;font-weight:600;margin:8px 0 4px;color:#111827;}
.input,.select,.date-input{width:100%;border-radius:13px;padding:8px 11px;border:1px solid rgba(209,213,219,.95);background:linear-gradient(135deg,rgba(255,255,255,.99),rgba(249,250,251,.99));color:#0f172a;font-size:13px;}
.input::placeholder{color:#9ca3af}
.date-input{padding:6px 9px;font-size:10px;}
.row{display:flex;flex-wrap:wrap;gap:6px;}
.row>*{flex:1;min-width:0;}
.barber-choices{display:flex;flex-wrap:wrap;gap:6px;}
.barber-chip{display:flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;background:linear-gradient(135deg,rgba(243,244,246,1),rgba(229,231,235,1));border:1px solid rgba(209,213,219,1);cursor:pointer;font-size:11px;box-shadow:0 6px 14px rgba(15,23,42,.12);}
.barber-chip.selected{background:linear-gradient(135deg,#fde68a,var(--brand));color:#111827;border-color:transparent;}
.barber-avatar{width:24px;height:24px;border-radius:999px;overflow:hidden;flex-shrink:0;background:rgba(31,41,55,.08);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;text-transform:uppercase;}
.barber-avatar img{width:100%;height:100%;object-fit:cover;}
.suggest-wrap{margin-top:6px;display:flex;flex-wrap:wrap;gap:7px;}
.suggest-btn{border-radius:999px;padding:6px 10px;border:1px solid rgba(209,213,219,1);background:rgba(255,255,255,.98);font-size:11px;font-weight:800;cursor:pointer;box-shadow:0 10px 22px rgba(15,23,42,.12);}
.suggest-btn:hover{transform:translateY(-1px);}
.suggest-btn:active{transform:translateY(0);}
.slot-grid{margin-top:6px;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:7px;}
.slot{border-radius:12px;padding:7px 0;border:1px solid rgba(209,213,219,1);background:rgba(255,255,255,.99);color:#111827;font-weight:700;font-size:11px;cursor:pointer;box-shadow:0 10px 22px rgba(15,23,42,.15);}
.slot.selected{background:linear-gradient(135deg,#fde68a,var(--brand));color:#111827;border-color:transparent;}
.slot.disabled{opacity:.28;pointer-events:none;}
.btn-book{width:100%;margin-top:14px;border-radius:999px;padding:11px 18px;border:none;cursor:pointer;font-size:13px;font-weight:900;letter-spacing:.18em;text-transform:uppercase;background:linear-gradient(135deg,#fef3c7,#facc15,var(--brand));color:#111827;box-shadow:0 18px 42px rgba(0,0,0,.22),0 0 0 1px rgba(180,148,60,.55);position:relative;overflow:hidden;}
.btn-book::after{content:"";position:absolute;inset:-60%;background:linear-gradient(120deg,transparent,rgba(255,255,255,.7),transparent);transform:translateX(-130%);transition:transform .8s ease-out;}
.btn-book:hover::after{transform:translateX(130%);}
.helper{margin-top:6px;font-size:11px;color:var(--muted);}
.app-list{list-style:none;margin-top:4px;}
.app-item{display:flex;flex-wrap:wrap;justify-content:space-between;gap:6px;padding:7px 7px;border-radius:13px;border:1px solid rgba(148,163,184,.7);background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.98));font-size:11px;backdrop-filter:blur(14px);color:#e5e7eb;}
.app-main{display:flex;flex-direction:column;gap:2px;}
.app-title{font-weight:800;}
.app-meta{color:#cbd5f5;}
.app-actions{display:flex;gap:5px;align-items:center;flex-wrap:wrap;}
.btn-mini{border-radius:999px;border:none;padding:4px 9px;font-size:10px;cursor:pointer;font-weight:800;}
.btn-mini.edit{background:rgba(59,130,246,.12);color:#93c5fd;border:1px solid rgba(59,130,246,.7);}
.btn-mini.del{background:rgba(239,68,68,.12);color:#ef4444;border:1px solid rgba(248,113,113,.7);}
.btn-mini.cal{background:rgba(250,204,21,.12);color:#facc15;border:1px solid rgba(250,204,21,.7);}
.btn-mini.wp{background:rgba(34,197,94,.12);color:#22c55e;border:1px solid rgba(34,197,94,.7);}
.btn-mini.note{background:rgba(59,130,246,.12);color:#60a5fa;border:1px solid rgba(59,130,246,.7);}
.panel{margin-top:10px;background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.99));border-radius:20px;padding:9px 9px 10px;border:1px solid rgba(148,163,184,.6);backdrop-filter:blur(16px);color:#e5e7eb;}
.modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.82);display:none;align-items:center;justify-content:center;z-index:30;}
.modal{width:100%;max-width:380px;background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.99));border-radius:24px;padding:14px;border:1px solid rgba(148,163,184,.7);box-shadow:0 24px 70px rgba(0,0,0,.9);backdrop-filter:blur(22px);color:#e5e7eb;}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.modal-title{font-size:14px;font-weight:900;}
.modal-close{border:none;background:none;color:#9ca3af;font-size:20px;cursor:pointer;}
.tabs{display:flex;gap:6px;margin-bottom:10px;}
.tab-btn{flex:1;border-radius:999px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,.9);color:#9ca3af;padding:6px 0;font-size:12px;font-weight:800;cursor:pointer;}
.tab-btn.active{background:linear-gradient(135deg,#facc15,var(--brand));color:#111827;border-color:transparent;}
.btn-full{width:100%;margin-top:9px;padding:9px 0;border-radius:999px;border:none;background:linear-gradient(135deg,#fef3c7,#facc15,var(--brand));color:#111827;font-size:13px;font-weight:900;cursor:pointer;box-shadow:0 14px 40px rgba(0,0,0,.85);position:relative;overflow:hidden;}
.btn-full::after{content:"";position:absolute;inset:-60%;background:linear-gradient(120deg,transparent,rgba(255,255,255,.7),transparent);transform:translateX(-130%);transition:transform .8s ease-out;}
.btn-full:hover::after{transform:translateX(130%);}

.admin-summary{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.summary-card{flex:1;min-width:120px;padding:8px 10px;border-radius:16px;background:radial-gradient(circle at top,rgba(15,23,42,.95),rgba(15,23,42,1));border:1px solid rgba(250,204,21,.4);box-shadow:0 14px 40px rgba(0,0,0,.7);backdrop-filter:blur(18px) saturate(160%);display:flex;flex-direction:column;gap:2px;}
.summary-label{font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:#e5e7eb;opacity:.85;}
.summary-value{font-size:17px;font-weight:900;color:#facc15;}
.summary-sub{font-size:11px;color:#cbd5f5;}
.admin-tabs{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:9px;background:linear-gradient(135deg,rgba(15,23,42,.9),rgba(15,23,42,.98));padding:4px;border-radius:999px;border:1px solid rgba(148,163,184,.7);}
.admin-tab{flex:1;border-radius:999px;border:none;background:transparent;color:#9ca3af;padding:5px 0;font-size:11px;font-weight:900;cursor:pointer;}
.admin-tab.active{background:linear-gradient(135deg,#facc15,var(--brand));color:#111827;box-shadow:0 10px 26px rgba(0,0,0,.85);}
.admin-section{display:none;}
.admin-section.active{display:block;}
.admin-filter-row{display:flex;flex-direction:column;gap:8px;margin:6px 0 10px;}
.closed-panel-title{margin-top:10px;font-size:11px;font-weight:800;color:#e5e7eb;}
.closed-date-item{display:flex;justify-content:space-between;align-items:center;padding:4px 6px;border-radius:10px;border:1px solid rgba(148,163,184,.6);margin-top:4px;font-size:11px;color:#e5e7eb;}
.closed-date-item span{color:#cbd5f5;}
.toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);background:radial-gradient(circle at top,rgba(15,23,42,.98),rgba(15,23,42,1));color:#f9fafb;padding:7px 14px 7px 32px;border-radius:999px;font-size:12px;border:1px solid rgba(148,163,184,.9);box-shadow:0 20px 60px rgba(0,0,0,.9);z-index:50;align-items:center;gap:6px;display:none;opacity:0;pointer-events:none;transition:opacity .25s ease-out,transform .25s ease-out;}
.toast-icon{position:absolute;left:10px;font-size:13px;}
.toast.ok{border-color:rgba(16,185,129,.7);}
.toast.err{border-color:rgba(248,113,113,.9);}

.schedule-wrapper{max-height:65vh;overflow:auto;padding-right:4px;}
.schedule-row{border-radius:14px;border:1px solid rgba(148,163,184,.6);padding:6px 7px;margin-bottom:6px;background:radial-gradient(circle at top,rgba(15,23,42,.97),rgba(15,23,42,1));}
.schedule-row-head{display:flex;justify-content:space-between;align-items:center;font-size:11px;margin-bottom:4px;}
.schedule-day-name{font-weight:900;}
.schedule-intervals{display:flex;flex-direction:column;gap:4px;margin-top:3px;}
.schedule-interval{display:flex;gap:4px;align-items:center;}
.schedule-interval select{flex:1;border-radius:10px;padding:4px 6px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,.95);color:#e5e7eb;font-size:11px;}
.schedule-interval button{border:none;border-radius:999px;padding:3px 7px;font-size:10px;cursor:pointer;background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(248,113,113,.7);}
.btn-add-interval{margin-top:4px;border-radius:999px;border:none;padding:3px 8px;font-size:10px;cursor:pointer;background:rgba(59,130,246,.12);color:#60a5fa;border:1px solid rgba(59,130,246,.7);}
.day-active-label{font-size:10px;display:flex;align-items:center;gap:4px;}
.day-active-label input{accent-color:var(--brand);}

.quick-backdrop{position:fixed;inset:0;z-index:45;display:none;align-items:flex-start;justify-content:center;background:rgba(15,23,42,.5);}
.quick-card{margin-top:70px;width:90%;max-width:360px;border-radius:22px;padding:10px 12px 12px;background:radial-gradient(circle at top,rgba(15,23,42,.98),rgba(15,23,42,1));border:1px solid rgba(250,204,21,.65);box-shadow:0 28px 80px rgba(0,0,0,.95);color:#f9fafb;}
.quick-head{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
.quick-icon{width:26px;height:26px;border-radius:999px;background:radial-gradient(circle at 30% 0,#facc15,#f97316);display:flex;align-items:center;justify-content:center;font-size:15px;}
.quick-title{font-size:13px;font-weight:900;}
.quick-body{font-size:11px;color:#e5e7eb;margin-top:4px;}

.msgbox{border-radius:16px;border:1px solid rgba(148,163,184,.7);background:rgba(15,23,42,.95);padding:8px}
.msgbox textarea{width:100%;min-height:110px;border-radius:12px;border:1px solid rgba(148,163,184,.5);background:rgba(15,23,42,.98);color:#e5e7eb;padding:8px;font-size:12px;resize:none;outline:none;}
.msg-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.msg-actions .btn-mini{padding:6px 10px;font-size:11px;border-radius:999px;}

/* ===== Admin Takvim (G√ºn G√∂r√ºn√ºm√º) ===== */
.cal-wrap{border-radius:18px;border:1px solid rgba(148,163,184,.55);background:radial-gradient(circle at top,rgba(15,23,42,.97),rgba(15,23,42,1));padding:8px;overflow:hidden;}
.cal-head{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px;}
.cal-head .date-input{max-width:160px;}
.cal-head .helper{margin-top:0;color:#e5e7eb}
.cal-grid{display:grid;grid-template-columns:64px 1fr;gap:8px;}
.cal-times{max-height:56vh;overflow:auto;padding-right:4px;}
.cal-time-row{height:28px;display:flex;align-items:center;justify-content:flex-start;color:#cbd5f5;font-size:10px;padding-left:4px;border-bottom:1px dashed rgba(148,163,184,.15);}
.cal-cols{max-height:56vh;overflow:auto;}
.cal-cols-inner{display:grid;gap:8px;}
.cal-col{border-radius:14px;border:1px solid rgba(148,163,184,.35);background:rgba(2,6,23,.35);overflow:hidden;}
.cal-col-head{display:flex;align-items:center;gap:8px;padding:7px 8px;border-bottom:1px solid rgba(148,163,184,.25);color:#e5e7eb;font-weight:900;font-size:11px;}
.cal-col-body{position:relative;}
.cal-col-body .cal-slot{height:28px;border-bottom:1px dashed rgba(148,163,184,.12);}
.cal-event{
  position:absolute;left:6px;right:6px;
  border-radius:12px;border:1px solid rgba(250,204,21,.45);
  background:linear-gradient(135deg,rgba(250,204,21,.18),rgba(212,175,55,.08));
  color:#f9fafb;padding:6px 7px;font-size:10px;cursor:pointer;
  box-shadow:0 14px 44px rgba(0,0,0,.65);
  overflow:hidden;
}
.cal-event .t1{font-weight:900;margin-bottom:2px;}
.cal-event .t2{opacity:.9}
.cal-event.noshow{border-color:rgba(248,113,113,.8);background:linear-gradient(135deg,rgba(239,68,68,.16),rgba(2,6,23,.1));}
.cal-event:hover{transform:translateY(-1px);}
.cal-legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.legend-pill{font-size:10px;border-radius:999px;padding:3px 8px;border:1px solid rgba(148,163,184,.5);color:#e5e7eb;background:rgba(2,6,23,.25);}

@media(max-width:480px){
  .wrap{padding:16px 10px 18px;border-radius:28px;}
  .card{padding:14px 10px 16px;}
  .brand-title{font-size:22px;}
  .slot-grid{grid-template-columns:repeat(3,minmax(0,1fr));gap:6px;}
  .date-input{font-size:11px;padding:5px 8px;}
}
@media(min-width:600px){.admin-filter-row{flex-direction:row;align-items:flex-end;gap:12px;}}
@media print{
  body{background:#fff;padding:0;}
  .bg,.bg-overlay,.wrap>.logo-wrap,.top-actions,.card,#customerModal,#scheduleModal,#editModal,#messageModal,.toast,.quick-backdrop{display:none!important;}
  #adminModal{position:static;display:block!important;background:#fff;}
  #adminModal .modal{max-width:100%;border:none;box-shadow:none;padding:10px;background:#fff;}
  #adminLoginArea{display:none!important;}
  #adminPanelArea{display:block!important;max-height:none;overflow:visible;}
  .admin-tabs{display:none!important;}
  .admin-section{display:none!important;}
  .admin-section.active{display:block!important;}
  .btn-full{display:none!important;}
  .app-item{box-shadow:none;border:1px solid #ddd;background:#fff;color:#000;}
  .app-title,.app-meta{color:#000;}
}
</style>
</head>

<body>
<div class="bg"></div>
<div class="bg-overlay"></div>

<div class="wrap">
  <div class="logo-wrap"><div class="logo-circle"></div></div>

  <div class="top-actions">
    <button class="btn-top" type="button" id="btnAdminOpen"><span id="adminBtnLabel">Admin Giri≈üi</span></button>
    <button class="btn-top" type="button" id="btnCustomerOpen"><span id="customerBtnLabel">M√º≈üteri Paneli</span></button>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="brand-title">AHMET TEKELƒ∞</div>
      <div class="brand-sub">ERKEK KUAF√ñR√ú</div>
      <div class="rating"><div class="star"></div><span>‚≠êÔ∏èONLƒ∞NE RANDEVU‚≠êÔ∏è</span></div>
    </div>

    <div>
      <div class="section-title">Ad Soyad</div>
      <input class="input" id="nameInput" placeholder="Adƒ±nƒ±z ve Soyadƒ±nƒ±z">

      <div class="section-title">Telefon</div>
      <input class="input" id="phoneInput" placeholder="05xxxxxxxxx">

      <div class="row">
        <div>
          <div class="section-title">Berber Se√ßimi</div>
          <div class="barber-choices" id="barberChoices"></div>
          <select class="select" id="barberSelect" style="display:none;"></select>
        </div>
        <div>
          <div class="section-title">ƒ∞≈ülem Se√ßimi</div>
          <select class="select" id="serviceSelect"></select>
        </div>
      </div>

      <div class="section-title" style="margin-top:8px;">Tarih</div>
      <input type="date" class="date-input" id="dateInput">

      <div class="section-title" style="margin-top:8px;">√ñnerilen Saatler</div>
      <div class="suggest-wrap" id="suggestWrap"></div>

      <div class="section-title" style="margin-top:8px;">Saat Se√ßimi</div>
      <div class="slot-grid" id="slotGrid"></div>

      <button class="btn-book" id="btnBook">RANDEVU AL</button>

      <div class="helper" id="bookingHelper">Randevu almak i√ßin √∂nce m√º≈üteri giri≈üi yapmalƒ±sƒ±n. M√º≈üteri panelinden kayƒ±t olabilirsin.</div>
      <div class="helper" id="dayInfoHelper"></div>
    </div>
  </div>
</div>

<!-- M√º≈üteri Paneli (SADE) -->
<div class="modal-backdrop" id="customerModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">M√º≈üteri Paneli</div>
      <button class="modal-close" type="button" id="modalClose">&times;</button>
    </div>

    <div id="customerLoggedBox" style="display:none;">
      <div class="helper" id="customerLoggedText"></div>

      <div class="panel" style="margin-top:8px;">
        <div class="section-title" style="color:#e5e7eb;margin-top:0;">Ayarlar</div>
        <label class="helper" style="color:#e5e7eb;display:flex;align-items:center;gap:8px;margin-top:6px;">
          <input type="checkbox" id="waAutoToggle" style="accent-color:var(--brand);">
          ƒ∞≈ülem sonrasƒ± WhatsApp mesajƒ±nƒ± otomatik a√ß
        </label>
      </div>

      <div class="panel" id="loyaltyPanel" style="margin-top:8px;display:none;">
        <div class="section-title" style="color:#e5e7eb;">Sadakat Puanƒ±n</div>
        <div class="helper" id="loyaltyText" style="color:#e5e7eb;margin-top:2px;"></div>
      </div>

      <div id="customerAppsBox" class="panel" style="margin-top:8px;display:none;">
        <div class="section-title">Randevularƒ±m</div>
        <ul class="app-list" id="appListModal"></ul>
      </div>

      <button class="btn-full" id="btnCustomerLogout" style="margin-top:10px;background:rgba(31,41,55,1);color:#f9fafb;">√áƒ±kƒ±≈ü Yap</button>
    </div>

    <div class="tabs" id="tabsRow">
      <button class="tab-btn active" type="button" data-tab="login">Giri≈ü Yap</button>
      <button class="tab-btn" type="button" data-tab="register">Kayƒ±t Ol</button>
    </div>

    <div id="loginTab">
      <div class="section-title">Telefon</div>
      <input class="input" id="loginPhone" placeholder="05xxxxxxxxx">
      <div class="section-title">≈ûifre</div>
      <input class="input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button class="btn-full" id="btnLogin">Giri≈ü Yap</button>
      <div class="helper">ƒ∞lk defa geliyorsan √ºstten <b>Kayƒ±t Ol</b> sekmesine ge√ß.</div>
    </div>

    <div id="registerTab" style="display:none;">
      <div class="section-title">Ad Soyad</div>
      <input class="input" id="regName" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z">
      <div class="section-title">Telefon</div>
      <input class="input" id="regPhone" placeholder="05xxxxxxxxx">
      <div class="section-title">≈ûifre</div>
      <input class="input" id="regPass" type="password" placeholder="En az 4 karakter">
      <button class="btn-full" id="btnRegister">Kayƒ±t Ol</button>
      <div class="helper">Kayƒ±t sonrasƒ± <b>Randevularƒ±m</b> b√∂l√ºm√ºnden iptal/deƒüi≈ütir yapabilirsin.</div>
    </div>
  </div>
</div>

<!-- Randevu Deƒüi≈ütir Modal (1: i≈ülem deƒüi≈ütirme + fiyat farkƒ±) -->
<div class="modal-backdrop" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Randevu Deƒüi≈ütir</div>
      <button class="modal-close" type="button" id="editModalClose">&times;</button>
    </div>

    <div class="helper" id="editInfo"></div>

    <div class="section-title" style="margin-top:8px;">Yeni ƒ∞≈ülem</div>
    <select class="select" id="editServiceSelect"></select>
    <div class="helper" id="editPriceInfo"></div>

    <div class="section-title" style="margin-top:8px;">Yeni Berber</div>
    <select class="select" id="editBarberSelect"></select>

    <div class="section-title" style="margin-top:8px;">Yeni Tarih</div>
    <input type="date" class="date-input" id="editDate">

    <div class="section-title" style="margin-top:8px;">Yeni Saat</div>
    <div class="slot-grid" id="editSlotGrid"></div>

    <button class="btn-full" id="btnSaveEdit" style="margin-top:10px;">G√úNCELLE</button>
    <div class="helper" id="editHelper"></div>
  </div>
</div>

<!-- WhatsApp Mesaj Modal -->
<div class="modal-backdrop" id="messageModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="msgTitle">Mesaj</div>
      <button class="modal-close" type="button" id="msgClose">&times;</button>
    </div>

    <div class="helper" id="msgHint">WhatsApp‚Äôa g√∂nderebilir veya kopyalayabilirsin.</div>

    <div class="msgbox" style="margin-top:8px;">
      <textarea id="msgText" readonly></textarea>
      <div class="msg-actions">
        <button class="btn-mini wp" id="btnMsgWhatsApp">WhatsApp</button>
        <button class="btn-mini note" id="btnMsgCopy">Kopyala</button>
        <button class="btn-mini del" id="btnMsgClose2">Kapat</button>
      </div>
      <div class="helper" id="msgResult"></div>
    </div>
  </div>
</div>

<!-- Admin Paneli -->
<div class="modal-backdrop" id="adminModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Admin Paneli</div>
      <button class="modal-close" type="button" id="adminModalClose">&times;</button>
    </div>

    <div id="adminLoginArea">
      <div class="section-title">Telefon</div>
      <input class="input" id="adminPhone" placeholder="Admin telefon">
      <div class="section-title">≈ûifre</div>
      <input class="input" id="adminPass" type="password" placeholder="≈ûifre">
      <button class="btn-full" id="btnAdminLogin">Admin Giri≈ü Yap</button>
      <div class="helper">Bu alan sadece i≈ületme sahibi i√ßindir.</div>
    </div>

    <div id="adminPanelArea" style="display:none;max-height:70vh;overflow:auto;padding-right:4px;">

      <div class="admin-summary">
        <div class="summary-card">
          <div class="summary-label">Bug√ºn Randevu</div>
          <div class="summary-value" id="sumTodayCount">0</div>
          <div class="summary-sub" id="sumTodayRevenue">0 ‚Ç∫</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Toplam Randevu</div>
          <div class="summary-value" id="sumAllCount">0</div>
          <div class="summary-sub" id="sumAllRevenue">0 ‚Ç∫</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Bug√ºn Aktif Berber</div>
          <div class="summary-value" id="sumActiveBarber">0</div>
          <div class="summary-sub">√áalƒ±≈üma planƒ±na g√∂re</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">En √áok ƒ∞≈ülem</div>
          <div class="summary-value" id="sumTopServiceName">-</div>
          <div class="summary-sub" id="sumTopServiceCount">0 adet</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">En √áok Berber</div>
          <div class="summary-value" id="sumTopBarberName">-</div>
          <div class="summary-sub" id="sumTopBarberCount">0 adet</div>
        </div>
      </div>

      <div class="admin-tabs">
        <button class="admin-tab active" data-admin-section="adminSectionRapor">Raporlar</button>
        <button class="admin-tab" data-admin-section="adminSectionTakvim">Takvim</button>
        <button class="admin-tab" data-admin-section="adminSectionRandevu">Randevular</button>
        <button class="admin-tab" data-admin-section="adminSectionHizmet">Hizmet</button>
        <button class="admin-tab" data-admin-section="adminSectionBerber">Berber & Saat</button>
        <button class="admin-tab" data-admin-section="adminSectionMusteri">M√º≈üteriler</button>
      </div>

      <div class="admin-section active" id="adminSectionRapor">
        <div class="section-title">Raporlar</div>
        <ul class="app-list" id="reportList"></ul>
        <button class="btn-full" id="btnPrintReports" style="margin-top:8px;">Raporlarƒ± PDF Olarak √áƒ±kar</button>
        <button class="btn-full" id="btnCopyTodaySummary" style="margin-top:8px;background:rgba(34,197,94,.18);color:#bbf7d0;">
          Bug√ºn ƒ∞√ßin Hikaye / Mesaj Metni Olu≈ütur (Kopyala)
        </button>
      </div>

      <!-- (3) Takvim -->
      <div class="admin-section" id="adminSectionTakvim">
        <div class="section-title">Takvim (G√ºn G√∂r√ºn√ºm√º)</div>
        <div class="cal-wrap">
          <div class="cal-head">
            <input type="date" class="date-input" id="adminCalDate">
            <div class="helper" id="adminCalHint">Bir randevuya dokun: Sil / Gelmedi / WhatsApp.</div>
          </div>

          <div class="cal-grid">
            <div class="cal-times" id="calTimes"></div>
            <div class="cal-cols" id="calCols"></div>
          </div>

          <div class="cal-legend">
            <span class="legend-pill">üü° Normal</span>
            <span class="legend-pill">üî¥ Gelmedi</span>
          </div>
        </div>
      </div>

      <div class="admin-section" id="adminSectionRandevu">
        <div class="section-title">Randevu Y√∂netimi</div>
        <div class="admin-filter-row">
          <div>
            <div class="section-title">Tarih Filtresi</div>
            <input type="date" class="date-input" id="adminDateFilter">
          </div>
          <div>
            <div class="section-title">Berber Filtresi</div>
            <select class="select" id="adminBarberFilter"></select>
          </div>
        </div>

        <ul class="app-list" id="adminAppList"></ul>
        <div class="helper" id="adminCountInfo"></div>

        <button class="btn-full" id="btnPrintAppointments" style="margin-top:8px;">Randevu Listesini PDF Olarak √áƒ±kar</button>

        <div class="closed-panel-title">Kapalƒ± G√ºnler (√ñzel tatil / d√ºkk√¢n kapalƒ±)</div>
        <div class="row" style="margin-top:4px;">
          <input type="date" class="date-input" id="closedDateInput">
          <button class="btn-full" id="btnAddClosedDate" style="margin-top:0;">Kapalƒ± G√ºn Ekle</button>
        </div>
        <div id="closedDateList"></div>
      </div>

      <div class="admin-section" id="adminSectionHizmet">
        <div class="section-title">Hizmet Y√∂netimi</div>
        <div class="helper" style="margin-top:0;">‚úÖ S√ºre mantƒ±ƒüƒ± aktif. (60dk = 2 slot)</div>
        <ul class="app-list" id="serviceList"></ul>

        <div class="row" style="margin-top:6px;">
          <input class="input" id="newServiceName" placeholder="Hizmet adƒ± (Sa√ß Kesim)">
          <input class="input" id="newServicePrice" type="number" min="0" step="10" placeholder="Fiyat">
          <input class="input" id="newServiceDuration" type="number" min="30" step="30" placeholder="S√ºre (dk)">
        </div>
        <button class="btn-full" id="btnAddService" style="margin-top:6px;">Hizmet Ekle</button>
      </div>

      <div class="admin-section" id="adminSectionBerber">
        <div class="section-title">Berber Y√∂netimi & √áalƒ±≈üma Saatleri</div>
        <ul class="app-list" id="barberList"></ul>

        <div class="section-title" style="margin-top:10px;">Yeni Berber</div>
        <input class="input" id="newBarberName" placeholder="√ñrn: Ahmet TEKELƒ∞">

        <div class="section-title">Fotoƒüraf Y√ºkle (isteƒüe baƒülƒ±)</div>
        <input class="input" id="newBarberPhotoFile" type="file" accept="image/*" style="padding:6px 10px;">

        <button class="btn-full" id="btnAddBarber" style="margin-top:6px;">Berber Ekle</button>

        <button class="btn-full" id="btnResetData" style="margin-top:10px;background:#991b1b;color:#fef2f2;">
          Cihazdaki Oturum / Yerel Veriyi Sƒ±fƒ±rla
        </button>
        <div class="helper">Not: Firestore verileri silinmez. Sadece bu cihazƒ±n giri≈üleri temizlenir.</div>
      </div>

      <div class="admin-section" id="adminSectionMusteri">
        <div class="section-title">M√º≈üteri Listesi</div>
        <ul class="app-list" id="customerList"></ul>
        <div class="panel" id="customerDetail" style="display:none;margin-top:8px;"></div>

        <div class="panel" style="margin-top:8px;">
          <div class="section-title">En √áok Gelen M√º≈üteriler</div>
          <ul class="app-list" id="topCustomerList"></ul>
        </div>
      </div>

      <button class="btn-full" id="btnAdminLogout" style="margin-top:14px;background:rgba(31,41,55,1);color:#f9fafb;">Admin √áƒ±kƒ±≈ü</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="scheduleModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="scheduleModalTitle">√áalƒ±≈üma Saatleri</div>
      <button class="modal-close" type="button" id="scheduleModalClose">&times;</button>
    </div>
    <div class="schedule-wrapper" id="scheduleWrapper"></div>
    <button class="btn-full" id="btnSaveSchedule">√áalƒ±≈üma Saatlerini Kaydet</button>
  </div>
</div>

<div class="quick-backdrop" id="quickNotify">
  <div class="quick-card">
    <div class="quick-head">
      <div class="quick-icon">‚úî</div>
      <div class="quick-title">ƒ∞≈ülem Tamam</div>
    </div>
    <div class="quick-body" id="quickBodyText"></div>
  </div>
</div>

<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon">‚úî</span>
  <span id="toastText"></span>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore, collection, doc, getDoc, getDocs,
  setDoc, deleteDoc, onSnapshot,
  runTransaction, serverTimestamp,
  query, where
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey:"AIzaSyD3S0XgKgNJLCJr3xQ-ASgr1gHz9MCou-4",
  authDomain:"randevularim-92ac2.firebaseapp.com",
  projectId:"randevularim-92ac2",
  storageBucket:"randevularim-92ac2.firebasestorage.app",
  messagingSenderId:"1092355095676",
  appId:"1:1092355095676:web:085921b2dff9d607b7ddf9"
};
const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);

/* ===== Shop ===== */
const SHOP_ID = "ahmet_tekeli";
const COL = {
  services:   `shops/${SHOP_ID}/services`,
  barbers:    `shops/${SHOP_ID}/barbers`,
  schedules:  `shops/${SHOP_ID}/schedules`,
  closed:     `shops/${SHOP_ID}/closedDates`,
  customers:  `shops/${SHOP_ID}/customers`,
  apps:       `shops/${SHOP_ID}/appointments`,
};

const SLOT_TIMES=[
 "08:00","08:30","09:00","09:30",
 "10:00","10:30","11:00","11:30",
 "12:00","12:30","13:00","13:30",
 "14:00","14:30","15:00","15:30",
 "16:00","16:30","17:00","17:30",
 "18:00","18:30","19:00","19:30",
 "20:00","20:30","21:00","21:30",
 "22:00","22:30","23:00","23:30"
];

const ADMIN_PHONE="05356749243";
const ADMIN_PASS="ahmet";

/* üî• WhatsApp mesajƒ±nƒ±n gideceƒüi d√ºkk√¢n numarasƒ± */
const SHOP_WA_NUMBER = ADMIN_PHONE; // burayƒ± istersen i≈ületme WhatsApp‚Äôƒ±na √ßevir

const MAX_DAYS_AHEAD=30;
const DAY_NAMES=["Pazartesi","Salƒ±","√áar≈üamba","Per≈üembe","Cuma","Cumartesi","Pazar"];
const LOYALTY_TARGET=10;

const LS_ADMIN="ahmet_admin_logged";
const LS_CURRENT_CUST="ahmet_current_customer_phone";
const LS_WA_AUTO="ahmet_wa_auto";

let services=[], barbers=[], schedules={}, appointments=[], closedDates=[];
let customerAgg=[];
let currentCustomer=null;
let isAdminLoggedIn=false;
let selectedTime=null, selectedBarberId=null, currentScheduleBarberId=null;
let realtimeStarted=false;
let toastTimer=null;

let editingApp=null;
let editSelectedTime=null;
let editIgnoreId=null;
let editSelectedBarberId=null;
let editSelectedServiceId=null;

let pendingWA = { phone:"", text:"" };

/* ===== DOM ===== */
const slotGrid=document.getElementById("slotGrid");
const suggestWrap=document.getElementById("suggestWrap");
const dateInput=document.getElementById("dateInput");
const btnBook=document.getElementById("btnBook");
const nameInput=document.getElementById("nameInput");
const phoneInput=document.getElementById("phoneInput");
const barberSel=document.getElementById("barberSelect");
const barberChoicesEl=document.getElementById("barberChoices");
const servSel=document.getElementById("serviceSelect");
const toastEl=document.getElementById("toast");
const toastText=document.getElementById("toastText");
const toastIcon=document.getElementById("toastIcon");
const bookingHelper=document.getElementById("bookingHelper");
const dayInfoHelper=document.getElementById("dayInfoHelper");

const customerModal=document.getElementById("customerModal");
const btnCustomerOpen=document.getElementById("btnCustomerOpen");
const modalClose=document.getElementById("modalClose");
const tabBtns=document.querySelectorAll(".tab-btn");
const loginTab=document.getElementById("loginTab");
const registerTab=document.getElementById("registerTab");
const btnLogin=document.getElementById("btnLogin");
const btnRegister=document.getElementById("btnRegister");
const customerLoggedBox=document.getElementById("customerLoggedBox");
const customerLoggedText=document.getElementById("customerLoggedText");
const btnCustomerLogout=document.getElementById("btnCustomerLogout");
const customerBtnLabel=document.getElementById("customerBtnLabel");
const customerAppsBox=document.getElementById("customerAppsBox");
const appListModal=document.getElementById("appListModal");
const tabsRow=document.getElementById("tabsRow");
const loginPhone=document.getElementById("loginPhone");
const loginPass=document.getElementById("loginPass");
const regName=document.getElementById("regName");
const regPhone=document.getElementById("regPhone");
const regPass=document.getElementById("regPass");
const loyaltyPanel=document.getElementById("loyaltyPanel");
const loyaltyText=document.getElementById("loyaltyText");
const waAutoToggle=document.getElementById("waAutoToggle");

const editModal=document.getElementById("editModal");
const editModalClose=document.getElementById("editModalClose");
const editInfo=document.getElementById("editInfo");
const editDate=document.getElementById("editDate");
const editSlotGrid=document.getElementById("editSlotGrid");
const btnSaveEdit=document.getElementById("btnSaveEdit");
const editHelper=document.getElementById("editHelper");
const editBarberSelect=document.getElementById("editBarberSelect");
const editServiceSelect=document.getElementById("editServiceSelect");
const editPriceInfo=document.getElementById("editPriceInfo");

const messageModal=document.getElementById("messageModal");
const msgClose=document.getElementById("msgClose");
const btnMsgClose2=document.getElementById("btnMsgClose2");
const msgTitle=document.getElementById("msgTitle");
const msgHint=document.getElementById("msgHint");
const msgText=document.getElementById("msgText");
const btnMsgWhatsApp=document.getElementById("btnMsgWhatsApp");
const btnMsgCopy=document.getElementById("btnMsgCopy");
const msgResult=document.getElementById("msgResult");

const adminModalEl=document.getElementById("adminModal");
const btnAdminOpen=document.getElementById("btnAdminOpen");
const adminModalClose=document.getElementById("adminModalClose");
const adminLoginArea=document.getElementById("adminLoginArea");
const adminPanelArea=document.getElementById("adminPanelArea");
const btnAdminLogin=document.getElementById("btnAdminLogin");
const btnAdminLogout=document.getElementById("btnAdminLogout");
const adminBtnLabel=document.getElementById("adminBtnLabel");
const adminTabBtns=document.querySelectorAll(".admin-tab");
const adminSections=document.querySelectorAll(".admin-section");
const adminPhoneInput=document.getElementById("adminPhone");
const adminPassInput=document.getElementById("adminPass");

const serviceListEl=document.getElementById("serviceList");
const newServiceNameEl=document.getElementById("newServiceName");
const newServicePriceEl=document.getElementById("newServicePrice");
const newServiceDurationEl=document.getElementById("newServiceDuration");
const btnAddService=document.getElementById("btnAddService");

const barberListEl=document.getElementById("barberList");
const newBarberNameEl=document.getElementById("newBarberName");
const newBarberPhotoFileEl=document.getElementById("newBarberPhotoFile");
const btnAddBarber=document.getElementById("btnAddBarber");
const btnResetData=document.getElementById("btnResetData");

const adminDateFilter=document.getElementById("adminDateFilter");
const adminBarberFilter=document.getElementById("adminBarberFilter");
const adminAppList=document.getElementById("adminAppList");
const adminCountInfo=document.getElementById("adminCountInfo");
const reportListEl=document.getElementById("reportList");
const btnPrintReports=document.getElementById("btnPrintReports");
const btnPrintAppointments=document.getElementById("btnPrintAppointments");
const btnCopyTodaySummary=document.getElementById("btnCopyTodaySummary");

const closedDateInput=document.getElementById("closedDateInput");
const btnAddClosedDate=document.getElementById("btnAddClosedDate");
const closedDateList=document.getElementById("closedDateList");

const scheduleModal=document.getElementById("scheduleModal");
const scheduleModalTitle=document.getElementById("scheduleModalTitle");
const scheduleModalClose=document.getElementById("scheduleModalClose");
const scheduleWrapper=document.getElementById("scheduleWrapper");
const btnSaveSchedule=document.getElementById("btnSaveSchedule");

const quickNotify=document.getElementById("quickNotify");
const quickBodyText=document.getElementById("quickBodyText");

const sumTodayCountEl=document.getElementById("sumTodayCount");
const sumTodayRevenueEl=document.getElementById("sumTodayRevenue");
const sumAllCountEl=document.getElementById("sumAllCount");
const sumAllRevenueEl=document.getElementById("sumAllRevenue");
const sumActiveBarberEl=document.getElementById("sumActiveBarber");
const sumTopServiceNameEl=document.getElementById("sumTopServiceName");
const sumTopServiceCountEl=document.getElementById("sumTopServiceCount");
const sumTopBarberNameEl=document.getElementById("sumTopBarberName");
const sumTopBarberCountEl=document.getElementById("sumTopBarberCount");

const customerListEl=document.getElementById("customerList");
const customerDetailEl=document.getElementById("customerDetail");
const topCustomerListEl=document.getElementById("topCustomerList");

/* Takvim DOM */
const adminCalDate=document.getElementById("adminCalDate");
const calTimes=document.getElementById("calTimes");
const calCols=document.getElementById("calCols");

/* ===== Helpers ===== */
function col(path){ return collection(db, path); }
function dref(path, id){ return doc(db, path, id); }
function todayStr(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}
function parseLocalDate(str){const [y,m,d]=str.split("-").map(Number);return new Date(y,m-1,d);}
function timeToMinutes(t){const [h,m]=t.split(":").map(Number); return h*60+m;}
function cleanPhone10(p){ return String(p||"").replace(/\D/g,"").slice(-10); }
function createDefaultSchedule(){const arr=[]; for(let i=0;i<7;i++) arr.push({active:i<6, intervals:[{start:"09:00", end:"19:00"}]}); return arr;}
function slotIdFor(date, barberId, time){ return `${date}__${barberId}__${time}`; }

function showToast(message,type="ok"){
  if(toastTimer){clearTimeout(toastTimer);toastTimer=null;}
  toastText.textContent=message;
  toastIcon.textContent=type==="ok"?"‚úî":"!";
  toastEl.className="toast "+type;
  toastEl.style.display="flex";
  toastEl.style.opacity="1";
  toastEl.style.pointerEvents="auto";
  toastTimer=setTimeout(()=>{
    toastEl.style.opacity="0";
    toastEl.style.pointerEvents="none";
    setTimeout(()=>{toastEl.style.display="none";},300);
  },4200);
}
function showQuickPopup(text){
  quickBodyText.textContent=text;
  quickNotify.style.display="flex";
  setTimeout(()=>{quickNotify.style.display="none";},1600);
}

/* ===== WhatsApp Message Modal ===== */
function phoneToWa(phoneRawOr10){
  const clean=String(phoneRawOr10||"").replace(/\D/g,"").slice(-10);
  return "90"+clean;
}
function openWhatsApp(phone, text){
  const url=`https://wa.me/${phoneToWa(phone)}?text=${encodeURIComponent(text)}`;
  window.open(url,"_blank");
}
function showMessageModal({title="Mesaj", hint="WhatsApp‚Äôa g√∂nderebilir veya kopyalayabilirsin.", phone=SHOP_WA_NUMBER, text="", autoOpen=false}){
  pendingWA = { phone, text };
  msgTitle.textContent = title;
  msgHint.textContent = hint;
  msgText.value = text;
  msgResult.textContent = "";
  messageModal.style.display="flex";
  if(autoOpen){
    openWhatsApp(phone, text);
    msgResult.textContent = "WhatsApp a√ßƒ±ldƒ± (hazƒ±r mesaj).";
  }
}
function waAutoEnabled(){ return localStorage.getItem(LS_WA_AUTO)==="1"; }
waAutoToggle.addEventListener("change",()=>{
  localStorage.setItem(LS_WA_AUTO, waAutoToggle.checked ? "1" : "0");
  showToast(waAutoToggle.checked ? "WhatsApp otomatik a√ßma aktif." : "WhatsApp otomatik a√ßma kapalƒ±.","ok");
});
msgClose.addEventListener("click",()=>messageModal.style.display="none");
btnMsgClose2.addEventListener("click",()=>messageModal.style.display="none");
btnMsgWhatsApp.addEventListener("click",()=>{ openWhatsApp(pendingWA.phone, pendingWA.text); msgResult.textContent="WhatsApp a√ßƒ±ldƒ±."; });
btnMsgCopy.addEventListener("click",async ()=>{
  try{ await navigator.clipboard.writeText(pendingWA.text); msgResult.textContent="Kopyalandƒ± ‚úÖ"; }
  catch(e){ msgResult.textContent="Kopyalama desteklenmiyor. Metni elle se√ßebilirsin."; }
});

/* ===== Password hashing ===== */
async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
const PASS_SALT = "ATK_2026";

/* ===== Barber photo resize ===== */
async function resizeImageToDataURL(file, max=256, quality=0.78){
  const dataUrl = await new Promise((res, rej)=>{
    const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
  });
  const img = await new Promise((res, rej)=>{
    const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl;
  });
  const scale = Math.min(1, max/Math.max(img.width, img.height));
  const w = Math.round(img.width*scale);
  const h = Math.round(img.height*scale);
  const canvas = document.createElement("canvas");
  canvas.width=w; canvas.height=h;
  canvas.getContext("2d").drawImage(img,0,0,w,h);
  return canvas.toDataURL("image/jpeg", quality);
}

/* ===== Services ===== */
function getServiceById(id){ return services.find(s=>s.id===id) || null; }
function getServiceMinutesById(id){
  const s=getServiceById(id);
  const dur=Number(s?.duration||0) || 30;
  return Math.max(30, dur);
}
function getServicePriceById(id){
  const s=getServiceById(id);
  return Number(s?.price||0) || 0;
}
function getAppointmentMinutes(app){
  if(app?.totalMinutes) return Number(app.totalMinutes||0) || 30;
  const dur=Number(app?.duration||0) || getServiceMinutesById(app?.serviceId) || 30;
  return Math.max(30, dur);
}

/* ===== ICS (Takvime Ekle) ===== */
function downloadICSFor(app){
  try{
    const title = `Ahmet Tekeli Kuaf√∂r - ${app.serviceName}`;
    const start = new Date(app.date+"T"+app.time+":00");
    const end = new Date(start.getTime() + getAppointmentMinutes(app)*60000);
    const toICS = (d)=>{
      const pad=(n)=>String(n).padStart(2,"0");
      return d.getUTCFullYear()+pad(d.getUTCMonth()+1)+pad(d.getUTCDate())+"T"+
             pad(d.getUTCHours())+pad(d.getUTCMinutes())+pad(d.getUTCSeconds())+"Z";
    };
    const uid = (app.id || (Date.now()+"")) + "@berberimrandevu";
    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//BerberimRandevu//TR
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${toICS(new Date())}
DTSTART:${toICS(start)}
DTEND:${toICS(end)}
SUMMARY:${title}
DESCRIPTION:${app.barberName} - ${app.serviceName} - ${app.price} TL
END:VEVENT
END:VCALENDAR`;
    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`randevu_${app.date}_${app.time}.ics`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }catch(e){
    showToast("Takvim dosyasƒ± olu≈üturulamadƒ±.","err");
  }
}

/* ===== Seed defaults ===== */
async function seedIfEmpty(){
  const s = await getDocs(col(COL.services));
  if(s.empty){
    const defaults = [
      {id:"svc-sac",name:"Sa√ß Kesim",price:250,duration:30},
      {id:"svc-sac-sakal",name:"Sa√ß + Sakal",price:750,duration:60},
      {id:"svc-sakal",name:"Sakal",price:200,duration:30}
    ];
    for(const x of defaults) await setDoc(dref(COL.services, x.id), x);
  }

  const b = await getDocs(col(COL.barbers));
  if(b.empty){
    const defaults = [
      {id:"brb-ahmet",name:"Ahmet TEKELƒ∞",photo:null},
      {id:"brb-efe",name:"Efe KARA",photo:null},
      {id:"brb-ercan",name:"Ercan DOƒûRU",photo:null}
    ];
    for(const x of defaults) await setDoc(dref(COL.barbers, x.id), x);
  }

  const sch = await getDocs(col(COL.schedules));
  if(sch.empty){
    const b2 = await getDocs(col(COL.barbers));
    for(const d of b2.docs){
      await setDoc(dref(COL.schedules, d.id), { barberId:d.id, days:createDefaultSchedule() });
    }
  }
}

/* ===== Realtime ===== */
function startRealtime(){
  if(realtimeStarted) return;
  realtimeStarted=true;

  onSnapshot(col(COL.services), snap=>{
    services = snap.docs.map(d=>({id:d.id, ...d.data()}))
      .sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    renderServices();
    renderSlots();
    renderEditServiceOptions();
    updateAdminSummary();
  });

  onSnapshot(col(COL.barbers), snap=>{
    barbers = snap.docs.map(d=>({id:d.id, ...d.data()}))
      .sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    if(!selectedBarberId && barbers[0]) selectedBarberId = barbers[0].id;
    if(selectedBarberId && !barbers.some(b=>b.id===selectedBarberId) && barbers[0]) selectedBarberId = barbers[0].id;
    renderBarbers();
    editBarberSelect.innerHTML = barbers.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
    renderSlots();
    renderAdminCalendar();
    updateAdminSummary();
  });

  onSnapshot(col(COL.schedules), snap=>{
    const map={};
    snap.docs.forEach(d=>{
      const data=d.data()||{};
      map[d.id] = Array.isArray(data.days) ? data.days : createDefaultSchedule();
    });
    schedules = map;
    renderSlots();
    renderAdminCalendar();
    updateAdminSummary();
  });

  onSnapshot(col(COL.closed), snap=>{
    closedDates = snap.docs.map(d=>d.id).sort();
    renderClosedDateList();
    renderSlots();
  });

  onSnapshot(col(COL.apps), snap=>{
    const arr = snap.docs.map(d=>({id:d.id, ...d.data()}));
    arr.sort((a,b)=>`${a.date||""} ${a.time||""}`.localeCompare(`${b.date||""} ${b.time||""}`));
    appointments = arr;
    renderAll();
  });

  setInterval(async ()=>{
    if(!currentCustomer?.phone10) return;
    try{
      const c = await getDoc(dref(COL.customers, currentCustomer.phone10));
      if(c.exists()){
        const data=c.data();
        currentCustomer = {...currentCustomer, name: data.name||currentCustomer.name, points: Number(data.points||0)};
        refreshCustomerUI();
      }
    }catch(e){}
  }, 7000);
}

/* ===== Render services ===== */
function renderServices(){
  servSel.innerHTML = services.map(s=>{
    const dur=Number(s.duration||0)||30;
    return `<option value="${s.id}">${s.name} ‚Ä¢ ${Number(s.price||0)}‚Ç∫ ‚Ä¢ ${dur}dk</option>`;
  }).join("");

  serviceListEl.innerHTML = services.map(s=>{
    const dur=Number(s.duration||0)||30;
    return `
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${s.name}</div>
        <div class="app-meta">${Number(s.price||0)} ‚Ç∫ ‚Ä¢ S√ºre: ${dur} dk</div>
      </div>
      <div class="app-actions">
        <button class="btn-mini del" onclick="window.deleteService('${s.id}')">Sil</button>
      </div>
    </li>`;
  }).join("");
}

/* Edit hizmet dropdown */
function renderEditServiceOptions(){
  editServiceSelect.innerHTML = services.map(s=>{
    const dur=Number(s.duration||0)||30;
    return `<option value="${s.id}">${s.name} ‚Ä¢ ${Number(s.price||0)}‚Ç∫ ‚Ä¢ ${dur}dk</option>`;
  }).join("");
  if(editSelectedServiceId) editServiceSelect.value = editSelectedServiceId;
}

function renderBarbers(){
  barberSel.innerHTML = barbers.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
  if(selectedBarberId) barberSel.value = selectedBarberId;

  barberChoicesEl.innerHTML = barbers.map(b=>{
    const initials=(b.name||"B").split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase();
    const sel = b.id===selectedBarberId ? "barber-chip selected" : "barber-chip";
    const avatar = b.photo ? `<img src="${b.photo}" alt="">` : initials;
    return `<div class="${sel}" data-id="${b.id}">
      <div class="barber-avatar">${avatar}</div><span>${b.name}</span>
    </div>`;
  }).join("");

  adminBarberFilter.innerHTML = `<option value="">T√ºm√º</option>` +
    barbers.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");

  barberListEl.innerHTML = barbers.map(b=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${b.name}</div>
        <div class="app-meta">√áalƒ±≈üma saatlerini d√ºzenle</div>
      </div>
      <div class="app-actions">
        <button class="btn-mini note" onclick="window.openSchedule('${b.id}')">Saat</button>
        <button class="btn-mini del" onclick="window.deleteBarber('${b.id}')">Sil</button>
      </div>
    </li>
  `).join("");

  Array.from(barberChoicesEl.querySelectorAll(".barber-chip")).forEach(ch=>{
    ch.addEventListener("click",()=>setSelectedBarber(ch.getAttribute("data-id")));
  });
}

function setSelectedBarber(id){
  selectedBarberId=id;
  if(id) barberSel.value=id;
  Array.from(barberChoicesEl.querySelectorAll(".barber-chip")).forEach(ch=>{
    ch.classList.toggle("selected", ch.getAttribute("data-id")===id);
  });
  renderSlots();
}

/* ===== Availability ===== */
function getDayScheduleFor(barberId, dateVal){
  const picked=parseLocalDate(dateVal);
  const jsDay=picked.getDay();
  const dayIndex=(jsDay+6)%7;
  const daySch = schedules[barberId]?.[dayIndex] || null;
  return { picked, dayIndex, daySch };
}
function isWithinSchedule(daySch, startMin, endMin){
  if(!daySch) return true;
  if(!daySch.active) return false;
  const intervals = daySch.intervals || [];
  for(const it of intervals){
    const s=timeToMinutes(it.start), e=timeToMinutes(it.end);
    if(startMin>=s && endMin<=e) return true;
  }
  return false;
}
function overlapsExisting(dateVal, barberId, startMin, endMin, ignoreId=null){
  const same = appointments.filter(a=>a.date===dateVal && a.barberId===barberId && a.id!==ignoreId);
  for(const a of same){
    const aStart=timeToMinutes(a.time);
    const aEnd=aStart + getAppointmentMinutes(a);
    if(startMin < aEnd && aStart < endMin) return true;
  }
  return false;
}
function computeAvailableTimes(dateVal, barberId, serviceId, ignoreId=null){
  const total = getServiceMinutesById(serviceId);
  const {daySch} = getDayScheduleFor(barberId, dateVal);

  const today=todayStr();
  const isToday = (dateVal===today);
  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes();

  const available=[];
  for(const t of SLOT_TIMES){
    const start=timeToMinutes(t);
    const end=start+total;

    if(isToday && start<=nowMin+2) continue;
    if(!isWithinSchedule(daySch, start, end)) continue;
    if(overlapsExisting(dateVal, barberId, start, end, ignoreId)) continue;

    available.push(t);
  }
  return available;
}

function renderSuggested(dateVal, barberId, serviceId){
  suggestWrap.innerHTML="";
  if(!dateVal || !barberId || !serviceId) return;
  const list = computeAvailableTimes(dateVal, barberId, serviceId, null).slice(0,4);
  if(!list.length){
    suggestWrap.innerHTML = `<div class="helper" style="margin-top:0;">Uygun √∂neri bulunamadƒ±.</div>`;
    return;
  }
  suggestWrap.innerHTML = list.map(t=>`<button type="button" class="suggest-btn" data-t="${t}">${t}</button>`).join("");
  Array.from(suggestWrap.querySelectorAll(".suggest-btn")).forEach(b=>{
    b.addEventListener("click",()=>{
      const el = slotGrid.querySelector(`[data-time="${b.dataset.t}"]`);
      if(el && !el.classList.contains("disabled")) el.click();
    });
  });
}

function renderSlots(){
  const dateVal=dateInput.value;
  slotGrid.innerHTML="";
  selectedTime=null;

  if(!dateVal){ dayInfoHelper.textContent="L√ºtfen bir tarih se√ß."; return; }

  const today=todayStr();
  const todayDate=parseLocalDate(today);
  const picked=parseLocalDate(dateVal);

  if(picked<todayDate){ dayInfoHelper.textContent="Ge√ßmi≈ü tarihe randevu alƒ±namaz."; suggestWrap.innerHTML=""; return; }
  const diff=(picked-todayDate)/86400000;
  if(diff>MAX_DAYS_AHEAD){ dayInfoHelper.textContent=`En fazla ${MAX_DAYS_AHEAD} g√ºn sonrasƒ±na randevu alabilirsin.`; suggestWrap.innerHTML=""; return; }
  if(closedDates.includes(dateVal)){ dayInfoHelper.textContent="Bu tarih i√ßin d√ºkk√¢n kapalƒ±."; suggestWrap.innerHTML=""; return; }

  const barberId = selectedBarberId || barbers[0]?.id || null;
  const serviceId = servSel.value;

  if(!barberId || !serviceId){
    dayInfoHelper.textContent="Berber ve i≈ülem se√ß.";
    suggestWrap.innerHTML="";
    return;
  }

  const brb = barbers.find(b=>b.id===barberId)||null;
  const {daySch} = getDayScheduleFor(barberId, dateVal);

  if(daySch){
    if(!daySch.active){ dayInfoHelper.textContent=`${brb?brb.name:"Berber"} bu g√ºn i√ßin pasif.`; suggestWrap.innerHTML=""; return; }
    if(!daySch.intervals?.length){ dayInfoHelper.textContent=`${brb?brb.name:"Berber"} i√ßin bu g√ºne saat tanƒ±mlƒ± deƒüil.`; suggestWrap.innerHTML=""; return; }
  }

  renderSuggested(dateVal, barberId, serviceId);

  const total = getServiceMinutesById(serviceId);
  const availSet = new Set(computeAvailableTimes(dateVal, barberId, serviceId, null));

  const btns=[];
  for(const t of SLOT_TIMES){
    const start=timeToMinutes(t);
    const end=start+total;
    if(!isWithinSchedule(daySch, start, end)) continue;
    const disabled = !availSet.has(t);
    btns.push(`<button type="button" class="slot ${disabled?"disabled":""}" data-time="${t}" ${disabled?"disabled":""}>${t}</button>`);
  }

  if(!btns.length){ dayInfoHelper.textContent=`${brb?brb.name:"Berber"} i√ßin bu tarih/saatte uygun bo≈üluk yok.`; return; }

  slotGrid.innerHTML=btns.join("");
  dayInfoHelper.textContent="";

  Array.from(slotGrid.querySelectorAll(".slot")).forEach(btn=>{
    btn.addEventListener("click",()=>{
      Array.from(slotGrid.querySelectorAll(".slot")).forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedTime=btn.getAttribute("data-time");
    });
  });
}

function renderClosedDateList(){
  closedDateList.innerHTML = closedDates.map(d=>`
    <div class="closed-date-item">
      <span>${d}</span>
      <button class="btn-mini del" onclick="window.deleteClosedDate('${d}')">Sil</button>
    </div>
  `).join("");
}

/* ===== Customer appointments (SADE) ===== */
function renderMyAppointments(){
  if(!currentCustomer){ customerAppsBox.style.display="none"; appListModal.innerHTML=""; return; }
  const phone10=currentCustomer.phone10;

  const list = appointments
    .filter(a=>a.phone10===phone10 && (a.status||"active")!=="noshow")
    .sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));

  if(!list.length){ customerAppsBox.style.display="none"; appListModal.innerHTML=""; return; }

  customerAppsBox.style.display="block";
  appListModal.innerHTML = list.map(a=>{
    const total=getAppointmentMinutes(a);
    return `<li class="app-item">
      <div class="app-main">
        <div class="app-title">${a.date} ‚Ä¢ ${a.time}</div>
        <div class="app-meta">${a.serviceName} ‚Ä¢ ${a.barberName} ‚Ä¢ ${total} dk</div>
      </div>
      <div class="app-actions">
        <button class="btn-mini edit" onclick="window.openEditAppointment('${a.id}')">Deƒüi≈ütir</button>
        <button class="btn-mini del" onclick="window.cancelMyAppointment('${a.id}')">ƒ∞ptal</button>
        <button class="btn-mini cal" onclick="window.addToCalendar('${a.id}')">Takvim</button>
      </div>
    </li>`;
  }).join("");
}
window.addToCalendar = (id)=>{ const app = appointments.find(a=>a.id===id); if(app) downloadICSFor(app); };

/* ===== Admin appointments / reports / summary ===== */
function renderAdminAppointments(){
  let list=[...appointments];
  const fDate=adminDateFilter.value, fBarber=adminBarberFilter.value;
  if(fDate) list=list.filter(a=>a.date===fDate);
  if(fBarber) list=list.filter(a=>a.barberId===fBarber);

  adminAppList.innerHTML = list.map(a=>{
    const status=a.status||"active";
    const statusBadge=status==="noshow"?'<span style="color:#f97373;font-weight:900;">(Gelmedi)</span>':"";
    const noshowBtn=status==="noshow"?"":`<button class="btn-mini note" onclick="window.markNoShow('${a.id}')">Gelmedi</button>`;
    const total=getAppointmentMinutes(a);

    return `<li class="app-item">
      <div class="app-main">
        <div class="app-title">${a.date} ‚Ä¢ ${a.time} ${statusBadge}</div>
        <div class="app-meta">${a.name} ‚Ä¢ ${a.phoneRaw||""}</div>
        <div class="app-meta">${a.serviceName} ‚Ä¢ ${a.price} ‚Ç∫ ‚Ä¢ ${a.barberName} ‚Ä¢ ${total} dk</div>
      </div>
      <div class="app-actions">
        ${noshowBtn}
        <button class="btn-mini del" onclick="window.deleteAppointment('${a.id}')">Sil</button>
        <button class="btn-mini wp" onclick="window.sendWp('${a.phoneRaw||""}','${encodeURIComponent("Randevunuz "+a.date+" "+a.time+" i√ßin olu≈üturulmu≈ütur")}')">WP</button>
        <button class="btn-mini cal" onclick="window.addToCalendar('${a.id}')">Takvim</button>
      </div>
    </li>`;
  }).join("");

  adminCountInfo.textContent=`${list.length} adet randevu listelendi.`;
  updateAdminSummary();
}

function renderReports(){
  const map={};
  appointments.forEach(a=>{
    const st=a.status||"active"; if(st==="noshow") return;
    const key=`${a.date}#${a.serviceName}`;
    if(!map[key]) map[key]={date:a.date, service:a.serviceName, count:0, total:0};
    map[key].count++;
    map[key].total += Number(a.price||0);
  });
  const rows=Object.values(map).sort((a,b)=>a.date.localeCompare(b.date));
  reportListEl.innerHTML = rows.map(r=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${r.date} ‚Ä¢ ${r.service}</div>
        <div class="app-meta">${r.count} adet ‚Ä¢ ${r.total} ‚Ç∫</div>
      </div>
    </li>
  `).join("");
  updateAdminSummary();
}

function updateAdminSummary(){
  const t=todayStr();
  const todays=appointments.filter(a=>a.date===t && (a.status||"active")!=="noshow");
  let todayRev=0; todays.forEach(a=>todayRev+=Number(a.price||0));

  const valid=appointments.filter(a=>(a.status||"active")!=="noshow");
  let allRev=0; valid.forEach(a=>allRev+=Number(a.price||0));

  const now=new Date(); const jsDay=now.getDay(); const idx=(jsDay+6)%7;
  const activeBarbers=barbers.filter(b=>{
    const d=schedules[b.id]?.[idx];
    return d && d.active && d.intervals && d.intervals.length>0;
  }).length;

  sumTodayCountEl.textContent=todays.length;
  sumTodayRevenueEl.textContent=todayRev+" ‚Ç∫";
  sumAllCountEl.textContent=valid.length;
  sumAllRevenueEl.textContent=allRev+" ‚Ç∫";
  sumActiveBarberEl.textContent=activeBarbers;

  let topServiceId=null, topCount=0, sCounts={};
  valid.forEach(a=>{ if(a.serviceId) sCounts[a.serviceId]=(sCounts[a.serviceId]||0)+1; });
  Object.keys(sCounts).forEach(id=>{ if(sCounts[id]>topCount){ topCount=sCounts[id]; topServiceId=id; }});
  if(topServiceId){
    const svc=services.find(s=>s.id===topServiceId);
    sumTopServiceNameEl.textContent=svc?svc.name:"Bilinmiyor";
    sumTopServiceCountEl.textContent=topCount+" adet";
  }else{
    sumTopServiceNameEl.textContent="-"; sumTopServiceCountEl.textContent="0 adet";
  }

  let topBarberId=null, topBarberCount=0, bCounts={};
  valid.forEach(a=>{ if(a.barberId) bCounts[a.barberId]=(bCounts[a.barberId]||0)+1; });
  Object.keys(bCounts).forEach(id=>{ if(bCounts[id]>topBarberCount){ topBarberCount=bCounts[id]; topBarberId=id; }});
  if(topBarberId){
    const brb=barbers.find(b=>b.id===topBarberId);
    sumTopBarberNameEl.textContent=brb?brb.name:"Bilinmiyor";
    sumTopBarberCountEl.textContent=topBarberCount+" adet";
  }else{
    sumTopBarberNameEl.textContent="-"; sumTopBarberCountEl.textContent="0 adet";
  }
}

/* ===== Loyalty ===== */
function renderLoyalty(){
  if(!currentCustomer){ loyaltyPanel.style.display="none"; loyaltyText.textContent=""; return; }
  const pts=Number(currentCustomer.points||0);
  const cycle=pts%LOYALTY_TARGET;
  const remain=(LOYALTY_TARGET-cycle)%LOYALTY_TARGET;

  loyaltyPanel.style.display="block";
  let line1=`Toplam puanƒ±n: ${pts}`, line2="";
  if(pts===0) line2=`Her randevuda +1 puan. ${LOYALTY_TARGET} puanda 1 √ºcretsiz hizmet.`;
  else if(remain===0) line2=`Tebrikler! √úCRETSƒ∞Z HAK KAZANDINIZ.`;
  else line2=`${remain} puan sonra 1 √ºcretsiz hizmet hakkƒ± kazanƒ±rsƒ±n.`;

  loyaltyText.innerHTML=`${line1}<br>${line2}`;
}

/* ===== Admin Customers (soft delete) ===== */
async function fetchCustomersForAdmin(){
  try{
    const snap = await getDocs(col(COL.customers));
    return snap.docs.map(d=>({phone10:d.id, ...d.data()}));
  }catch(e){ return []; }
}
async function computeCustomerAgg(){
  const cust = await fetchCustomersForAdmin();
  const map={};
  cust.forEach(c=>{
    map[c.phone10]={customer:c, visits:0, spend:0, lastDate:null, cancelCount:0, segment:"Yeni"};
  });

  appointments.forEach(a=>{
    if(!a.phone10) return;
    if(!map[a.phone10]){
      map[a.phone10]={customer:{name:a.name||"M√º≈üteri", phone10:a.phone10, points:0}, visits:0, spend:0, lastDate:null, cancelCount:0, segment:"Yeni"};
    }
    const row=map[a.phone10];
    const st=a.status||"active";
    if(st==="noshow"){ row.cancelCount++; return; }
    row.visits++;
    row.spend+=Number(a.price||0);
    if(a.date && (!row.lastDate || a.date>row.lastDate)) row.lastDate=a.date;
  });

  const now=new Date();
  Object.values(map).forEach(row=>{
    const pts=Number(row.customer.points||0);
    let diff=Infinity;
    if(row.lastDate) diff=(now-parseLocalDate(row.lastDate))/86400000;

    if(pts>=30 || row.visits>=20 || row.spend>=5000) row.segment="VIP";
    else if(diff<=60 && row.visits>=3) row.segment="D√ºzenli";
    else if(diff>90 && row.visits>0) row.segment="Uzun S√ºredir Gelmeyen";
    else row.segment="Yeni";
  });

  const arr=Object.values(map).filter(r=>!r.customer.deleted)
    .sort((a,b)=>(b.lastDate||"0000-00-00").localeCompare(a.lastDate||"0000-00-00"));

  customerAgg=arr;
  return arr;
}
async function renderAdminCustomers(){
  const agg = await computeCustomerAgg();

  if(!agg.length){
    customerListEl.innerHTML = `<li class="app-item"><div class="app-main"><div class="app-title">Hen√ºz m√º≈üteri kaydƒ± yok.</div></div></li>`;
    customerDetailEl.style.display="none";
    customerDetailEl.innerHTML="";
    topCustomerListEl.innerHTML="";
    return;
  }

  customerListEl.innerHTML = agg.map(row=>{
    const c=row.customer;
    const seg=row.segment;
    let color="#60a5fa";
    if(seg==="VIP") color="#facc15";
    else if(seg==="D√ºzenli") color="#22c55e";
    else if(seg==="Uzun S√ºredir Gelmeyen") color="#f97373";

    const badge = `<span style="padding:2px 7px;border-radius:999px;font-size:10px;background:${color}22;color:${color};border:1px solid ${color}80;">${seg}</span>`;
    const phoneDisplay = c.phoneRaw || ("0"+c.phone10);

    return `
      <li class="app-item">
        <div class="app-main">
          <div class="app-title">${c.name||"M√º≈üteri"} ‚Ä¢ ${phoneDisplay}</div>
          <div class="app-meta">${row.visits} randevu ‚Ä¢ ${row.spend} ‚Ç∫ ‚Ä¢ Puan: ${Number(c.points||0)}</div>
          <div class="app-meta">Son gelme: ${row.lastDate || "-"} ${badge}</div>
        </div>
        <div class="app-actions">
          <button class="btn-mini note" onclick="window.openCustomerDetail('${c.phone10}')">Detay</button>
          <button class="btn-mini del" onclick="window.softDeleteCustomer('${c.phone10}')">Sil</button>
          <button class="btn-mini wp" onclick="window.sendWpTemplate('reminder','${phoneDisplay}','${encodeURIComponent(c.name||"")}')">Hatƒ±rlatma</button>
        </div>
      </li>
    `;
  }).join("");

  const top=[...agg].sort((a,b)=>b.visits-a.visits).slice(0,5);
  topCustomerListEl.innerHTML = top.map(row=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${row.customer.name||"M√º≈üteri"}</div>
        <div class="app-meta">${row.visits} randevu ‚Ä¢ ${row.spend} ‚Ç∫</div>
      </div>
    </li>
  `).join("");
}
window.openCustomerDetail=(phone10)=>{
  const row=customerAgg.find(r=>r.customer.phone10===phone10);
  if(!row){ customerDetailEl.style.display="none"; customerDetailEl.innerHTML=""; return; }

  const c=row.customer;
  const list = appointments
    .filter(a=>a.phone10===phone10)
    .sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time))
    .slice(0,10);

  const items = list.length ? list.map(a=>{
    const status=a.status==="noshow"?' ‚Ä¢ <span style="color:#f97373;">(Gelmedi)</span>':"";
    return `<li class="app-item"><div class="app-main">
      <div class="app-title">${a.date} ‚Ä¢ ${a.time}${status}</div>
      <div class="app-meta">${a.serviceName} ‚Ä¢ ${a.price} ‚Ç∫ ‚Ä¢ ${a.barberName}</div>
    </div></li>`;
  }).join("") : `<div class="helper">Bu m√º≈üteri i√ßin kayƒ±tlƒ± randevu bulunmuyor.</div>`;

  const phoneDisplay = c.phoneRaw || ("0"+c.phone10);

  customerDetailEl.style.display="block";
  customerDetailEl.innerHTML=`
    <div class="section-title" style="color:#e5e7eb;">${c.name||"M√º≈üteri"} ‚Ä¢ ${phoneDisplay}</div>
    <div class="helper">Toplam ${row.visits} randevu ‚Ä¢ ${row.spend} ‚Ç∫ ‚Ä¢ Puan: ${Number(c.points||0)}</div>
    <div class="helper">Segment: ${row.segment}</div>
    <div class="section-title" style="margin-top:8px;color:#e5e7eb;">Son Randevular</div>
    <ul class="app-list">${items}</ul>
  `;
};
window.softDeleteCustomer = async (phone10)=>{
  if(!isAdminLoggedIn){ showToast("Admin giri≈ü gerekli.","err"); return; }
  const ok = confirm("Bu m√º≈üteriyi silmek (gizlemek) istiyor musun? (Randevular silinmez)");
  if(!ok) return;
  try{
    await setDoc(dref(COL.customers, phone10), { deleted:true, deletedAt: serverTimestamp() }, {merge:true});
    showToast("M√º≈üteri silindi (gizlendi).","ok");
    await renderAdminCustomers();
  }catch(e){
    console.error(e);
    showToast("M√º≈üteri silme hatasƒ±.","err");
  }
};

/* ===== Customer UI ===== */
function refreshCustomerUI(){
  if(currentCustomer){
    customerLoggedBox.style.display="block";
    tabsRow.style.display="none";
    loginTab.style.display="none";
    registerTab.style.display="none";
    customerLoggedText.innerHTML=`Ho≈ü geldin <b>${currentCustomer.name||""}</b> ‚Ä¢ ${currentCustomer.phoneRaw||("0"+currentCustomer.phone10)}`;
    customerBtnLabel.textContent="M√º≈üteri Paneli";
    nameInput.value=currentCustomer.name||"";
    phoneInput.value=currentCustomer.phoneRaw||"";
    bookingHelper.textContent="Ho≈ü geldin, randevunu olu≈üturmak i√ßin tarih/saat se√ß.";
  }else{
    customerLoggedBox.style.display="none";
    tabsRow.style.display="flex";
    loginTab.style.display="block";
    registerTab.style.display="none";
    tabBtns.forEach(b=>b.classList.toggle("active",b.dataset.tab==="login"));
    bookingHelper.textContent="Randevu almak i√ßin √∂nce m√º≈üteri giri≈üi yapmalƒ±sƒ±n. M√º≈üteri panelinden kayƒ±t olabilirsin.";
  }
  waAutoToggle.checked = waAutoEnabled();
  renderMyAppointments();
  renderLoyalty();
}

/* ===== Strong lock (overlap) inside transaction ===== */
function txOverlapCheck(tx, dateVal, barberId, startMin, endMin, ignoreId=null){
  return (async ()=>{
    const qy = query(col(COL.apps), where("date","==",dateVal));
    const snap = await tx.get(qy);
    for(const docSnap of snap.docs){
      const a = docSnap.data() || {};
      const id = docSnap.id;
      if(ignoreId && id===ignoreId) continue;
      if(a.barberId !== barberId) continue;
      const aStart = timeToMinutes(a.time);
      const aEnd = aStart + getAppointmentMinutes(a);
      if(startMin < aEnd && aStart < endMin) return true;
    }
    return false;
  })();
}

/* ===== Create appointment (tx + points + overlap lock) ===== */
async function createAppointmentTx(app){
  const slotId = slotIdFor(app.date, app.barberId, app.time);
  const appRef = dref(COL.apps, slotId);
  const custRef = dref(COL.customers, app.phone10);

  await runTransaction(db, async (tx)=>{
    const existing = await tx.get(appRef);
    if(existing.exists()) throw new Error("SLOT_TAKEN");

    const custSnap = await tx.get(custRef);
    if(!custSnap.exists()) throw new Error("NO_CUSTOMER");

    const start = timeToMinutes(app.time);
    const end = start + getAppointmentMinutes(app);
    const hasOverlap = await txOverlapCheck(tx, app.date, app.barberId, start, end, null);
    if(hasOverlap) throw new Error("OVERLAP");

    const cust = custSnap.data()||{};
    const oldPts = Number(cust.points||0);
    const newPts = oldPts + 1;

    tx.set(appRef, {
      ...app,
      id: slotId,
      createdAt: serverTimestamp(),
      status:"active",
      notifyState: "pending" // (2) Cloud Functions otomasyonu i√ßin i≈üaret
    });

    tx.set(custRef, { points: newPts, updatedAt: serverTimestamp() }, {merge:true});
  });

  return slotId;
}

/* ===== (1) Update appointment: tarih/saat/berber + i≈ülem deƒüi≈ütirme ===== */
async function updateAppointmentTxExtended(oldId, newDate, newTime, newBarberId, newServiceId){
  const oldRef = dref(COL.apps, oldId);
  const newId = slotIdFor(newDate, newBarberId, newTime);
  const newRef = dref(COL.apps, newId);

  const newSvc = getServiceById(newServiceId);
  const newMinutes = Math.max(30, Number(newSvc?.duration||30));
  const newPrice = Number(newSvc?.price||0);
  const newServiceName = newSvc?.name || "ƒ∞≈ülem";

  await runTransaction(db, async(tx)=>{
    const oldSnap = await tx.get(oldRef);
    if(!oldSnap.exists()) throw new Error("OLD_MISSING");
    const data = oldSnap.data()||{};

    // yeni slot dolu mu?
    if(newId !== oldId){
      const newSnap = await tx.get(newRef);
      if(newSnap.exists()) throw new Error("SLOT_TAKEN");
    }

    // overlap (yeni s√ºre ile!)
    const start = timeToMinutes(newTime);
    const end = start + newMinutes;
    const hasOverlap = await txOverlapCheck(tx, newDate, newBarberId, start, end, oldId);
    if(hasOverlap) throw new Error("OVERLAP");

    const brb = barbers.find(b=>b.id===newBarberId);

    const updatedPayload = {
      ...data,
      id: newId,
      date: newDate,
      time: newTime,
      barberId: newBarberId,
      barberName: brb?brb.name:(data.barberName||"Berber"),
      serviceId: newServiceId,
      serviceName: newServiceName,
      price: newPrice,
      duration: newMinutes,
      totalMinutes: newMinutes,
      updatedAt: serverTimestamp(),
      notifyState: "pending_update" // (2) otomatik bildirim i√ßin i≈üaret
    };

    if(newId === oldId){
      tx.set(oldRef, updatedPayload, {merge:true});
    }else{
      tx.delete(oldRef);
      tx.set(newRef, updatedPayload);
    }
  });

  return newId;
}

/* ===== Message templates to shop ===== */
function buildShopMessage(kind, payload){
  const shopName = "Ahmet Tekeli Erkek Kuaf√∂r√º";
  if(kind==="book"){
    return `Merhaba ${shopName}, ben ${payload.name} (${payload.phoneRaw||("0"+payload.phone10)}).
${payload.date} ${payload.time} i√ßin "${payload.serviceName}" randevusu aldƒ±m.
Berber: ${payload.barberName}. √úcret: ${payload.price}‚Ç∫
Te≈üekk√ºrler.`;
  }
  if(kind==="update"){
    return `Merhaba ${shopName},
Randevumu g√ºncelledim:
Eski: ${payload.oldDate} ${payload.oldTime} ‚Ä¢ ${payload.oldBarberName} ‚Ä¢ ${payload.oldServiceName} (${payload.oldPrice}‚Ç∫)
Yeni: ${payload.newDate} ${payload.newTime} ‚Ä¢ ${payload.newBarberName} ‚Ä¢ ${payload.newServiceName} (${payload.newPrice}‚Ç∫)
ƒ∞sim: ${payload.name} (${payload.phoneRaw||("0"+payload.phone10)}).`;
  }
  if(kind==="cancel"){
    return `Merhaba ${shopName},
${payload.date} ${payload.time} tarihli randevumu iptal ettim.
ƒ∞sim: ${payload.name} (${payload.phoneRaw||("0"+payload.phone10)}).
ƒ∞yi √ßalƒ±≈ümalar.`;
  }
  return `Merhaba ${shopName}.`;
}

/* ===== Events ===== */
dateInput.addEventListener("change",renderSlots);
servSel.addEventListener("change",renderSlots);

btnBook.addEventListener("click", async ()=>{
  const name = nameInput.value.trim();
  const phoneRaw = phoneInput.value.trim();
  const phone10 = cleanPhone10(phoneRaw);
  const serviceId = servSel.value;
  const barberId = selectedBarberId || barbers[0]?.id || null;
  const dateVal = dateInput.value;
  const timeVal = selectedTime;

  if(!currentCustomer){ showToast("L√ºtfen √∂nce m√º≈üteri giri≈üi yap.","err"); return; }
  if(currentCustomer.phone10 !== phone10){
    showToast("Randevu i√ßin giri≈ü yaptƒ±ƒüƒ±n telefon ile aynƒ± telefonu yaz.","err");
    phoneInput.value = currentCustomer.phoneRaw||("0"+currentCustomer.phone10);
    return;
  }

  if(!name||!phone10||!serviceId||!barberId||!dateVal||!timeVal){
    showToast("L√ºtfen t√ºm alanlarƒ± doldur ve saat se√ß.","err"); return;
  }

  const avail = new Set(computeAvailableTimes(dateVal, barberId, serviceId, null));
  if(!avail.has(timeVal)){
    showToast("Se√ßtiƒüin saat artƒ±k uygun deƒüil. Ba≈üka saat se√ß.","err");
    renderSlots();
    return;
  }

  const svc=getServiceById(serviceId);
  const brb=barbers.find(b=>b.id===barberId);

  const dur=Math.max(30, Number(svc?.duration||30));
  const price=Number(svc?.price||0);

  const app={
    id:"",
    name,
    phone10,
    phoneRaw,
    date:dateVal,
    time:timeVal,
    serviceId,
    serviceName:svc?svc.name:"ƒ∞≈ülem",
    price,
    duration:dur,
    totalMinutes:dur,
    barberId,
    barberName:brb?brb.name:"Berber",
  };

  try{
    await createAppointmentTx(app);
    showQuickPopup(`${app.date} ${app.time} ‚Ä¢ ${app.barberName} ‚Ä¢ ${app.serviceName}`);
    showToast("Randevun olu≈üturuldu. (+1 puan)","ok");

    const msg = buildShopMessage("book", app);
    showMessageModal({
      title:"Randevu Onayƒ± ‚Ä¢ WhatsApp Mesajƒ±",
      hint:"Bu mesaj d√ºkk√¢na gider (hazƒ±r).",
      phone: SHOP_WA_NUMBER,
      text: msg,
      autoOpen: waAutoEnabled()
    });

  }catch(e){
    const m=String(e.message||"");
    if(m.includes("SLOT_TAKEN")){
      showToast("Bu saat az √∂nce alƒ±ndƒ±. Ba≈üka saat se√ß.","err");
      renderSlots();
    }else if(m.includes("OVERLAP")){
      showToast("Bu saat ba≈üka bir randevu ile √ßakƒ±≈üƒ±yor. Ba≈üka saat se√ß.","err");
      renderSlots();
    }else if(m.includes("NO_CUSTOMER")){
      showToast("M√º≈üteri kaydƒ± bulunamadƒ±.","err");
    }else{
      console.error(e);
      showToast("Kayƒ±t hatasƒ± (Rules/izin olabilir).","err");
    }
  }
});

/* ===== Customer modal ===== */
btnCustomerOpen.addEventListener("click",()=>{customerModal.style.display="flex";});
modalClose.addEventListener("click",()=>{customerModal.style.display="none";});
tabBtns.forEach(btn=>{
  btn.addEventListener("click",()=>{
    const t=btn.dataset.tab;
    tabBtns.forEach(b=>b.classList.toggle("active",b===btn));
    loginTab.style.display=t==="login"?"block":"none";
    registerTab.style.display=t==="register"?"block":"none";
  });
});

btnRegister.addEventListener("click", async ()=>{
  const name = regName.value.trim();
  const phoneRaw = regPhone.value.trim();
  const phone10 = cleanPhone10(phoneRaw);
  const pass = regPass.value.trim();

  if(!name||!phone10||!pass){ showToast("L√ºtfen t√ºm alanlarƒ± doldur.","err"); return; }
  if(pass.length<4){ showToast("≈ûifre en az 4 karakter olmalƒ±.","err"); return; }

  try{
    const ref = dref(COL.customers, phone10);
    const ex = await getDoc(ref);
    if(ex.exists()){ showToast("Bu telefon ile kayƒ±t zaten var.","err"); return; }

    const passHash = await sha256(PASS_SALT + pass);
    await setDoc(ref, {
      name, phone10, phoneRaw,
      passHash,
      points: 0,
      deleted:false,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });

    currentCustomer = { name, phone10, phoneRaw, points:0 };
    localStorage.setItem(LS_CURRENT_CUST, phone10);
    refreshCustomerUI();
    showToast("Kayƒ±t olu≈üturuldu, giri≈ü yapƒ±ldƒ±.","ok");
  }catch(e){
    console.error(e);
    showToast("Kayƒ±t hatasƒ± (Rules/izin olabilir).","err");
  }
});

btnLogin.addEventListener("click", async ()=>{
  const phoneRaw = loginPhone.value.trim();
  const phone10 = cleanPhone10(phoneRaw);
  const pass = loginPass.value.trim();

  if(!phone10||!pass){ showToast("Telefon ve ≈üifre gir.","err"); return; }

  try{
    const ref = dref(COL.customers, phone10);
    const snap = await getDoc(ref);
    if(!snap.exists()){ showToast("Kayƒ±t bulunamadƒ±.","err"); return; }

    const data = snap.data()||{};
    if(data.deleted){ showToast("Bu m√º≈üteri silinmi≈ü/gizlenmi≈ü.","err"); return; }

    const passHash = await sha256(PASS_SALT + pass);
    if(passHash !== data.passHash){ showToast("Telefon veya ≈üifre hatalƒ±.","err"); return; }

    currentCustomer = {
      name: data.name||"",
      phone10,
      phoneRaw: data.phoneRaw||("0"+phone10),
      points: Number(data.points||0),
    };
    localStorage.setItem(LS_CURRENT_CUST, phone10);
    refreshCustomerUI();
    showToast("Giri≈ü ba≈üarƒ±lƒ±.","ok");
  }catch(e){
    console.error(e);
    showToast("Giri≈ü hatasƒ± (Rules/izin olabilir).","err");
  }
});

btnCustomerLogout.addEventListener("click",()=>{
  currentCustomer=null;
  localStorage.removeItem(LS_CURRENT_CUST);
  refreshCustomerUI();
  showToast("M√º≈üteri √ßƒ±kƒ±≈ü yapƒ±ldƒ±.","ok");
});

/* ===== (1) Edit appointment: i≈ülem + berber + tarih + saat ===== */
window.openEditAppointment = (id)=>{
  const a = appointments.find(x=>x.id===id);
  if(!a){ showToast("Randevu bulunamadƒ±.","err"); return; }

  editingApp = a;
  editIgnoreId = a.id;
  editSelectedTime = null;

  editInfo.textContent = `${a.date} ${a.time} ‚Ä¢ ${a.barberName} ‚Ä¢ ${a.serviceName} (${a.price||0}‚Ç∫)`;
  editDate.value = a.date;

  editBarberSelect.value = a.barberId;
  editSelectedBarberId = a.barberId;

  editSelectedServiceId = a.serviceId;
  renderEditServiceOptions();
  editServiceSelect.value = editSelectedServiceId;

  updateEditPriceInfo();
  renderEditSlots();
  editModal.style.display="flex";
};

function updateEditPriceInfo(){
  if(!editingApp) return;
  const oldP = Number(editingApp.price||0);
  const newP = getServicePriceById(editSelectedServiceId);
  const diff = newP - oldP;
  const diffTxt = diff===0 ? "Fiyat farkƒ± yok." : (diff>0 ? `+${diff}‚Ç∫ fark` : `${diff}‚Ç∫ indirim`);
  const newMin = getServiceMinutesById(editSelectedServiceId);
  editPriceInfo.innerHTML = `Yeni √ºcret: <b>${newP}‚Ç∫</b> ‚Ä¢ S√ºre: <b>${newMin}dk</b> ‚Ä¢ ${diffTxt}`;
}

editBarberSelect.addEventListener("change",()=>{
  editSelectedBarberId = editBarberSelect.value;
  renderEditSlots();
});
editServiceSelect.addEventListener("change",()=>{
  editSelectedServiceId = editServiceSelect.value;
  updateEditPriceInfo();
  renderEditSlots();
});

function renderEditSlots(){
  editSlotGrid.innerHTML="";
  editSelectedTime=null;
  if(!editingApp) return;

  const newDate = editDate.value;
  const barberId = editSelectedBarberId || editingApp.barberId;
  const serviceId = editSelectedServiceId || editingApp.serviceId;

  if(!newDate){ editHelper.textContent="Tarih se√ß."; return; }
  if(closedDates.includes(newDate)){ editHelper.textContent="Bu tarih i√ßin d√ºkk√¢n kapalƒ±."; return; }

  const today=todayStr();
  if(newDate<today){ editHelper.textContent="Ge√ßmi≈ü tarihe alƒ±namaz."; return; }
  const diff=(parseLocalDate(newDate)-parseLocalDate(today))/86400000;
  if(diff>MAX_DAYS_AHEAD){ editHelper.textContent=`En fazla ${MAX_DAYS_AHEAD} g√ºn sonrasƒ±.`; return; }

  const avail = computeAvailableTimes(newDate, barberId, serviceId, editIgnoreId);
  const set = new Set(avail);

  const total = getServiceMinutesById(serviceId);
  const {daySch} = getDayScheduleFor(barberId, newDate);

  const btns=[];
  for(const t of SLOT_TIMES){
    const start=timeToMinutes(t);
    const end=start+total;
    if(!isWithinSchedule(daySch, start, end)) continue;
    const disabled = !set.has(t);
    btns.push(`<button type="button" class="slot ${disabled?"disabled":""}" data-time="${t}" ${disabled?"disabled":""}>${t}</button>`);
  }

  if(!btns.length){ editHelper.textContent="Uygun saat yok."; return; }
  editSlotGrid.innerHTML=btns.join("");

  Array.from(editSlotGrid.querySelectorAll(".slot")).forEach(btn=>{
    btn.addEventListener("click",()=>{
      Array.from(editSlotGrid.querySelectorAll(".slot")).forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");
      editSelectedTime=btn.getAttribute("data-time");
    });
  });

  const brb = barbers.find(b=>b.id===barberId);
  const svc = getServiceById(serviceId);
  editHelper.textContent = `Se√ßili: ${brb?brb.name:"Berber"} ‚Ä¢ ${svc?svc.name:"ƒ∞≈ülem"}`;
}

editDate.addEventListener("change",renderEditSlots);
editModalClose.addEventListener("click",()=>{ editModal.style.display="none"; });

btnSaveEdit.addEventListener("click", async ()=>{
  if(!currentCustomer){ showToast("Giri≈ü gerekli.","err"); return; }
  if(!editingApp){ showToast("Randevu yok.","err"); return; }
  if(editingApp.phone10 !== currentCustomer.phone10){ showToast("Bu randevu sana ait deƒüil.","err"); return; }

  const newDate = editDate.value;
  const newTime = editSelectedTime || editingApp.time; // kullanƒ±cƒ± saat se√ßmezse eski saat
  const newBarberId = editSelectedBarberId || editingApp.barberId;
  const newServiceId = editSelectedServiceId || editingApp.serviceId;

  if(!newDate || !newTime || !newBarberId || !newServiceId){ showToast("Yeni i≈ülem/berber/tarih/saat se√ß.","err"); return; }

  const isSame = (newDate===editingApp.date && newTime===editingApp.time && newBarberId===editingApp.barberId && newServiceId===editingApp.serviceId);
  if(isSame){ showToast("Zaten aynƒ± randevu.","err"); return; }

  const avail = new Set(computeAvailableTimes(newDate, newBarberId, newServiceId, editingApp.id));
  if(!avail.has(newTime)){
    showToast("Bu saat uygun deƒüil.","err");
    renderEditSlots();
    return;
  }

  const oldPayload = {
    oldDate: editingApp.date, oldTime: editingApp.time,
    oldBarberName: editingApp.barberName,
    oldServiceName: editingApp.serviceName,
    oldPrice: Number(editingApp.price||0),
    name: editingApp.name, phone10: editingApp.phone10, phoneRaw: editingApp.phoneRaw
  };

  try{
    await updateAppointmentTxExtended(editingApp.id, newDate, newTime, newBarberId, newServiceId);

    const newBarberName = (barbers.find(b=>b.id===newBarberId)?.name) || "Berber";
    const newSvc = getServiceById(newServiceId);
    const newServiceName = newSvc?.name || "ƒ∞≈ülem";
    const newPrice = Number(newSvc?.price||0);

    showToast("Randevu g√ºncellendi.","ok");
    showQuickPopup(`${newDate} ${newTime} ‚Ä¢ G√ºncellendi`);
    editModal.style.display="none";

    const msg = buildShopMessage("update", {
      ...oldPayload,
      newDate, newTime,
      newBarberName,
      newServiceName,
      newPrice
    });
    showMessageModal({
      title:"Randevu G√ºncelleme ‚Ä¢ WhatsApp Mesajƒ±",
      hint:"Bu mesaj d√ºkk√¢na gider (hazƒ±r).",
      phone: SHOP_WA_NUMBER,
      text: msg,
      autoOpen: waAutoEnabled()
    });

    editingApp=null;

  }catch(e){
    console.error(e);
    const m=String(e.message||"");
    if(m.includes("SLOT_TAKEN")){
      showToast("Bu saat az √∂nce alƒ±ndƒ±.","err");
      renderEditSlots();
    }else if(m.includes("OVERLAP")){
      showToast("Se√ßtiƒüin saat ba≈üka randevu ile √ßakƒ±≈üƒ±yor.","err");
      renderEditSlots();
    }else showToast("G√ºncelleme hatasƒ±.","err");
  }
});

/* ===== Admin ===== */
btnAdminOpen.addEventListener("click",()=>{adminModalEl.style.display="flex";});
adminModalClose.addEventListener("click",()=>{adminModalEl.style.display="none";});

btnAdminLogin.addEventListener("click",()=>{
  const phone=adminPhoneInput.value.trim(), pass=adminPassInput.value.trim();
  if(phone===ADMIN_PHONE && pass===ADMIN_PASS){
    isAdminLoggedIn=true; localStorage.setItem(LS_ADMIN,"1");
    adminLoginArea.style.display="none";
    adminPanelArea.style.display="block";
    adminBtnLabel.textContent="Admin Paneli";
    showToast("Admin giri≈ü ba≈üarƒ±lƒ±.","ok");
  }else showToast("Admin bilgileri hatalƒ±.","err");
});

btnAdminLogout.addEventListener("click",()=>{
  isAdminLoggedIn=false; localStorage.removeItem(LS_ADMIN);
  adminLoginArea.style.display="block";
  adminPanelArea.style.display="none";
  adminBtnLabel.textContent="Admin Giri≈üi";
  showToast("Admin √ßƒ±kƒ±≈ü yapƒ±ldƒ±.","ok");
});

adminTabBtns.forEach(btn=>{
  btn.addEventListener("click",()=>{
    const id=btn.dataset.adminSection;
    adminTabBtns.forEach(b=>b.classList.toggle("active",b===btn));
    adminSections.forEach(sec=>sec.classList.toggle("active",sec.id===id));
    if(id==="adminSectionMusteri") renderAdminCustomers();
    if(id==="adminSectionTakvim") renderAdminCalendar();
  });
});

adminDateFilter.addEventListener("change",renderAdminAppointments);
adminBarberFilter.addEventListener("change",renderAdminAppointments);

/* Hizmet ekle */
btnAddService.addEventListener("click", async ()=>{
  const name=newServiceNameEl.value.trim();
  const price=Number(newServicePriceEl.value||0);
  const dur=Number(newServiceDurationEl.value||0);

  if(!name||!dur){ showToast("Hizmet adƒ± ve s√ºre gir.","err"); return; }
  if(dur<30 || dur%30!==0){ showToast("S√ºre 30'un katƒ± olmalƒ± (30/60/90...).","err"); return; }

  const id="svc_"+Date.now();
  try{
    await setDoc(dref(COL.services, id), { id, name, price, duration:dur });
    newServiceNameEl.value=""; newServicePriceEl.value=""; newServiceDurationEl.value="";
    showToast("Hizmet eklendi.","ok");
  }catch(e){
    console.error(e);
    showToast("Hizmet ekleme hatasƒ± (Rules/izin).","err");
  }
});
window.deleteService = async (id)=>{
  try{ await deleteDoc(dref(COL.services, id)); showToast("Hizmet silindi.","ok"); }
  catch(e){ console.error(e); showToast("Silme hatasƒ±","err"); }
};

/* Berber ekle */
btnAddBarber.addEventListener("click", async ()=>{
  const name=newBarberNameEl.value.trim();
  if(!name){ showToast("Berber adƒ± gir.","err"); return; }

  let photo=null;
  const f=newBarberPhotoFileEl.files?.[0];
  if(f){ try{ photo = await resizeImageToDataURL(f, 256, 0.78); }catch(e){} }

  const id="brb_"+Date.now();
  try{
    await setDoc(dref(COL.barbers, id), { id, name, photo: photo||null });
    await setDoc(dref(COL.schedules, id), { barberId:id, days:createDefaultSchedule() });
    newBarberNameEl.value=""; newBarberPhotoFileEl.value="";
    selectedBarberId=id;
    showToast("Berber eklendi.","ok");
  }catch(e){
    console.error(e);
    showToast("Berber ekleme hatasƒ± (Rules/izin).","err");
  }
});
window.deleteBarber = async (id)=>{
  try{
    await deleteDoc(dref(COL.barbers, id));
    await deleteDoc(dref(COL.schedules, id));
    if(selectedBarberId===id) selectedBarberId = barbers[0]?.id||null;
    showToast("Berber silindi.","ok");
  }catch(e){
    console.error(e);
    showToast("Silme hatasƒ±","err");
  }
};

/* Kapalƒ± g√ºnler */
btnAddClosedDate.addEventListener("click", async ()=>{
  const d=closedDateInput.value;
  if(!d) return;
  try{
    await setDoc(dref(COL.closed, d), { date:d, createdAt: serverTimestamp() });
    showToast("Kapalƒ± g√ºn eklendi.","ok");
  }catch(e){
    console.error(e);
    showToast("Kapalƒ± g√ºn ekleme hatasƒ±","err");
  }
});
window.deleteClosedDate = async (d)=>{
  try{ await deleteDoc(dref(COL.closed, d)); showToast("Kapalƒ± g√ºn silindi.","ok"); }
  catch(e){ console.error(e); showToast("Silme hatasƒ±","err"); }
};

/* randevu sil / iptal */
async function deleteAppointmentById(id, source="admin"){
  try{
    const app = appointments.find(a=>a.id===id) || null;
    await deleteDoc(dref(COL.apps, id));
    showToast(source==="customer"?"Randevun iptal edildi.":"Randevu silindi.","ok");

    // (2) otomasyon i√ßin iptal i≈üareti (Cloud Functions onDelete ile de yakalanƒ±r)
    if(source==="customer" && app && currentCustomer && app.phone10===currentCustomer.phone10){
      const msg = buildShopMessage("cancel", app);
      showMessageModal({
        title:"Randevu ƒ∞ptal ‚Ä¢ WhatsApp Mesajƒ±",
        hint:"Bu mesaj d√ºkk√¢na gider (hazƒ±r).",
        phone: SHOP_WA_NUMBER,
        text: msg,
        autoOpen: waAutoEnabled()
      });
    }
  }catch(e){
    console.error(e);
    showToast("Silme hatasƒ± (Rules/izin).","err");
  }
}
window.deleteAppointment = (id)=>deleteAppointmentById(id,"admin");
window.cancelMyAppointment = (id)=>deleteAppointmentById(id,"customer");

window.markNoShow = async (id)=>{
  try{
    await setDoc(dref(COL.apps, id), { status:"noshow", notifyState:"pending_noshow" }, {merge:true});
    showToast("Randevu 'gelmedi' olarak i≈üaretlendi.","ok");
    renderAdminCalendar();
  }catch(e){
    console.error(e);
    showToast("ƒ∞≈üaretleme hatasƒ±","err");
  }
};

/* WhatsApp admin */
window.sendWp=(phone,msg)=>{
  const clean=String(phone||"").replace(/\D/g,"").slice(-10);
  const url=`https://wa.me/90${clean}?text=${msg}`;
  window.open(url,"_blank");
};
window.sendWpTemplate=(type,phone,nameEnc)=>{
  const name = decodeURIComponent(nameEnc || "");
  let text = "";
  if(type==="reminder"){
    text=`Merhaba ${name||""}, Ahmet Tekeli Erkek Kuaf√∂r√º'nden yazƒ±yoruz. Randevunuzu hatƒ±rlatmak istedik. Gelemeyecekseniz l√ºtfen √∂nceden bilgi verin.`;
  }else text=`Merhaba ${name||""}, Ahmet Tekeli Erkek Kuaf√∂r√º'nden yazƒ±yorum.`;
  const clean=String(phone||"").replace(/\D/g,"").slice(-10);
  const url=`https://wa.me/90${clean}?text=${encodeURIComponent(text)}`;
  window.open(url,"_blank");
};

/* PDF */
btnPrintReports.addEventListener("click",()=>{
  adminTabBtns.forEach(b=>b.classList.remove("active"));
  document.querySelector('[data-admin-section="adminSectionRapor"]').classList.add("active");
  adminSections.forEach(sec=>sec.classList.toggle("active",sec.id==="adminSectionRapor"));
  window.print();
});
btnPrintAppointments.addEventListener("click",()=>{
  adminTabBtns.forEach(b=>b.classList.remove("active"));
  document.querySelector('[data-admin-section="adminSectionRandevu"]').classList.add("active");
  adminSections.forEach(sec=>sec.classList.toggle("active",sec.id==="adminSectionRandevu"));
  window.print();
});

/* Bug√ºn √∂zet */
btnCopyTodaySummary.addEventListener("click",()=>{
  const t=todayStr();
  const todays=appointments.filter(a=>a.date===t && (a.status||"active")!=="noshow");
  let rev=0; todays.forEach(a=>rev+=Number(a.price||0));
  const sCounts={},bCounts={};
  todays.forEach(a=>{
    if(a.serviceName)sCounts[a.serviceName]=(sCounts[a.serviceName]||0)+1;
    if(a.barberName)bCounts[a.barberName]=(bCounts[a.barberName]||0)+1;
  });
  let topSvc="-",topSvcCount=0;
  Object.keys(sCounts).forEach(n=>{if(sCounts[n]>topSvcCount){topSvcCount=sCounts[n];topSvc=n;}});
  let topBar="-",topBarCount=0;
  Object.keys(bCounts).forEach(n=>{if(bCounts[n]>topBarCount){topBarCount=bCounts[n];topBar=n;}});

  const text=
`Bug√ºn Ahmet Tekeli Erkek Kuaf√∂r√º'nde toplam ${todays.length} randevu tamamlandƒ±.
Toplam ciro: ${rev} ‚Ç∫.
En √ßok tercih edilen i≈ülem: ${topSvc}${topSvc!=="-"?" ("+topSvcCount+" adet)":""}.
En √ßok randevu alan berber: ${topBar}${topBar!=="-"?" ("+topBarCount+" adet)":""}.

üíà Online randevu i√ßin profilimizdeki linke tƒ±kla.`;

  if(navigator.clipboard?.writeText){
    navigator.clipboard.writeText(text).then(()=>showToast("Bug√ºn √∂zeti panoya kopyalandƒ±.","ok"))
      .catch(()=>{showToast("Kopyalama desteklenmiyor.","err");alert(text);});
  }else{ showToast("Kopyalama desteklenmiyor.","err"); alert(text); }
});

/* Schedule modal */
scheduleModalClose.addEventListener("click",()=>{scheduleModal.style.display="none";});
window.openSchedule=(id)=>{
  currentScheduleBarberId=id;
  const brb=barbers.find(b=>b.id===id);
  if(!brb) return;
  scheduleModalTitle.textContent=`${brb.name} ‚Ä¢ √áalƒ±≈üma Saatleri`;

  const sch = Array.isArray(schedules[id]) ? schedules[id] : createDefaultSchedule();
  scheduleWrapper.innerHTML="";

  for(let i=0;i<7;i++){
    const d=sch[i]||{active:(i<6),intervals:[{start:"09:00",end:"19:00"}]};
    const intervalsHtml=(d.intervals||[]).map(it=>`
      <div class="schedule-interval">
        <select data-role="start">${SLOT_TIMES.map(t=>`<option value="${t}" ${t===it.start?"selected":""}>${t}</option>`).join("")}</select>
        <select data-role="end">${SLOT_TIMES.map(t=>`<option value="${t}" ${t===it.end?"selected":""}>${t}</option>`).join("")}</select>
        <button type="button" onclick="this.closest('.schedule-interval').remove()">Sil</button>
      </div>
    `).join("");

    scheduleWrapper.insertAdjacentHTML("beforeend",`
      <div class="schedule-row" data-day-index="${i}">
        <div class="schedule-row-head">
          <div class="schedule-day-name">${DAY_NAMES[i]}</div>
          <label class="day-active-label">
            <input type="checkbox" ${d.active?"checked":""}>Aktif
          </label>
        </div>
        <div class="schedule-intervals">${intervalsHtml}</div>
        <button class="btn-add-interval" type="button">Aralƒ±k Ekle</button>
      </div>
    `);
  }

  Array.from(scheduleWrapper.querySelectorAll(".btn-add-interval")).forEach(btn=>{
    btn.addEventListener("click",()=>{
      const container=btn.closest(".schedule-row").querySelector(".schedule-intervals");
      container.insertAdjacentHTML("beforeend",`
        <div class="schedule-interval">
          <select data-role="start">${SLOT_TIMES.map(t=>`<option value="${t}">${t}</option>`).join("")}</select>
          <select data-role="end">${SLOT_TIMES.map(t=>`<option value="${t}">${t}</option>`).join("")}</select>
          <button type="button" onclick="this.closest('.schedule-interval').remove()">Sil</button>
        </div>
      `);
    });
  });

  scheduleModal.style.display="flex";
};

btnSaveSchedule.addEventListener("click", async ()=>{
  if(!currentScheduleBarberId) return;
  const sch=[];
  for(let i=0;i<7;i++){
    const dayRow=scheduleWrapper.querySelector(`[data-day-index="${i}"]`);
    const active=dayRow.querySelector("input[type=checkbox]").checked;
    const intervalEls=dayRow.querySelectorAll(".schedule-interval");
    const intervals=[];
    intervalEls.forEach(row=>{
      const s=row.querySelector("select[data-role=start]").value;
      const e=row.querySelector("select[data-role=end]").value;
      if(s && e && s<e) intervals.push({start:s,end:e});
    });
    sch.push({active, intervals});
  }
  try{
    await setDoc(dref(COL.schedules, currentScheduleBarberId), { barberId:currentScheduleBarberId, days:sch }, {merge:true});
    scheduleModal.style.display="none";
    showToast("√áalƒ±≈üma saatleri kaydedildi.","ok");
    setSelectedBarber(currentScheduleBarberId);
    renderAdminCalendar();
  }catch(e){
    console.error(e);
    showToast("Kaydetme hatasƒ± (Rules/izin).","err");
  }
});

/* Reset local */
btnResetData.addEventListener("click",()=>{
  localStorage.removeItem(LS_ADMIN);
  localStorage.removeItem(LS_CURRENT_CUST);
  showToast("Bu cihazdaki oturum temizlendi.","ok");
  setTimeout(()=>location.reload(),800);
});

/* ===== (3) Admin Takvim G√ºn G√∂r√ºn√ºm√º ===== */
const CAL_CELL_H = 28;
function renderCalTimeColumn(){
  calTimes.innerHTML = SLOT_TIMES.map((t,i)=>{
    // sadece saat ba≈ülarƒ±nda label gibi g√∂r√ºns√ºn
    const label = t.endsWith(":00") ? t : "";
    return `<div class="cal-time-row">${label}</div>`;
  }).join("");
}
function getColorSeed(str){
  // basit deterministic renk tonu (hsl) -> arka planƒ± zaten koyu
  let h=0;
  for(let i=0;i<str.length;i++) h=(h*31 + str.charCodeAt(i))%360;
  return h;
}
function renderAdminCalendar(){
  const dateVal = adminCalDate.value || todayStr();
  if(!adminCalDate.value) adminCalDate.value = dateVal;

  renderCalTimeColumn();

  // barbers columns
  const cols = barbers.length ? barbers : [];
  const innerCols = cols.map(b=>{
    const initials=(b.name||"B").split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase();
    const avatar = b.photo ? `<img src="${b.photo}" style="width:22px;height:22px;border-radius:999px;object-fit:cover;">` : `<div style="width:22px;height:22px;border-radius:999px;background:rgba(250,204,21,.15);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:900;color:#facc15;border:1px solid rgba(250,204,21,.35);">${initials}</div>`;
    return `
      <div class="cal-col" data-bid="${b.id}">
        <div class="cal-col-head">
          ${avatar}
          <div>${b.name}</div>
        </div>
        <div class="cal-col-body" style="height:${SLOT_TIMES.length*CAL_CELL_H}px;">
          ${SLOT_TIMES.map(()=>`<div class="cal-slot"></div>`).join("")}
        </div>
      </div>
    `;
  }).join("");

  calCols.innerHTML = `<div class="cal-cols-inner" style="grid-template-columns:repeat(${Math.max(1,cols.length)}, minmax(180px, 1fr));">${innerCols}</div>`;

  // events
  const todays = appointments.filter(a=>a.date===dateVal);
  for(const a of todays){
    const colEl = calCols.querySelector(`.cal-col[data-bid="${a.barberId}"] .cal-col-body`);
    if(!colEl) continue;

    const startMin = timeToMinutes(a.time);
    const idx = SLOT_TIMES.findIndex(t=>timeToMinutes(t)===startMin);
    if(idx<0) continue;

    const dur = getAppointmentMinutes(a);
    const h = Math.max(1, Math.round(dur/30)) * CAL_CELL_H - 4;
    const top = idx*CAL_CELL_H + 2;

    const status = (a.status||"active");
    const cls = status==="noshow" ? "cal-event noshow" : "cal-event";
    const svc = a.serviceName || "";
    const nm = a.name || "";
    const t2 = `${a.time} ‚Ä¢ ${svc} ‚Ä¢ ${a.price||0}‚Ç∫`;

    // barber bazlƒ± hafif border tonu
    const hue = getColorSeed(a.barberId||"x");
    const style = status==="noshow"
      ? ""
      : `border-color: hsla(${hue}, 90%, 60%, .55); background: linear-gradient(135deg, hsla(${hue},90%,60%,.18), rgba(2,6,23,.08));`;

    const div = document.createElement("div");
    div.className = cls;
    div.style.top = top+"px";
    div.style.height = h+"px";
    div.style.cssText += style;

    div.innerHTML = `<div class="t1">${nm}</div><div class="t2">${t2}</div>`;
    div.title = `${a.date} ${a.time} ‚Ä¢ ${a.barberName} ‚Ä¢ ${a.serviceName}`;
    div.addEventListener("click",()=>{
      // quick action
      const phone = a.phoneRaw || ("0"+a.phone10);
      const act = prompt(
`Se√ßim:
1 = Sil
2 = Gelmedi (NoShow)
3 = WhatsApp (M√º≈üteri)
4 = Takvime Ekle

Randevu: ${a.time} ‚Ä¢ ${a.serviceName} ‚Ä¢ ${a.name}`,
""
      );
      if(act==="1") { if(confirm("Silinsin mi?")) window.deleteAppointment(a.id); }
      else if(act==="2") window.markNoShow(a.id);
      else if(act==="3"){
        const text = `Merhaba ${a.name||""}, Ahmet Tekeli Erkek Kuaf√∂r√º'nden yazƒ±yoruz. Randevunuz: ${a.date} ${a.time} (${a.serviceName}).`;
        window.sendWp(phone, encodeURIComponent(text));
      }
      else if(act==="4") downloadICSFor(a);
    });

    colEl.appendChild(div);
  }
}
adminCalDate.addEventListener("change",renderAdminCalendar);

/* ===== Admin customers open tab ===== */
function renderAll(){
  renderServices();
  renderBarbers();
  renderSlots();
  renderAdminAppointments();
  renderMyAppointments();
  renderReports();
  renderAdminCalendar();
  if(document.getElementById("adminSectionMusteri").classList.contains("active")) renderAdminCustomers();
  renderClosedDateList();
  renderLoyalty();
}

/* ===== Session restore ===== */
async function restoreSession(){
  isAdminLoggedIn = localStorage.getItem(LS_ADMIN)==="1";
  const phone10 = localStorage.getItem(LS_CURRENT_CUST);
  if(phone10){
    try{
      const snap = await getDoc(dref(COL.customers, phone10));
      if(snap.exists()){
        const d=snap.data()||{};
        if(!d.deleted){
          currentCustomer = { name:d.name||"", phone10, phoneRaw:d.phoneRaw||("0"+phone10), points:Number(d.points||0) };
        }
      }
    }catch(e){}
  }
}

/* init */
async function init(){
  dateInput.value = todayStr();
  adminDateFilter.value = todayStr();
  adminCalDate.value = todayStr();
  localStorage.setItem(LS_WA_AUTO, localStorage.getItem(LS_WA_AUTO) || "0");

  await restoreSession();

  if(isAdminLoggedIn){
    adminLoginArea.style.display="none";
    adminPanelArea.style.display="block";
    adminBtnLabel.textContent="Admin Paneli";
  }

  refreshCustomerUI();

  try{ await seedIfEmpty(); }
  catch(e){ console.error(e); showToast("Firestore izin/Rules sorunu olabilir.","err"); }

  startRealtime();
}
init();
</script>
</body>
</html>
