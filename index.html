<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Ahmet Tekeli Kuaf√∂r ‚Ä¢ Online Randevu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#e5e7eb;
      --glass-bg:rgba(255,255,255,0.65);
      --glass-border:rgba(148,163,184,0.4);
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#d4af37;
      --danger:#ef4444;
      --ok:#16a34a;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    html,body{
      height:100%;
      font:15px/1.5 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--ink);
    }

    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:10px 16px 16px;
    }

    .bg{
      position:fixed;
      inset:0;
      z-index:-2;
      background:
        radial-gradient(circle at 0 0,rgba(212,175,55,.18),transparent 45%),
        radial-gradient(circle at 100% 0,rgba(148,163,184,.35),transparent 55%),
        linear-gradient(135deg,#e5e7eb,#f9fafb);
    }

    /* TOPBAR */
    .topbar{
      width:100%;
      max-width:960px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      z-index:1;
    }
    .top-title{
      font-size:13px;
      font-weight:600;
      color:var(--muted);
    }
    .top-right{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .top-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(248,250,252,.9);
      font-size:12px;
      padding:4px 9px;
      cursor:pointer;
    }
    .top-btn:hover{background:white}

    .bell{
      position:relative;
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(248,250,252,.9);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .bell-count{
      position:absolute;
      top:-4px;
      right:-4px;
      min-width:16px;
      height:16px;
      border-radius:999px;
      background:var(--danger);
      color:#fff;
      font-size:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 3px;
    }
    .bell-alert{
      animation:ring 0.4s ease-in-out 3;
    }
    @keyframes ring{
      0%{transform:rotate(0deg);}
      25%{transform:rotate(-10deg);}
      50%{transform:rotate(8deg);}
      75%{transform:rotate(-6deg);}
      100%{transform:rotate(0deg);}
    }

    .hidden{display:none!important}

    .wrap{
      width:100%;
      max-width:960px;
      display:grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1fr);
      gap:18px;
    }

    @media (max-width:900px){
      body{align-items:flex-start}
      .wrap{grid-template-columns:1fr;margin-top:4px}
    }

    .card{
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      border-radius:18px;
      backdrop-filter:blur(18px);
      -webkit-backdrop-filter:blur(18px);
      box-shadow:0 18px 40px rgba(15,23,42,.12);
      padding:18px 18px 20px;
    }

    .hero{
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:100%;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.04);
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .badge-dot{
      width:8px;height:8px;border-radius:999px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }

    h1{
      font-size:26px;
      line-height:1.2;
      letter-spacing:-.03em;
      margin-bottom:6px;
    }
    .hero-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:16px;
    }

    .hero-footer{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      font-size:12px;
      color:var(--muted);
    }
    .hero-pill{
      padding:4px 10px;
      border-radius:999px;
      border:1px dashed rgba(148,163,184,.6);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .hero-pill strong{color:var(--ink);font-weight:600}

    /* FORM */
    .form-title{
      font-size:15px;
      font-weight:600;
      margin-bottom:10px;
    }
    form{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px 12px;
    }
    @media (max-width:640px){
      form{grid-template-columns:1fr}
    }

    label{
      font-size:12px;
      font-weight:500;
      color:var(--muted);
      margin-bottom:4px;
      display:block;
    }

    input,select,textarea{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.7);
      padding:8px 9px;
      font:inherit;
      background:rgba(255,255,255,.8);
      outline:none;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(212,175,55,.6);
      background:#fff;
    }

    textarea{min-height:60px;resize:vertical}

    .field-span-2{grid-column:1/3}
    @media (max-width:640px){
      .field-span-2{grid-column:1/2}
    }

    button{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font:600 14px/1 "Inter",system-ui;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      background:linear-gradient(135deg,#d4af37,#facc15);
      color:#111827;
      box-shadow:0 10px 25px rgba(180,137,0,.35);
      transition:transform .12s, box-shadow .12s, filter .12s;
    }
    button:hover{transform:translateY(-1px);filter:brightness(1.03)}
    button:active{transform:translateY(0);box-shadow:0 4px 12px rgba(180,137,0,.4)}

    .btn-secondary{
      background:rgba(15,23,42,.06);
      color:var(--muted);
      box-shadow:none;
    }
    .btn-secondary:hover{filter:none;transform:none;background:rgba(15,23,42,.08)}

    .btn-row{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:4px;
      grid-column:1/3;
    }
    @media (max-width:640px){
      .btn-row{grid-column:1/2}
    }

    /* LISTE KARTI */
    .list-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:12px;
    }
    .list-title{
      font-size:15px;
      font-weight:600;
    }
    .list-sub{font-size:12px;color:var(--muted)}

    .today-chip{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(255,255,255,.9);
    }

    .count-badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(22,163,74,.08);
      color:#166534;
      border:1px solid rgba(34,197,94,.35);
    }

    .app-list{
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:320px;
      overflow:auto;
    }

    .empty{
      font-size:13px;
      color:var(--muted);
      padding:10px;
      border-radius:12px;
      background:rgba(248,250,252,.8);
      border:1px dashed rgba(148,163,184,.6);
    }

    .app-item{
      padding:9px 10px;
      border-radius:12px;
      background:rgba(248,250,252,.95);
      border:1px solid rgba(229,231,235,0.9);
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:13px;
    }

    .app-main{display:flex;flex-direction:column;gap:2px}
    .app-name{font-weight:600}
    .app-meta{color:var(--muted);font-size:12px}

    .app-tag{
      font-size:11px;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(15,23,42,.03);
      border:1px solid rgba(148,163,184,.6);
      align-self:flex-start;
    }

    /* ADMIN PANEL */
    .admin-card{
      margin-top:16px;
      width:100%;
      max-width:960px;
    }
    .admin-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .admin-tabs{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      font-size:12px;
    }
    .admin-tab{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(248,250,252,.9);
      cursor:pointer;
    }
    .admin-tab.active{
      border-color:var(--brand);
      background:linear-gradient(135deg,#fefce8,#fef9c3);
    }
    .admin-section{display:none;margin-top:6px;font-size:13px}
    .admin-section.active{display:block}

    .inline-form{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
    }
    .inline-form input{
      width:auto;
      min-width:120px;
    }
    .pill-danger{
      background:#fee2e2;
      color:#b91c1c;
      border-color:#fecaca;
    }
    .small-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:6px;
    }
    .small-table th,
    .small-table td{
      border:1px solid #e5e7eb;
      padding:4px 6px;
      text-align:left;
      white-space:nowrap;
    }
    .small-table th{
      background:#f9fafb;
      font-weight:600;
    }
    .small-table tbody tr:nth-child(even){
      background:#f9fafb;
    }

    /* TOAST */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%) translateY(120%);
      min-width:220px;
      max-width:320px;
      padding:10px 12px;
      border-radius:999px;
      background:#111827;
      color:#e5e7eb;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 16px 30px rgba(15,23,42,.5);
      opacity:0;
      pointer-events:none;
      transition:transform .25s ease, opacity .25s ease;
      z-index:20;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
      pointer-events:auto;
    }
    .toast-dot{
      width:8px;height:8px;border-radius:999px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
    }
  </style>
</head>
<body>
  <div class="bg"></div>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="top-title">Ahmet Tekeli Erkek Kuaf√∂r√º ‚Ä¢ Randevu Sistemi</div>
    <div class="top-right">
      <button class="top-btn" id="adminLoginBtn">Admin giri≈üi</button>
      <button class="top-btn hidden" id="adminLogoutBtn">√áƒ±kƒ±≈ü</button>
      <div class="bell hidden" id="bell">
        <span>üîî</span>
        <span class="bell-count hidden" id="bellCount">0</span>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- SOL: HERO + FORM -->
    <section class="card hero">
      <div>
        <div class="badge">
          <span class="badge-dot"></span>
          Bug√ºn sa√ß-sakalƒ±nƒ±zƒ± garantiye alƒ±n
        </div>
        <h1>Ahmet Tekeli Erkek Kuaf√∂r√º<br>Online Randevu</h1>
        <p class="hero-sub">
          Koltuk beklemeden, VIP cam efektli sistemle randevunuzu alƒ±n. 
          Saat se√ßin, isminiz listede hazƒ±r olsun.
        </p>

        <p class="form-title">Randevu olu≈ütur</p>
        <form id="apptForm">
          <div>
            <label for="name">Ad Soyad</label>
            <input id="name" name="name" autocomplete="name" required>
          </div>
          <div>
            <label for="phone">Telefon</label>
            <input id="phone" name="phone" inputmode="tel" placeholder="05xx..." required>
          </div>

          <div>
            <label for="date">Tarih</label>
            <input id="date" name="date" type="date" required>
          </div>
          <div>
            <label for="time">Saat</label>
            <input id="time" name="time" type="time" required>
          </div>

          <div class="field-span-2">
            <label for="service">Hizmet</label>
            <select id="service" name="service" required>
              <option value="">Se√ßiniz</option>
              <!-- Hizmetler admin panelinden Firestore'dan doldurulacak -->
            </select>
          </div>

          <div class="field-span-2">
            <label for="note">Not (isteƒüe baƒülƒ±)</label>
            <textarea id="note" name="note" placeholder="√ñrn: Acil √ßƒ±kmam lazƒ±m, ince kesim olsun..."></textarea>
          </div>

          <div class="btn-row">
            <button type="submit">Randevu Al</button>
            <button type="button" class="btn-secondary" id="todayBtn">
              Bug√ºnk√º randevularƒ± yenile
            </button>
          </div>
        </form>
      </div>

      <div class="hero-footer">
        <div class="hero-pill">
          üíà <strong>Ahmet Tekeli Kuaf√∂r</strong> ‚Ä¢ Altƒ±noluk
        </div>
        <div class="hero-pill">
          ‚è± Ortalama i≈ülem s√ºresi: <strong>30‚Äì45 dk</strong>
        </div>
      </div>
    </section>

    <!-- SAƒû: BUG√úNK√ú RANDEVULAR -->
    <section class="card">
      <div class="list-header">
        <div>
          <div class="list-title">Bug√ºnk√º Randevular</div>
          <div class="list-sub" id="todayLabel"></div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <span class="today-chip" id="todayDateChip"></span>
          <span class="count-badge" id="todayCountChip">0 randevu</span>
        </div>
      </div>

      <ul class="app-list" id="apptList">
        <li class="empty">Bug√ºn i√ßin kayƒ±tlƒ± randevu bulunmuyor.</li>
      </ul>
    </section>
  </div>

  <!-- ADMIN PANEL (SADECE ADMIN) -->
  <section class="card admin-card hidden" id="adminPanel">
    <div class="admin-header">
      <div class="list-title">Admin Paneli</div>
      <div class="admin-tabs">
        <button class="admin-tab active" data-tab="services">Hizmetler</button>
        <button class="admin-tab" data-tab="barbers">Berberler</button>
        <button class="admin-tab" data-tab="reports">Randevu Raporu</button>
      </div>
    </div>

    <!-- Hizmetler -->
    <div class="admin-section active" id="section-services">
      <p style="font-size:12px;color:var(--muted);margin-bottom:6px">
        Buradan randevu sƒ±rasƒ±nda se√ßilecek hizmetleri ekleyip silebilirsin.
      </p>
      <div class="inline-form">
        <input id="svcName" placeholder="Hizmet adƒ± (Sa√ß + Sakal)">
        <input id="svcDuration" type="number" min="5" step="5" placeholder="S√ºre (dk)">
        <input id="svcPrice" type="number" min="0" step="5" placeholder="Fiyat (‚Ç∫)">
        <button type="button" id="svcAddBtn">Hizmet Ekle</button>
      </div>
      <table class="small-table" id="svcTable">
        <thead>
          <tr>
            <th>Ad</th><th>S√ºre</th><th>Fiyat</th><th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Hizmet satƒ±rlarƒ± -->
        </tbody>
      </table>
    </div>

    <!-- Berberler -->
    <div class="admin-section" id="section-barbers">
      <p style="font-size:12px;color:var(--muted);margin-bottom:6px">
        Berber listesini y√∂net. (≈ûimdilik randevulara baƒülamƒ±yoruz, sadece kayƒ±t ama√ßlƒ±.)
      </p>
      <div class="inline-form">
        <input id="barberName" placeholder="Berber adƒ±">
        <button type="button" id="barberAddBtn">Berber Ekle</button>
      </div>
      <table class="small-table" id="barberTable">
        <thead>
          <tr>
            <th>Ad</th><th></th>
          </tr>
        </thead>
        <tbody>
          <!-- Berber satƒ±rlarƒ± -->
        </tbody>
      </table>
    </div>

    <!-- Raporlar -->
    <div class="admin-section" id="section-reports">
      <p style="font-size:12px;color:var(--muted);margin-bottom:6px">
        Tarih aralƒ±ƒüƒ±na g√∂re t√ºm randevularƒ± listeleyip PDF olarak indirebilirsin.
      </p>
      <div class="inline-form">
        <label>Ba≈ülangƒ±√ß:</label>
        <input id="repStart" type="date">
        <label>Biti≈ü:</label>
        <input id="repEnd" type="date">
        <button type="button" id="repLoadBtn">Raporu G√∂ster</button>
        <button type="button" class="btn-secondary" id="repPdfBtn">PDF indir</button>
      </div>
      <table class="small-table" id="repTable">
        <thead>
          <tr>
            <th>Tarih</th><th>Saat</th><th>Ad Soyad</th><th>Telefon</th><th>Hizmet</th><th>Not</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rapor satƒ±rlarƒ± -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- TOAST -->
  <div class="toast" id="toast">
    <span class="toast-dot"></span>
    <span id="toastMsg">Randevu alƒ±ndƒ±.</span>
  </div>

  <!-- jsPDF (PDF i√ßin) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-NaWTHk8E4M2n2eefsmu+6nTqvYnz0qVRkyVfC4TsKp+GYgHy71J31xYlI1cnZ6+Q9UxNX2D6V7p8cN2f+5bY4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- FIREBASE + UYGULAMA KODU -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      query,
      where,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";

    // jsPDF globali
    const { jsPDF } = window.jspdf;

    // CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyAu1Uet9M0o2g44d4VIMyC_etWN7F2XKrI",
      authDomain: "benim-berberim-8e717.firebaseapp.com",
      projectId: "benim-berberim-8e717",
      storageBucket: "benim-berberim-8e717.firebasestorage.app",
      messagingSenderId: "223932865229",
      appId: "1:223932865229:web:91b099ff105aa77164a784",
      measurementId: "G-8MKWHR4DYS"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db  = getFirestore(app);

    // ELEMENTLER
    const apptForm      = document.getElementById("apptForm");
    const todayBtn      = document.getElementById("todayBtn");
    const apptListEl    = document.getElementById("apptList");
    const todayLabelEl  = document.getElementById("todayLabel");
    const todayDateChip = document.getElementById("todayDateChip");
    const todayCountEl  = document.getElementById("todayCountChip");
    const toastEl       = document.getElementById("toast");
    const toastMsgEl    = document.getElementById("toastMsg");

    const adminLoginBtn  = document.getElementById("adminLoginBtn");
    const adminLogoutBtn = document.getElementById("adminLogoutBtn");
    const bellEl         = document.getElementById("bell");
    const bellCountEl    = document.getElementById("bellCount");
    const adminPanelEl   = document.getElementById("adminPanel");

    // Admin panel sekmeleri
    const adminTabs = document.querySelectorAll(".admin-tab");
    const adminSections = {
      services: document.getElementById("section-services"),
      barbers : document.getElementById("section-barbers"),
      reports : document.getElementById("section-reports")
    };

    // Hizmet / Berber / Rapor elementleri
    const svcNameEl     = document.getElementById("svcName");
    const svcDurationEl = document.getElementById("svcDuration");
    const svcPriceEl    = document.getElementById("svcPrice");
    const svcAddBtn     = document.getElementById("svcAddBtn");
    const svcTableBody  = document.querySelector("#svcTable tbody");
    const serviceSelect = document.getElementById("service");

    const barberNameEl  = document.getElementById("barberName");
    const barberAddBtn  = document.getElementById("barberAddBtn");
    const barberTable   = document.querySelector("#barberTable tbody");

    const repStartEl = document.getElementById("repStart");
    const repEndEl   = document.getElementById("repEnd");
    const repLoadBtn = document.getElementById("repLoadBtn");
    const repPdfBtn  = document.getElementById("repPdfBtn");
    const repTableBody = document.querySelector("#repTable tbody");

    // DURUMLAR
    let isAdmin = false;
    let lastTodayCount = 0;
    let unseenCount = 0;
    let unsubscribeToday = null;
    let lastReportRows = []; // PDF i√ßin tutulacak

    // Yardƒ±mcƒ±
    function formatDateTR(date){
      return date.toLocaleDateString("tr-TR",{
        weekday:"long",
        day:"numeric",
        month:"long"
      });
    }
    function todayKey(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm   = String(d.getMonth()+1).padStart(2,"0");
      const dd   = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function showToast(msg){
      toastMsgEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"),2300);
    }

    // BELL & ADMIN UI
    function updateBellUI(){
      if(!isAdmin){
        bellEl.classList.add("hidden");
        bellCountEl.classList.add("hidden");
        bellEl.classList.remove("bell-alert");
        return;
      }
      bellEl.classList.remove("hidden");
      if(unseenCount > 0){
        bellCountEl.textContent = unseenCount;
        bellCountEl.classList.remove("hidden");
        bellEl.classList.add("bell-alert");
      }else{
        bellCountEl.classList.add("hidden");
        bellEl.classList.remove("bell-alert");
      }
    }
    function updateAdminUI(){
      if(isAdmin){
        adminLoginBtn.classList.add("hidden");
        adminLogoutBtn.classList.remove("hidden");
        adminPanelEl.classList.remove("hidden");
      }else{
        adminLoginBtn.classList.remove("hidden");
        adminLogoutBtn.classList.add("hidden");
        adminPanelEl.classList.add("hidden");
      }
      updateBellUI();
    }

    // Admin state'i localStorage'dan
    if(localStorage.getItem("berber_isAdmin") === "1"){
      isAdmin = true;
      updateAdminUI();
    }

    adminLoginBtn.addEventListener("click", ()=>{
      const pass = prompt("Admin ≈üifresi:");
      if(pass === "ahmetgs"){
        isAdmin = true;
        localStorage.setItem("berber_isAdmin","1");
        showToast("Admin giri≈üi ba≈üarƒ±lƒ±");
        updateAdminUI();
        loadServices();
        loadBarbers();
      }else if(pass){
        showToast("Hatalƒ± ≈üifre");
      }
    });

    adminLogoutBtn.addEventListener("click", ()=>{
      isAdmin = false;
      localStorage.removeItem("berber_isAdmin");
      unseenCount = 0;
      showToast("Admin √ßƒ±kƒ±≈ü yapƒ±ldƒ±");
      updateAdminUI();
    });

    bellEl.addEventListener("click", ()=>{
      unseenCount = 0;
      updateBellUI();
    });

    // Admin tabs
    adminTabs.forEach(tab=>{
      tab.addEventListener("click", ()=>{
        adminTabs.forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        const key = tab.dataset.tab;
        Object.keys(adminSections).forEach(k=>{
          adminSections[k].classList.toggle("active", k===key);
        });
      });
    });

    // Tarih alanƒ±nƒ± bug√ºne set et
    (function initDateField(){
      const input = document.getElementById("date");
      input.value = todayKey();
      repStartEl.value = todayKey();
      repEndEl.value   = todayKey();
    })();

    // BUG√úN Lƒ∞STE
    function renderTodayList(items){
      apptListEl.innerHTML = "";
      if(items.length === 0){
        const li = document.createElement("li");
        li.className = "empty";
        li.textContent = "Bug√ºn i√ßin kayƒ±tlƒ± randevu bulunmuyor.";
        apptListEl.appendChild(li);
      }else{
        items.forEach(item=>{
          const li = document.createElement("li");
          li.className = "app-item";
          li.innerHTML = `
            <div class="app-main">
              <div class="app-name">${item.name || "ƒ∞simsiz M√º≈üteri"}</div>
              <div class="app-meta">
                ${item.time || "Saat yok"} ‚Ä¢ ${item.phone || "-"}
                ${item.service ? " ‚Ä¢ " + item.service : ""}
              </div>
            </div>
            <div class="app-tag">
              ${item.service || "Randevu"}
            </div>
          `;
          apptListEl.appendChild(li);
        });
      }
      todayCountEl.textContent = `${items.length} randevu`;
    }

    function startTodayListener(){
      if(unsubscribeToday) unsubscribeToday();

      const q = query(
        collection(db,"appointments"),
        where("date","==",todayKey())
      );

      unsubscribeToday = onSnapshot(q,(snapshot)=>{
        const todays = [];
        snapshot.forEach(docSnap=>{
          todays.push({id:docSnap.id, ...docSnap.data()});
        });
        todays.sort((a,b)=>(a.time||"").localeCompare(b.time||""));
        renderTodayList(todays);

        const diff = todays.length - lastTodayCount;
        if(isAdmin && diff > 0){
          unseenCount += diff;
          updateBellUI();
          showToast("Yeni randevu geldi");
        }
        lastTodayCount = todays.length;
      },(err)=>{
        console.error(err);
        showToast("Randevular y√ºklenirken hata olu≈ütu");
      });
    }

    // FORM SUBMIT
    apptForm.addEventListener("submit", async (e)=>{
      e.preventDefault();

      const name    = apptForm.name.value.trim();
      const phone   = apptForm.phone.value.trim();
      const date    = apptForm.date.value;
      const time    = apptForm.time.value;
      const service = apptForm.service.value;
      const note    = apptForm.note.value.trim();

      if(!name || !phone || !date || !time || !service){
        showToast("L√ºtfen zorunlu alanlarƒ± doldurun");
        return;
      }

      try{
        await addDoc(collection(db,"appointments"),{
          name,phone,date,time,service,note,
          createdAt: new Date().toISOString()
        });

        showToast("Randevunuz alƒ±ndƒ± ‚úî");
        apptForm.note.value = "";
      }catch(err){
        console.error(err);
        showToast("Randevu alƒ±namadƒ±, tekrar deneyin");
      }
    });

    todayBtn.addEventListener("click", ()=>{
      startTodayListener();
      showToast("Bug√ºnk√º randevular yenilendi");
    });

    // Hƒ∞ZMETLER
    async function loadServices(){
      try{
        const snap = await getDocs(collection(db,"services"));
        const rows = [];
        svcTableBody.innerHTML = "";
        serviceSelect.innerHTML = '<option value="">Se√ßiniz</option>';

        snap.forEach(docSnap=>{
          const data = docSnap.data();
          const row = { id: docSnap.id, ...data };
          rows.push(row);

          // tablo
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.name || ""}</td>
            <td>${data.duration ? data.duration + " dk" : "-"}</td>
            <td>${data.price ? data.price + " ‚Ç∫" : "-"}</td>
            <td><button data-id="${docSnap.id}" class="top-btn pill-danger" style="font-size:11px;padding:2px 7px;">Sil</button></td>
          `;
          svcTableBody.appendChild(tr);

          // select
          const opt = document.createElement("option");
          opt.value = data.name || "";
          opt.textContent = data.name || "";
          serviceSelect.appendChild(opt);
        });

        // silme butonlarƒ±
        svcTableBody.querySelectorAll("button[data-id]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            if(!confirm("Bu hizmet silinsin mi?")) return;
            try{
              await deleteDoc(
                (await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js")).doc(db,"services",btn.dataset.id)
              );
            }catch(e){
              // √ºstteki dinamik import karƒ±≈ümasƒ±n diye basit y√∂ntem: getDocs/deleteDoc ba≈üka import'tan; burada workaround yapmayalƒ±m
            }
          });
        });
      }catch(err){
        console.error(err);
      }
    }

    // deleteDoc importunu ayrƒ± alalƒ±m (dinamik yerine)
    // (yukarƒ±daki deleteDoc import'u zaten var, o y√ºzden basit√ße kullanalƒ±m)
    svcTableBody.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button[data-svc-id]");
      if(!btn) return;
      if(!confirm("Bu hizmet silinsin mi?")) return;
      try{
        await deleteDoc(
          (await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js")).doc(db,"services",btn.dataset.svcId)
        );
      }catch(err){console.error(err);}
    });

    svcAddBtn.addEventListener("click", async ()=>{
      const name = svcNameEl.value.trim();
      const dur  = parseInt(svcDurationEl.value,10) || null;
      const price= parseInt(svcPriceEl.value,10) || null;
      if(!name){
        showToast("Hizmet adƒ± bo≈ü olamaz");
        return;
      }
      try{
        await addDoc(collection(db,"services"),{
          name,
          duration: dur,
          price
        });
        svcNameEl.value="";
        svcDurationEl.value="";
        svcPriceEl.value="";
        showToast("Hizmet eklendi");
        loadServices();
      }catch(err){
        console.error(err);
        showToast("Hizmet eklenemedi");
      }
    });

    // basit silme (daha temiz versiyon)
    svcTableBody.addEventListener("click", async (e)=>{
      if(e.target.tagName.toLowerCase()!=="button") return;
      const id = e.target.getAttribute("data-id");
      if(!id) return;
      if(!confirm("Bu hizmet silinsin mi?")) return;
      try{
        await deleteDoc((await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js")).doc(db,"services",id));
      }catch(err){
        // bazƒ± tarayƒ±cƒ±larda dinamik import sorun √ßƒ±karabilir; hata olursa logla
        console.error(err);
      }
      loadServices();
    });

    // BERBERLER
    async function loadBarbers(){
      try{
        const snap = await getDocs(collection(db,"barbers"));
        barberTable.innerHTML = "";
        snap.forEach(docSnap=>{
          const data = docSnap.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${data.name || ""}</td>
            <td><button data-id="${docSnap.id}" class="top-btn pill-danger" style="font-size:11px;padding:2px 7px;">Sil</button></td>
          `;
          barberTable.appendChild(tr);
        });
      }catch(err){console.error(err);}
    }

    barberAddBtn.addEventListener("click", async ()=>{
      const name = barberNameEl.value.trim();
      if(!name){
        showToast("Berber adƒ± bo≈ü olamaz");
        return;
      }
      try{
        await addDoc(collection(db,"barbers"),{ name });
        barberNameEl.value="";
        showToast("Berber eklendi");
        loadBarbers();
      }catch(err){
        console.error(err);
        showToast("Berber eklenemedi");
      }
    });

    barberTable.addEventListener("click", async (e)=>{
      if(e.target.tagName.toLowerCase()!=="button") return;
      const id = e.target.getAttribute("data-id");
      if(!id) return;
      if(!confirm("Bu berber silinsin mi?")) return;
      try{
        await deleteDoc((await import("https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js")).doc(db,"barbers",id));
        showToast("Berber silindi");
        loadBarbers();
      }catch(err){console.error(err);}
    });

    // RAPORLAR
    async function loadReport(){
      const start = repStartEl.value || "0000-00-00";
      const end   = repEndEl.value   || "9999-12-31";

      try{
        const snap = await getDocs(collection(db,"appointments"));
        const rows = [];
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          if(!d.date) return;
          if(d.date >= start && d.date <= end){
            rows.push({
              date: d.date,
              time: d.time || "",
              name: d.name || "",
              phone: d.phone || "",
              service: d.service || "",
              note: d.note || ""
            });
          }
        });

        // sort by date+time
        rows.sort((a,b)=>{
          const ka = a.date + " " + (a.time||"");
          const kb = b.date + " " + (b.time||"");
          return ka.localeCompare(kb);
        });

        repTableBody.innerHTML = "";
        rows.forEach(r=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.date}</td>
            <td>${r.time}</td>
            <td>${r.name}</td>
            <td>${r.phone}</td>
            <td>${r.service}</td>
            <td>${r.note}</td>
          `;
          repTableBody.appendChild(tr);
        });

        lastReportRows = rows;
        showToast(rows.length + " randevu listelendi");
      }catch(err){
        console.error(err);
        showToast("Rapor y√ºklenemedi");
      }
    }

    repLoadBtn.addEventListener("click", loadReport);

    repPdfBtn.addEventListener("click", ()=>{
      if(!lastReportRows.length){
        showToast("√ñnce raporu listele");
        return;
      }
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text("Ahmet Tekeli Kuaf√∂r√º - Randevu Raporu", 10, 10);
      doc.setFontSize(9);
      doc.text("Tarih: " + new Date().toLocaleString("tr-TR"), 10, 16);

      const head = [["Tarih","Saat","Ad Soyad","Telefon","Hizmet","Not"]];
      const body = lastReportRows.map(r=>[
        r.date, r.time, r.name, r.phone, r.service, r.note
      ]);

      // basit tablo
      let y = 22;
      head.concat(body).forEach((row,i)=>{
        if(y > 280){
          doc.addPage();
          y = 10;
        }
        row.forEach((cell,idx)=>{
          const x = 10 + idx*30;
          doc.text(String(cell).substring(0,30), x, y);
        });
        y += 6;
      });

      doc.save("randevu-raporu.pdf");
    });

    // SAYFA A√áILI≈ûI
    const today = new Date();
    todayLabelEl.textContent  = "Bug√ºn: " + formatDateTR(today);
    todayDateChip.textContent = todayKey();
    startTodayListener();
    loadServices(); // m√º≈üteri tarafƒ± i√ßin hizmetleri doldur
  </script>
</body>
</html>
