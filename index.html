<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Ahmet Tekeli Kuaför • Online Randevu</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#111827">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#e5e7eb;
  --ink:#111827;
  --muted:#6b7280;
  --brand:#d4af37;
  --danger:#ef4444;
  --ok:#10b981;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{
  font:15px/1.5 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--ink);
}
.bg{
  position:fixed;inset:0;z-index:-2;
  background:
    url("arka-plan.jpg") center/cover no-repeat,
    radial-gradient(circle at 10% 0%,rgba(148,163,184,.4),transparent 22%);
  filter:blur(10px);
}
.bg-overlay{
  position:fixed;inset:0;z-index:-1;
  background:
    linear-gradient(to bottom,rgba(255,255,255,.82),rgba(209,213,219,.96)),
    radial-gradient(circle at top,rgba(255,255,255,.72),transparent 55%);
}
body{
  min-height:100vh;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:18px 10px 28px;
  animation:bodyFade .7s ease-out;
}
@keyframes bodyFade{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
.wrap{
  width:100%;max-width:420px;position:relative;
  border-radius:32px;
  padding:18px 16px 22px;
  background:linear-gradient(145deg,rgba(243,244,246,.92),rgba(229,231,235,.97));
  box-shadow:0 22px 70px rgba(15,23,42,.4),0 0 0 1px rgba(148,163,184,.35);
  backdrop-filter:blur(22px) saturate(145%);
}
.logo-wrap{display:flex;justify-content:center;margin-bottom:8px;}
.logo-circle{
  width:92px;height:92px;border-radius:999px;
  background:url("logo.png") center/100% 100% no-repeat;
  position:relative;box-shadow:0 20px 46px rgba(0,0,0,.45);
}
.logo-circle::before{
  content:"";position:absolute;inset:-4px;border-radius:999px;
  background:conic-gradient(from 230deg,var(--brand),#fbbf24,#fef3c7,var(--brand));
  opacity:.9;z-index:-1;filter:blur(1.2px);
}
.logo-circle::after{
  content:"";position:absolute;inset:4px;border-radius:999px;
  background:radial-gradient(circle at 10% 0%,rgba(255,255,255,.9),transparent 55%);
  mix-blend-mode:screen;
}
.top-actions{
  position:absolute;top:12px;right:12px;
  display:flex;flex-direction:column;gap:6px;
}
.btn-top{
  border-radius:999px;padding:7px 13px;
  border:1px solid rgba(209,213,219,.9);
  cursor:pointer;font-size:12px;font-weight:600;
  background:rgba(255,255,255,.96);color:#111827;
  box-shadow:0 10px 26px rgba(15,23,42,.25);
  backdrop-filter:blur(18px);position:relative;overflow:hidden;
}
.btn-top span{opacity:.95}
.btn-top::after{
  content:"";position:absolute;inset:-40%;
  background:linear-gradient(120deg,transparent,rgba(255,255,255,.6),transparent);
  transform:translateX(-120%);transition:transform .7s ease-out;
}
.btn-top:hover::after{transform:translateX(120%);}
.card{
  border-radius:26px;padding:16px 14px 18px;
  border:1px solid rgba(209,213,219,.95);
  background:radial-gradient(circle at 0 0,rgba(255,255,255,1),rgba(243,244,246,.98));
  box-shadow:0 20px 50px rgba(15,23,42,.32),0 0 0 1px rgba(148,163,184,.25);
  color:var(--ink);
}
.card-header{text-align:center;margin-bottom:14px;}
.brand-title{font-size:24px;font-weight:800;letter-spacing:.14em;text-transform:uppercase;}
.brand-sub{margin-top:2px;font-size:11px;letter-spacing:.25em;text-transform:uppercase;color:var(--muted);}
.rating{
  margin-top:8px;display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:999px;font-size:11px;
  background:rgba(255,255,255,.98);
  border:1px solid rgba(209,213,219,.95);
  box-shadow:0 10px 24px rgba(15,23,42,.2);
}
.rating .star{
  width:12px;height:12px;
  clip-path:polygon(50% 0%,63% 38%,100% 38%,69% 59%,82% 100%,50% 76%,18% 100%,31% 59%,0 38%,37% 38%);
  background:var(--brand);
}
.section-title{font-size:12px;font-weight:600;margin:8px 0 4px;color:#111827;}
.input,.select,.date-input{
  width:100%;border-radius:13px;padding:8px 11px;
  border:1px solid rgba(209,213,219,.95);
  background:linear-gradient(135deg,rgba(255,255,255,.99),rgba(249,250,251,.99));
  color:#0f172a;font-size:13px;
}
.input::placeholder{color:#9ca3af}
.date-input{padding:6px 9px;font-size:10px;}
.row{display:flex;flex-wrap:wrap;gap:6px;}
.row>*{flex:1;min-width:0;}
.barber-choices{display:flex;flex-wrap:wrap;gap:6px;}
.barber-chip{
  display:flex;align-items:center;gap:6px;padding:5px 9px;
  border-radius:999px;
  background:linear-gradient(135deg,rgba(243,244,246,1),rgba(229,231,235,1));
  border:1px solid rgba(209,213,219,1);cursor:pointer;
  font-size:11px;box-shadow:0 6px 14px rgba(15,23,42,.12);
}
.barber-chip.selected{
  background:linear-gradient(135deg,#fde68a,var(--brand));
  color:#111827;border-color:transparent;
}
.barber-avatar{
  width:24px;height:24px;border-radius:999px;overflow:hidden;flex-shrink:0;
  background:rgba(31,41,55,.08);display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:800;text-transform:uppercase;
}
.barber-avatar img{width:100%;height:100%;object-fit:cover;}
.slot-grid{
  margin-top:6px;display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));gap:7px;
}
.slot{
  border-radius:12px;padding:7px 0;
  border:1px solid rgba(209,213,219,1);
  background:rgba(255,255,255,.99);color:#111827;
  font-weight:700;font-size:11px;cursor:pointer;
  box-shadow:0 10px 22px rgba(15,23,42,.15);
}
.slot.selected{
  background:linear-gradient(135deg,#fde68a,var(--brand));
  color:#111827;border-color:transparent;
}
.slot.disabled{opacity:.28;pointer-events:none;}
.btn-book{
  width:100%;margin-top:14px;border-radius:999px;
  padding:11px 18px;border:none;cursor:pointer;
  font-size:13px;font-weight:900;letter-spacing:.18em;
  text-transform:uppercase;
  background:linear-gradient(135deg,#fef3c7,#facc15,var(--brand));
  color:#111827;
  box-shadow:0 18px 42px rgba(0,0,0,.22),0 0 0 1px rgba(180,148,60,.55);
  position:relative;overflow:hidden;
}
.btn-book::after{
  content:"";position:absolute;inset:-60%;
  background:linear-gradient(120deg,transparent,rgba(255,255,255,.7),transparent);
  transform:translateX(-130%);transition:transform .8s ease-out;
}
.btn-book:hover::after{transform:translateX(130%);}
.helper{margin-top:6px;font-size:11px;color:var(--muted);}
.app-list{list-style:none;margin-top:4px;}
.app-item{
  display:flex;flex-wrap:wrap;justify-content:space-between;
  gap:6px;padding:7px 7px;border-radius:13px;
  border:1px solid rgba(148,163,184,.7);
  background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.98));
  font-size:11px;backdrop-filter:blur(14px);color:#e5e7eb;
}
.app-main{display:flex;flex-direction:column;gap:2px;}
.app-title{font-weight:700;}
.app-meta{color:#cbd5f5;}
.app-actions{display:flex;gap:5px;align-items:center;}
.btn-mini{
  border-radius:999px;border:none;padding:4px 9px;
  font-size:10px;cursor:pointer;font-weight:700;
}
.btn-mini.edit{background:rgba(16,185,129,.12);color:var(--ok);border:1px solid rgba(16,185,129,.7);}
.btn-mini.del{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(248,113,113,.7);}
.btn-mini.wp{background:rgba(34,197,94,.12);color:#22c55e;border:1px solid rgba(34,197,94,.7);}
.btn-mini.note{background:rgba(59,130,246,.12);color:#60a5fa;border:1px solid rgba(59,130,246,.7);}
.panel{
  margin-top:10px;background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.99));
  border-radius:20px;padding:9px 9px 10px;
  border:1px solid rgba(148,163,184,.6);backdrop-filter:blur(16px);color:#e5e7eb;
}
.modal-backdrop{
  position:fixed;inset:0;background:rgba(15,23,42,.82);
  display:none;align-items:center;justify-content:center;z-index:30;
}
.modal{
  width:100%;max-width:380px;
  background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(15,23,42,.99));
  border-radius:24px;padding:14px;
  border:1px solid rgba(148,163,184,.7);
  box-shadow:0 24px 70px rgba(0,0,0,.9);
  backdrop-filter:blur(22px);color:#e5e7eb;
}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.modal-title{font-size:14px;font-weight:800;}
.modal-close{border:none;background:none;color:#9ca3af;font-size:20px;cursor:pointer;}
.tabs{display:flex;gap:6px;margin-bottom:10px;}
.tab-btn{
  flex:1;border-radius:999px;border:1px solid rgba(148,163,184,.7);
  background:rgba(15,23,42,.9);color:#9ca3af;
  padding:6px 0;font-size:12px;font-weight:700;cursor:pointer;
}
.tab-btn.active{background:linear-gradient(135deg,#facc15,var(--brand));color:#111827;border-color:transparent;}
.btn-full{
  width:100%;margin-top:9px;padding:9px 0;border-radius:999px;border:none;
  background:linear-gradient(135deg,#fef3c7,#facc15,var(--brand));
  color:#111827;font-size:13px;font-weight:800;cursor:pointer;
  box-shadow:0 14px 40px rgba(0,0,0,.85);position:relative;overflow:hidden;
}
.btn-full::after{
  content:"";position:absolute;inset:-60%;
  background:linear-gradient(120deg,transparent,rgba(255,255,255,.7),transparent);
  transform:translateX(-130%);transition:transform .8s ease-out;
}
.btn-full:hover::after{transform:translateX(130%);}
.admin-summary{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.summary-card{
  flex:1;min-width:120px;padding:8px 10px;border-radius:16px;
  background:radial-gradient(circle at top,rgba(15,23,42,.95),rgba(15,23,42,1));
  border:1px solid rgba(250,204,21,.4);
  box-shadow:0 14px 40px rgba(0,0,0,.7);
  backdrop-filter:blur(18px) saturate(160%);
  display:flex;flex-direction:column;gap:2px;
}
.summary-label{font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:#e5e7eb;opacity:.85;}
.summary-value{font-size:17px;font-weight:900;color:#facc15;}
.summary-sub{font-size:11px;color:#cbd5f5;}
.admin-tabs{
  display:flex;flex-wrap:wrap;gap:5px;margin-bottom:9px;
  background:linear-gradient(135deg,rgba(15,23,42,.9),rgba(15,23,42,.98));
  padding:4px;border-radius:999px;border:1px solid rgba(148,163,184,.7);
}
.admin-tab{
  flex:1;border-radius:999px;border:none;background:transparent;
  color:#9ca3af;padding:5px 0;font-size:11px;font-weight:800;cursor:pointer;
}
.admin-tab.active{background:linear-gradient(135deg,#facc15,var(--brand));color:#111827;box-shadow:0 10px 26px rgba(0,0,0,.85);}
.admin-section{display:none;}
.admin-section.active{display:block;}
.admin-filter-row{display:flex;flex-direction:column;gap:8px;margin:6px 0 10px;}
.closed-panel-title{margin-top:10px;font-size:11px;font-weight:700;color:#e5e7eb;}
.closed-date-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:4px 6px;border-radius:10px;
  border:1px solid rgba(148,163,184,.6);margin-top:4px;
  font-size:11px;color:#e5e7eb;
}
.closed-date-item span{color:#cbd5f5;}
.toast{
  position:fixed;left:50%;top:14px;
  transform:translateX(-50%);
  background:radial-gradient(circle at top,rgba(15,23,42,.98),rgba(15,23,42,1));
  color:#f9fafb;padding:7px 14px 7px 32px;
  border-radius:999px;font-size:12px;
  border:1px solid rgba(148,163,184,.9);
  box-shadow:0 20px 60px rgba(0,0,0,.9);
  z-index:50;align-items:center;gap:6px;
  display:none;opacity:0;pointer-events:none;
  transition:opacity .25s ease-out,transform .25s ease-out;
}
.toast-icon{position:absolute;left:10px;font-size:13px;}
.toast.ok{border-color:rgba(16,185,129,.7);}
.toast.err{border-color:rgba(248,113,113,.9);}
.schedule-wrapper{max-height:65vh;overflow:auto;padding-right:4px;}
.schedule-row{
  border-radius:14px;border:1px solid rgba(148,163,184,.6);
  padding:6px 7px;margin-bottom:6px;
  background:radial-gradient(circle at top,rgba(15,23,42,.97),rgba(15,23,42,1));
}
.schedule-row-head{display:flex;justify-content:space-between;align-items:center;font-size:11px;margin-bottom:4px;}
.schedule-day-name{font-weight:800;}
.schedule-intervals{display:flex;flex-direction:column;gap:4px;margin-top:3px;}
.schedule-interval{display:flex;gap:4px;align-items:center;}
.schedule-interval select{
  flex:1;border-radius:10px;padding:4px 6px;
  border:1px solid rgba(148,163,184,.7);
  background:rgba(15,23,42,.95);color:#e5e7eb;font-size:11px;
}
.schedule-interval button{
  border:none;border-radius:999px;padding:3px 7px;font-size:10px;cursor:pointer;
  background:rgba(239,68,68,.12);color:var(--danger);
  border:1px solid rgba(248,113,113,.7);
}
.btn-add-interval{
  margin-top:4px;border-radius:999px;border:none;
  padding:3px 8px;font-size:10px;cursor:pointer;
  background:rgba(59,130,246,.12);color:#60a5fa;
  border:1px solid rgba(59,130,246,.7);
}
.day-active-label{font-size:10px;display:flex;align-items:center;gap:4px;}
.day-active-label input{accent-color:var(--brand);}
.quick-backdrop{
  position:fixed;inset:0;z-index:45;
  display:none;align-items:flex-start;justify-content:center;
  background:rgba(15,23,42,.5);
}
.quick-card{
  margin-top:70px;width:90%;max-width:360px;
  border-radius:22px;padding:10px 12px 12px;
  background:radial-gradient(circle at top,rgba(15,23,42,.98),rgba(15,23,42,1));
  border:1px solid rgba(250,204,21,.65);
  box-shadow:0 28px 80px rgba(0,0,0,.95);color:#f9fafb;
}
.quick-head{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
.quick-icon{
  width:26px;height:26px;border-radius:999px;
  background:radial-gradient(circle at 30% 0,#facc15,#f97316);
  display:flex;align-items:center;justify-content:center;font-size:15px;
}
.quick-title{font-size:13px;font-weight:900;}
.quick-body{font-size:11px;color:#e5e7eb;margin-top:4px;}
@media(max-width:480px){
  .wrap{padding:16px 10px 18px;border-radius:28px;}
  .card{padding:14px 10px 16px;}
  .brand-title{font-size:22px;}
  .slot-grid{grid-template-columns:repeat(3,minmax(0,1fr));gap:6px;}
  .date-input{font-size:11px;padding:5px 8px;}
}
@media(min-width:600px){
  .admin-filter-row{flex-direction:row;align-items:flex-end;gap:12px;}
}
@media print{
  body{background:#fff;padding:0;}
  .bg,.bg-overlay,.wrap>.logo-wrap,.top-actions,.card,
  #customerModal,#scheduleModal,#rescheduleModal,.toast,.quick-backdrop{display:none!important;}
  #adminModal{position:static;display:block!important;background:#fff;}
  #adminModal .modal{max-width:100%;border:none;box-shadow:none;padding:10px;background:#fff;}
  #adminLoginArea{display:none!important;}
  #adminPanelArea{display:block!important;max-height:none;overflow:visible;}
  .admin-tabs{display:none!important;}
  .admin-section{display:none!important;}
  .admin-section.active{display:block!important;}
  .btn-full{display:none!important;}
  .app-item{box-shadow:none;border:1px solid #ddd;background:#fff;color:#000;}
  .app-title,.app-meta{color:#000;}
}
</style>
</head>

<body>
<div class="bg"></div>
<div class="bg-overlay"></div>

<div class="wrap">
  <div class="logo-wrap">
    <div class="logo-circle"></div>
  </div>

  <div class="top-actions">
    <button class="btn-top" type="button" id="btnAdminOpen"><span id="adminBtnLabel">Admin Girişi</span></button>
    <button class="btn-top" type="button" id="btnCustomerOpen"><span id="customerBtnLabel">Müşteri Paneli</span></button>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="brand-title">AHMET TEKELİ</div>
      <div class="brand-sub">ERKEK KUAFÖRÜ</div>
      <div class="rating">
        <div class="star"></div>
        <span>⭐️ONLİNE RANDEVU⭐️</span>
      </div>
    </div>

    <div>
      <div class="section-title">Ad Soyad</div>
      <input class="input" id="nameInput" placeholder="Adınız ve Soyadınız">

      <div class="section-title">Telefon</div>
      <input class="input" id="phoneInput" placeholder="05xxxxxxxxx">

      <div class="row">
        <div>
          <div class="section-title">Berber Seçimi</div>
          <div class="barber-choices" id="barberChoices"></div>
          <select class="select" id="barberSelect" style="display:none;"></select>
        </div>
        <div>
          <div class="section-title">İşlem Seçimi</div>
          <select class="select" id="serviceSelect"></select>
        </div>
      </div>

      <div class="section-title" style="margin-top:8px;">Tarih</div>
      <input type="date" class="date-input" id="dateInput">

      <div class="section-title" style="margin-top:8px;">Saat Seçimi</div>
      <div class="slot-grid" id="slotGrid"></div>

      <button class="btn-book" id="btnBook">RANDEVU AL</button>

      <div class="helper" id="bookingHelper">
        Randevu almak için önce müşteri girişi yapmalısın. Müşteri panelinden kayıt olabilirsin.
      </div>
      <div class="helper" id="dayInfoHelper"></div>
    </div>
  </div>
</div>

<!-- Müşteri Paneli (SADE) -->
<div class="modal-backdrop" id="customerModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Müşteri Paneli</div>
      <button class="modal-close" type="button" id="modalClose">&times;</button>
    </div>

    <div id="customerLoggedBox" style="display:none;">
      <div class="helper" id="customerLoggedText"></div>

      <div id="customerAppsBox" class="panel" style="margin-top:10px;">
        <div class="section-title">Randevularım</div>
        <ul class="app-list" id="appListModal"></ul>
      </div>

      <button class="btn-full" id="btnCustomerLogout" style="margin-top:10px;background:rgba(31,41,55,1);color:#f9fafb;">
        Çıkış Yap
      </button>
    </div>

    <div class="tabs" id="tabsRow">
      <button class="tab-btn active" type="button" data-tab="login">Giriş Yap</button>
      <button class="tab-btn" type="button" data-tab="register">Kayıt Ol</button>
    </div>

    <div id="loginTab">
      <div class="section-title">Telefon</div>
      <input class="input" id="loginPhone" placeholder="05xxxxxxxxx">
      <div class="section-title">Şifre</div>
      <input class="input" id="loginPass" type="password" placeholder="••••••">
      <button class="btn-full" id="btnLogin">Giriş Yap</button>
      <div class="helper">İlk defa geliyorsan üstten <b>Kayıt Ol</b> sekmesine geç.</div>
    </div>

    <div id="registerTab" style="display:none;">
      <div class="section-title">Ad Soyad</div>
      <input class="input" id="regName" placeholder="Adınız Soyadınız">
      <div class="section-title">Telefon</div>
      <input class="input" id="regPhone" placeholder="05xxxxxxxxx">
      <div class="section-title">Şifre</div>
      <input class="input" id="regPass" type="password" placeholder="En az 4 karakter">
      <button class="btn-full" id="btnRegister">Kayıt Ol</button>
      <div class="helper">Kayıt sonrası randevularını görebilir, iptal/değiştir yapabilirsin.</div>
    </div>
  </div>
</div>

<!-- Randevu Değiştir -->
<div class="modal-backdrop" id="rescheduleModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Randevu Değiştir</div>
      <button class="modal-close" type="button" id="rescheduleClose">&times;</button>
    </div>

    <div class="section-title">Yeni Tarih</div>
    <input type="date" class="date-input" id="rescheduleDate">

    <div class="section-title" style="margin-top:8px;">Yeni Saat</div>
    <div class="slot-grid" id="rescheduleSlotGrid"></div>

    <div class="helper" id="rescheduleInfo" style="margin-top:6px;"></div>

    <button class="btn-full" id="btnRescheduleSave" style="margin-top:10px;">
      Değişikliği Kaydet
    </button>
  </div>
</div>

<!-- Admin Paneli -->
<div class="modal-backdrop" id="adminModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Admin Paneli</div>
      <button class="modal-close" type="button" id="adminModalClose">&times;</button>
    </div>

    <div id="adminLoginArea">
      <div class="section-title">Telefon</div>
      <input class="input" id="adminPhone" placeholder="Admin telefon">
      <div class="section-title">Şifre</div>
      <input class="input" id="adminPass" type="password" placeholder="Şifre">
      <button class="btn-full" id="btnAdminLogin">Admin Giriş Yap</button>
      <div class="helper">Bu alan sadece işletme sahibi içindir.</div>
    </div>

    <div id="adminPanelArea" style="display:none;max-height:70vh;overflow:auto;padding-right:4px;">

      <div class="admin-summary">
        <div class="summary-card">
          <div class="summary-label">Bugün Randevu</div>
          <div class="summary-value" id="sumTodayCount">0</div>
          <div class="summary-sub" id="sumTodayRevenue">0 ₺</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Toplam Randevu</div>
          <div class="summary-value" id="sumAllCount">0</div>
          <div class="summary-sub" id="sumAllRevenue">0 ₺</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Bugün Aktif Berber</div>
          <div class="summary-value" id="sumActiveBarber">0</div>
          <div class="summary-sub">Çalışma planına göre</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">En Çok Yapılan İşlem</div>
          <div class="summary-value" id="sumTopServiceName">-</div>
          <div class="summary-sub" id="sumTopServiceCount">0 adet</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">En Çok Randevu Alan Berber</div>
          <div class="summary-value" id="sumTopBarberName">-</div>
          <div class="summary-sub" id="sumTopBarberCount">0 adet</div>
        </div>
      </div>

      <div class="admin-tabs">
        <button class="admin-tab active" data-admin-section="adminSectionRapor">Raporlar</button>
        <button class="admin-tab" data-admin-section="adminSectionRandevu">Randevular</button>
        <button class="admin-tab" data-admin-section="adminSectionHizmet">Hizmet Yönetimi</button>
        <button class="admin-tab" data-admin-section="adminSectionBerber">Berber Yönetimi & Çalışma Saatleri</button>
        <button class="admin-tab" data-admin-section="adminSectionMusteri">Müşteriler</button>
      </div>

      <!-- RAPORLAR -->
      <div class="admin-section active" id="adminSectionRapor">
        <div class="section-title">Raporlar</div>
        <ul class="app-list" id="reportList"></ul>

        <button class="btn-full" id="btnPrintReports" style="margin-top:8px;">Raporları PDF Olarak Çıkar</button>

        <button class="btn-full" id="btnCopyTodaySummary"
          style="margin-top:8px;background:rgba(34,197,94,.18);color:#bbf7d0;">
          Bugün İçin Hikaye / Mesaj Metni Oluştur (Kopyala)
        </button>
      </div>

      <!-- RANDEVU YÖNETİMİ -->
      <div class="admin-section" id="adminSectionRandevu">
        <div class="section-title">Randevu Yönetimi</div>
        <div class="admin-filter-row">
          <div>
            <div class="section-title">Tarih Filtresi</div>
            <input type="date" class="date-input" id="adminDateFilter">
            <div class="helper" style="color:#cbd5f5;margin-top:4px;">Not: Admin listesi varsayılan <b>bugün</b> olarak ayarlı.</div>
          </div>
          <div>
            <div class="section-title">Berber Filtresi</div>
            <select class="select" id="adminBarberFilter"></select>
          </div>
        </div>

        <ul class="app-list" id="adminAppList"></ul>
        <div class="helper" id="adminCountInfo"></div>

        <button class="btn-full" id="btnPrintAppointments" style="margin-top:8px;">
          Randevu Listesini PDF Olarak Çıkar
        </button>

        <div class="closed-panel-title">Kapalı Günler (Özel tatil / dükkân kapalı)</div>
        <div class="row" style="margin-top:4px;">
          <input type="date" class="date-input" id="closedDateInput">
          <button class="btn-full" id="btnAddClosedDate" style="margin-top:0;">Kapalı Gün Ekle</button>
        </div>
        <div id="closedDateList"></div>
      </div>

      <!-- HİZMET YÖNETİMİ -->
      <div class="admin-section" id="adminSectionHizmet">
        <div class="section-title">Hizmet Yönetimi</div>
        <ul class="app-list" id="serviceList"></ul>

        <div class="row" style="margin-top:6px;">
          <input class="input" id="newServiceName" placeholder="Hizmet adı (Saç Kesim)">
          <input class="input" id="newServicePrice" type="number" min="0" step="30" placeholder="Fiyat">
          <input class="input" id="newServiceDuration" type="number" min="30" step="30" placeholder="Süre (dk) 30/60/90">
        </div>
        <button class="btn-full" id="btnAddService" style="margin-top:6px;">Hizmet Ekle</button>
      </div>

      <!-- BERBER YÖNETİMİ & ÇALIŞMA SAATLERİ -->
      <div class="admin-section" id="adminSectionBerber">
        <div class="section-title">Berber Yönetimi & Çalışma Saatleri</div>
        <ul class="app-list" id="barberList"></ul>

        <div class="section-title" style="margin-top:10px;">Yeni Berber</div>
        <input class="input" id="newBarberName" placeholder="Örn: Ahmet TEKELİ">

        <div class="section-title">Fotoğraf Yükle (isteğe bağlı)</div>
        <input class="input" id="newBarberPhotoFile" type="file" accept="image/*" style="padding:6px 10px;">

        <button class="btn-full" id="btnAddBarber" style="margin-top:6px;">Berber Ekle</button>

        <button class="btn-full" id="btnResetData" style="margin-top:10px;background:#991b1b;color:#fef2f2;">
          Cihazdaki Oturum / Yerel Veriyi Sıfırla
        </button>
        <div class="helper">Not: Firestore verileri silinmez. Sadece bu cihazın girişleri temizlenir.</div>
      </div>

      <!-- MÜŞTERİLER -->
      <div class="admin-section" id="adminSectionMusteri">
        <div class="section-title">Müşteri Listesi</div>

        <!-- YENİ: Arama + Segment filtresi -->
        <div class="admin-filter-row" style="margin-top:6px;">
          <div style="flex:1;">
            <div class="section-title">İsim / Telefon Ara</div>
            <input class="input" id="adminCustomerSearch" placeholder="Örn: Ahmet / 05xx / 5xx...">
          </div>
          <div style="min-width:160px;">
            <div class="section-title">Segment</div>
            <select class="select" id="adminCustomerSegment">
              <option value="">Tümü</option>
              <option value="VIP">VIP</option>
              <option value="Düzenli">Düzenli</option>
              <option value="Uzun Süredir Gelmeyen">Uzun Süredir Gelmeyen</option>
              <option value="Yeni">Yeni</option>
            </select>
          </div>
        </div>

        <ul class="app-list" id="customerList"></ul>

        <div class="panel" id="customerDetail" style="display:none;margin-top:8px;"></div>

        <div class="panel" style="margin-top:8px;">
          <div class="section-title">En Çok Gelen Müşteriler</div>
          <ul class="app-list" id="topCustomerList"></ul>
        </div>

        <div class="helper" style="margin-top:8px;color:#cbd5f5;">
          Not: “Müşteri Sil” müşteri kaydını siler. Randevu geçmişi durabilir.
        </div>
      </div>

      <button class="btn-full" id="btnAdminLogout" style="margin-top:14px;background:rgba(31,41,55,1);color:#f9fafb;">
        Admin Çıkış
      </button>
    </div>
  </div>
</div>

<!-- Berber çalışma saatleri modal -->
<div class="modal-backdrop" id="scheduleModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="scheduleModalTitle">Çalışma Saatleri</div>
      <button class="modal-close" type="button" id="scheduleModalClose">&times;</button>
    </div>
    <div class="schedule-wrapper" id="scheduleWrapper"></div>
    <button class="btn-full" id="btnSaveSchedule">Çalışma Saatlerini Kaydet</button>
  </div>
</div>

<!-- hızlı müşteri popup -->
<div class="quick-backdrop" id="quickNotify">
  <div class="quick-card">
    <div class="quick-head">
      <div class="quick-icon">✔</div>
      <div class="quick-title">Randevun Oluşturuldu</div>
    </div>
    <div class="quick-body" id="quickBodyText"></div>
  </div>
</div>

<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon">✔</span>
  <span id="toastText"></span>
</div>

<script type="module">
/* =========================
   FULL FINAL (Firestore Realtime)
   ✅ Admin randevu listesi: varsayılan BUGÜN
   ✅ Geçmiş randevular otomatik silinir (bugünden önce)
   ✅ Admin Müşteriler: arama + segment filtre
========================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import {
  getFirestore,
  collection, doc, getDoc, getDocs,
  setDoc, deleteDoc,
  onSnapshot,
  runTransaction,
  serverTimestamp,
  addDoc,
  writeBatch
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey:"AIzaSyD3S0XgKgNJLCJr3xQ-ASgr1gHz9MCou-4",
  authDomain:"randevularim-92ac2.firebaseapp.com",
  projectId:"randevularim-92ac2",
  storageBucket:"randevularim-92ac2.firebasestorage.app",
  messagingSenderId:"1092355095676",
  appId:"1:1092355095676:web:085921b2dff9d607b7ddf9"
};
const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);

/* ===== Shop namespace ===== */
const SHOP_ID = "ahmet_tekeli";
const COL = {
  services:   `shops/${SHOP_ID}/services`,
  barbers:    `shops/${SHOP_ID}/barbers`,
  schedules:  `shops/${SHOP_ID}/schedules`,
  closed:     `shops/${SHOP_ID}/closedDates`,
  customers:  `shops/${SHOP_ID}/customers`,
  apps:       `shops/${SHOP_ID}/appointments`,
};

/* ===== Sabitler ===== */
const SLOT_TIMES=[
 "08:00","08:30","09:00","09:30",
 "10:00","10:30","11:00","11:30",
 "12:00","12:30","13:00","13:30",
 "14:00","14:30","15:00","15:30",
 "16:00","16:30","17:00","17:30",
 "18:00","18:30","19:00","19:30",
 "20:00","20:30","21:00","21:30",
 "22:00","22:30","23:00","23:30"
];
const ADMIN_PHONE="05356749243";
const ADMIN_PASS="ahmet";
const MAX_DAYS_AHEAD=30;
const DAY_NAMES=["Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi","Pazar"];

/* ===== Local session ===== */
const LS_ADMIN="ahmet_admin_logged";
const LS_CURRENT_CUST="ahmet_current_customer_phone";

/* ===== State ===== */
let services=[], barbers=[], schedules={}, appointments=[], closedDates=[];
let customerAgg=[];
let currentCustomer=null;
let isAdminLoggedIn=false;
let selectedTime=null, selectedBarberId=null, currentScheduleBarberId=null;
let realtimeStarted=false;
let toastTimer=null;

/* ===== DOM ===== */
const slotGrid=document.getElementById("slotGrid");
const dateInput=document.getElementById("dateInput");
const btnBook=document.getElementById("btnBook");
const nameInput=document.getElementById("nameInput");
const phoneInput=document.getElementById("phoneInput");
const barberSel=document.getElementById("barberSelect");
const barberChoicesEl=document.getElementById("barberChoices");
const servSel=document.getElementById("serviceSelect");
const toastEl=document.getElementById("toast");
const toastText=document.getElementById("toastText");
const toastIcon=document.getElementById("toastIcon");
const bookingHelper=document.getElementById("bookingHelper");
const dayInfoHelper=document.getElementById("dayInfoHelper");

const customerModal=document.getElementById("customerModal");
const btnCustomerOpen=document.getElementById("btnCustomerOpen");
const modalClose=document.getElementById("modalClose");
const tabBtns=document.querySelectorAll(".tab-btn");
const loginTab=document.getElementById("loginTab");
const registerTab=document.getElementById("registerTab");
const btnLogin=document.getElementById("btnLogin");
const btnRegister=document.getElementById("btnRegister");
const customerLoggedBox=document.getElementById("customerLoggedBox");
const customerLoggedText=document.getElementById("customerLoggedText");
const btnCustomerLogout=document.getElementById("btnCustomerLogout");
const customerBtnLabel=document.getElementById("customerBtnLabel");
const customerAppsBox=document.getElementById("customerAppsBox");
const appListModal=document.getElementById("appListModal");
const tabsRow=document.getElementById("tabsRow");
const loginPhone=document.getElementById("loginPhone");
const loginPass=document.getElementById("loginPass");
const regName=document.getElementById("regName");
const regPhone=document.getElementById("regPhone");
const regPass=document.getElementById("regPass");

const adminModalEl=document.getElementById("adminModal");
const btnAdminOpen=document.getElementById("btnAdminOpen");
const adminModalClose=document.getElementById("adminModalClose");
const adminLoginArea=document.getElementById("adminLoginArea");
const adminPanelArea=document.getElementById("adminPanelArea");
const btnAdminLogin=document.getElementById("btnAdminLogin");
const btnAdminLogout=document.getElementById("btnAdminLogout");
const adminBtnLabel=document.getElementById("adminBtnLabel");
const adminTabBtns=document.querySelectorAll(".admin-tab");
const adminSections=document.querySelectorAll(".admin-section");
const adminPhoneInput=document.getElementById("adminPhone");
const adminPassInput=document.getElementById("adminPass");

const serviceListEl=document.getElementById("serviceList");
const newServiceNameEl=document.getElementById("newServiceName");
const newServicePriceEl=document.getElementById("newServicePrice");
const newServiceDurationEl=document.getElementById("newServiceDuration");
const btnAddService=document.getElementById("btnAddService");

const barberListEl=document.getElementById("barberList");
const newBarberNameEl=document.getElementById("newBarberName");
const newBarberPhotoFileEl=document.getElementById("newBarberPhotoFile");
const btnAddBarber=document.getElementById("btnAddBarber");
const btnResetData=document.getElementById("btnResetData");

const adminDateFilter=document.getElementById("adminDateFilter");
const adminBarberFilter=document.getElementById("adminBarberFilter");
const adminAppList=document.getElementById("adminAppList");
const adminCountInfo=document.getElementById("adminCountInfo");
const reportListEl=document.getElementById("reportList");
const btnPrintReports=document.getElementById("btnPrintReports");
const btnPrintAppointments=document.getElementById("btnPrintAppointments");
const btnCopyTodaySummary=document.getElementById("btnCopyTodaySummary");

const closedDateInput=document.getElementById("closedDateInput");
const btnAddClosedDate=document.getElementById("btnAddClosedDate");
const closedDateList=document.getElementById("closedDateList");

const scheduleModal=document.getElementById("scheduleModal");
const scheduleModalTitle=document.getElementById("scheduleModalTitle");
const scheduleModalClose=document.getElementById("scheduleModalClose");
const scheduleWrapper=document.getElementById("scheduleWrapper");
const btnSaveSchedule=document.getElementById("btnSaveSchedule");

const quickNotify=document.getElementById("quickNotify");
const quickBodyText=document.getElementById("quickBodyText");

const sumTodayCountEl=document.getElementById("sumTodayCount");
const sumTodayRevenueEl=document.getElementById("sumTodayRevenue");
const sumAllCountEl=document.getElementById("sumAllCount");
const sumAllRevenueEl=document.getElementById("sumAllRevenue");
const sumActiveBarberEl=document.getElementById("sumActiveBarber");
const sumTopServiceNameEl=document.getElementById("sumTopServiceName");
const sumTopServiceCountEl=document.getElementById("sumTopServiceCount");
const sumTopBarberNameEl=document.getElementById("sumTopBarberName");
const sumTopBarberCountEl=document.getElementById("sumTopBarberCount");

const customerListEl=document.getElementById("customerList");
const customerDetailEl=document.getElementById("customerDetail");
const topCustomerListEl=document.getElementById("topCustomerList");

/* YENİ: müşteri filtre inputları */
const adminCustomerSearchEl = document.getElementById("adminCustomerSearch");
const adminCustomerSegmentEl = document.getElementById("adminCustomerSegment");

/* reschedule */
const rescheduleModal = document.getElementById("rescheduleModal");
const rescheduleClose = document.getElementById("rescheduleClose");
const rescheduleDate = document.getElementById("rescheduleDate");
const rescheduleSlotGrid = document.getElementById("rescheduleSlotGrid");
const rescheduleInfo = document.getElementById("rescheduleInfo");
const btnRescheduleSave = document.getElementById("btnRescheduleSave");
let reschedApp = null;
let reschedSelectedTime = null;

/* ===== Helpers ===== */
function col(path){ return collection(db, path); }
function dref(path, id){ return doc(db, path, id); }

function todayStr(){
  const d=new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function parseLocalDate(str){
  const [y,m,d]=str.split("-").map(Number);
  return new Date(y, m-1, d);
}
function timeToMinutes(t){const [h,m]=t.split(":").map(Number); return h*60+m;}
function createDefaultSchedule(){
  const arr=[]; for(let i=0;i<7;i++){
    arr.push({active:i<6, intervals:[{start:"09:00", end:"19:00"}]});
  } return arr;
}
function slotIdFor(date, barberId, time){ return `${date}__${barberId}__${time}`; }
function cleanPhone10(p){ return String(p||"").replace(/\D/g,"").slice(-10); }

function showToast(message,type="ok"){
  if(toastTimer){clearTimeout(toastTimer);toastTimer=null;}
  toastText.textContent=message;
  toastIcon.textContent=type==="ok"?"✔":"!";
  toastEl.className="toast "+type;
  toastEl.style.display="flex";
  toastEl.style.opacity="1";
  toastEl.style.pointerEvents="auto";
  try{if(navigator.vibrate)navigator.vibrate(40);}catch(e){}
  toastTimer=setTimeout(()=>{
    toastEl.style.opacity="0";
    toastEl.style.pointerEvents="none";
    setTimeout(()=>{toastEl.style.display="none";},300);
  },5200);
}
function showQuickPopupFor(app){
  quickBodyText.textContent=`${app.date} ${app.time} • ${app.barberName} • ${app.serviceName}`;
  quickNotify.style.display="flex";
  setTimeout(()=>{quickNotify.style.display="none";},1700);
}

/* ===== Password hashing (basic) ===== */
async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
const PASS_SALT = "ATK_2026";

/* ===== Barber photo resize (small base64) ===== */
async function resizeImageToDataURL(file, max=256, quality=0.78){
  const dataUrl = await new Promise((res, rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
  const img = await new Promise((res, rej)=>{
    const i=new Image();
    i.onload=()=>res(i);
    i.onerror=rej;
    i.src=dataUrl;
  });
  const scale = Math.min(1, max/Math.max(img.width, img.height));
  const w = Math.round(img.width*scale);
  const h = Math.round(img.height*scale);
  const canvas = document.createElement("canvas");
  canvas.width=w; canvas.height=h;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(img,0,0,w,h);
  return canvas.toDataURL("image/jpeg", quality);
}

/* ===== Slot duration helpers ===== */
function serviceById(id){ return services.find(s=>s.id===id) || null; }
function slotsForDuration(startTime, duration){
  const dur = Math.max(30, Number(duration||30));
  const need = Math.ceil(dur/30);
  const idx = SLOT_TIMES.indexOf(startTime);
  if(idx<0) return [];
  const arr=[];
  for(let i=0;i<need;i++){
    const t=SLOT_TIMES[idx+i];
    if(!t) return [];
    arr.push(t);
  }
  return arr;
}

/* ===== Seed defaults (if empty) ===== */
async function seedIfEmpty(){
  const s = await getDocs(col(COL.services));
  if(s.empty){
    const defaults = [
      {id:"svc-sac",name:"Saç Kesim",price:500,duration:30},
      {id:"svc-sac-sakal",name:"Saç + Sakal",price:700,duration:60},
      {id:"svc-sakal",name:"Sakal",price:250,duration:30}
    ];
    for(const x of defaults) await setDoc(dref(COL.services, x.id), x);
  }

  const b = await getDocs(col(COL.barbers));
  if(b.empty){
    const defaults = [
      {id:"brb-ahmet",name:"Ahmet TEKELİ",photo:null},
      {id:"brb-cirak",name:"Çırak",photo:null}
    ];
    for(const x of defaults) await setDoc(dref(COL.barbers, x.id), x);
  }

  const sch = await getDocs(col(COL.schedules));
  if(sch.empty){
    const b2 = await getDocs(col(COL.barbers));
    for(const d of b2.docs){
      await setDoc(dref(COL.schedules, d.id), { barberId:d.id, days:createDefaultSchedule() });
    }
  }
}

/* ===== YENİ: geçmiş randevuları otomatik sil (bugünden önce) ===== */
let cleaningPast = false;
let lastCleanDay = null;

async function autoDeletePastAppointments(){
  const t = todayStr();
  if(lastCleanDay === t && cleaningPast) return;
  if(cleaningPast) return;
  cleaningPast = true;
  lastCleanDay = t;

  try{
    const pastPrimaries = appointments
      .filter(a=>!a.isLock)
      .filter(a=>a.date && a.date < t);

    if(!pastPrimaries.length){
      cleaningPast = false;
      return;
    }

    let refs = [];
    for(const a of pastPrimaries){
      const occ = (Array.isArray(a.occupiedTimes) && a.occupiedTimes.length)
        ? a.occupiedTimes
        : slotsForDuration(a.time, a.duration || serviceById(a.serviceId)?.duration || 30);

      for(const tt of occ){
        refs.push(dref(COL.apps, slotIdFor(a.date, a.barberId, tt)));
      }
    }

    // uniq
    const uniqMap = new Map();
    refs.forEach(r=>uniqMap.set(r.path, r));
    refs = Array.from(uniqMap.values());

    while(refs.length){
      const chunk = refs.splice(0, 450);
      const batch = writeBatch(db);
      chunk.forEach(ref=>batch.delete(ref));
      await batch.commit();
    }

  }catch(e){
    console.error(e);
  }finally{
    cleaningPast = false;
  }
}

/* ===== Realtime listeners ===== */
function startRealtime(){
  if(realtimeStarted) return;
  realtimeStarted=true;

  onSnapshot(col(COL.services), snap=>{
    services = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    renderServices();
    renderSlots();
    updateAdminSummary();
  });

  onSnapshot(col(COL.barbers), snap=>{
    barbers = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    if(!selectedBarberId && barbers[0]) selectedBarberId = barbers[0].id;
    if(selectedBarberId && !barbers.some(b=>b.id===selectedBarberId) && barbers[0]) selectedBarberId = barbers[0].id;
    renderBarbers();
    renderSlots();
    updateAdminSummary();
  });

  onSnapshot(col(COL.schedules), snap=>{
    const map={};
    snap.docs.forEach(d=>{
      const data=d.data()||{};
      map[d.id] = Array.isArray(data.days) ? data.days : createDefaultSchedule();
    });
    schedules = map;
    renderSlots();
    updateAdminSummary();
  });

  onSnapshot(col(COL.closed), snap=>{
    closedDates = snap.docs.map(d=>d.id).sort();
    renderClosedDateList();
    renderSlots();
  });

  onSnapshot(col(COL.apps), snap=>{
    const arr = snap.docs.map(d=>({id:d.id, ...d.data()}));
    arr.sort((a,b)=>`${a.date||""} ${a.time||""}`.localeCompare(`${b.date||""} ${b.time||""}`));
    appointments = arr;
    renderAll();

    // YENİ: geçmiş randevuları otomatik temizle (gelecek silinmez)
    autoDeletePastAppointments();
  });
}

/* ===== Renders ===== */
function renderServices(){
  servSel.innerHTML = services.map(s=>`
    <option value="${s.id}">${s.name} • ${Number(s.price||0)}₺ • ${Number(s.duration||0)}dk</option>
  `).join("");

  serviceListEl.innerHTML = services.map(s=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${s.name}</div>
        <div class="app-meta">${Number(s.price||0)} ₺ • ${Number(s.duration||0)} dk</div>
      </div>
      <div class="app-actions">
        <button class="btn-mini del" onclick="window.deleteService('${s.id}')">Sil</button>
      </div>
    </li>
  `).join("");
}

function renderBarbers(){
  barberSel.innerHTML = barbers.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");
  if(selectedBarberId) barberSel.value = selectedBarberId;

  barberChoicesEl.innerHTML = barbers.map(b=>{
    const initials=(b.name||"B").split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase();
    const sel = b.id===selectedBarberId ? "barber-chip selected" : "barber-chip";
    const avatar = b.photo ? `<img src="${b.photo}" alt="">` : initials;
    return `<div class="${sel}" data-id="${b.id}">
      <div class="barber-avatar">${avatar}</div><span>${b.name}</span>
    </div>`;
  }).join("");

  adminBarberFilter.innerHTML = `<option value="">Tümü</option>` +
    barbers.map(b=>`<option value="${b.id}">${b.name}</option>`).join("");

  barberListEl.innerHTML = barbers.map(b=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${b.name}</div>
        <div class="app-meta">Çalışma saatlerini düzenle</div>
      </div>
      <div class="app-actions">
        <button class="btn-mini note" onclick="window.openSchedule('${b.id}')">Saat</button>
        <button class="btn-mini del" onclick="window.deleteBarber('${b.id}')">Sil</button>
      </div>
    </li>
  `).join("");

  Array.from(barberChoicesEl.querySelectorAll(".barber-chip")).forEach(ch=>{
    ch.addEventListener("click",()=>setSelectedBarber(ch.getAttribute("data-id")));
  });
}

function setSelectedBarber(id){
  selectedBarberId=id;
  if(id) barberSel.value=id;
  Array.from(barberChoicesEl.querySelectorAll(".barber-chip")).forEach(ch=>{
    ch.classList.toggle("selected", ch.getAttribute("data-id")===id);
  });
  renderSlots();
}

function renderSlots(){
  const dateVal=dateInput.value;
  slotGrid.innerHTML="";
  selectedTime=null;

  if(!dateVal){ dayInfoHelper.textContent="Lütfen bir tarih seç."; return; }

  const today=todayStr();
  const todayDate=parseLocalDate(today);
  const picked=parseLocalDate(dateVal);

  if(picked<todayDate){ dayInfoHelper.textContent="Geçmiş tarihe randevu alınamaz."; return; }
  const diff=(picked-todayDate)/86400000;
  if(diff>MAX_DAYS_AHEAD){ dayInfoHelper.textContent=`En fazla ${MAX_DAYS_AHEAD} gün sonrasına randevu alabilirsin.`; return; }
  if(closedDates.includes(dateVal)){ dayInfoHelper.textContent="Bu tarih için dükkân kapalı."; return; }

  const barberId = selectedBarberId || barbers[0]?.id || null;
  const brb = barbers.find(b=>b.id===barberId)||null;

  const jsDay=picked.getDay();
  const dayIndex=(jsDay+6)%7;
  const daySch = schedules[barberId]?.[dayIndex] || null;

  if(daySch){
    if(!daySch.active){ dayInfoHelper.textContent=`${brb?brb.name:"Berber"} bu gün için pasif.`; return; }
    if(!daySch.intervals?.length){ dayInfoHelper.textContent=`${brb?brb.name:"Berber"} için bu güne saat tanımlı değil.`; return; }
  }

  const isToday = (dateVal===today);
  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes();

  const svc = serviceById(servSel.value);
  const duration = Number(svc?.duration || 30);

  const btns=[];
  for(const t of SLOT_TIMES){
    const tm=timeToMinutes(t);
    if(isToday && tm<=nowMin+2) continue;

    const needed = slotsForDuration(t, duration);
    if(!needed.length) continue;

    if(daySch){
      const endMin = tm + duration;
      let ok=false;
      for(const it of daySch.intervals){
        const s=timeToMinutes(it.start), e=timeToMinutes(it.end);
        if(tm>=s && endMin<=e){ ok=true; break; }
      }
      if(!ok) continue;
    }

    const disabled = needed.some(tt =>
      appointments.some(a=>a.date===dateVal && a.barberId===barberId && a.time===tt)
    );

    btns.push(`<button type="button" class="slot ${disabled?"disabled":""}" data-time="${t}" ${disabled?"disabled":""}>${t}</button>`);
  }

  if(!btns.length){ dayInfoHelper.textContent=`${brb?brb.name:"Berber"} için bu tarih/saatte uygun boşluk yok.`; return; }

  slotGrid.innerHTML=btns.join("");
  dayInfoHelper.textContent="";

  Array.from(slotGrid.querySelectorAll(".slot")).forEach(btn=>{
    btn.addEventListener("click",()=>{
      Array.from(slotGrid.querySelectorAll(".slot")).forEach(b=>b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedTime=btn.getAttribute("data-time");
    });
  });
}

function renderClosedDateList(){
  closedDateList.innerHTML = closedDates.map(d=>`
    <div class="closed-date-item">
      <span>${d}</span>
      <button class="btn-mini del" onclick="window.deleteClosedDate('${d}')">Sil</button>
    </div>
  `).join("");
}

/* ===== Customer panel (SADE) ===== */
function refreshCustomerUI(){
  if(currentCustomer){
    customerLoggedBox.style.display="block";
    tabsRow.style.display="none";
    loginTab.style.display="none";
    registerTab.style.display="none";
    customerLoggedText.innerHTML=`Hoş geldin <b>${currentCustomer.name||""}</b> • ${currentCustomer.phoneRaw||("0"+currentCustomer.phone10)}`;
    customerBtnLabel.textContent="Müşteri Paneli";
    nameInput.value=currentCustomer.name||"";
    phoneInput.value=currentCustomer.phoneRaw||"";
    bookingHelper.textContent="Hoş geldin, randevunu oluşturup aşağıdan saat seçebilirsin.";
  }else{
    customerLoggedBox.style.display="none";
    tabsRow.style.display="flex";
    loginTab.style.display="block";
    registerTab.style.display="none";
    tabBtns.forEach(b=>b.classList.toggle("active",b.dataset.tab==="login"));
    customerBtnLabel.textContent="Müşteri Paneli";
    bookingHelper.textContent="Randevu almak için önce müşteri girişi yapmalısın. Müşteri panelinden kayıt olabilirsin.";
  }
  renderMyAppointments();
}
function renderMyAppointments(){
  if(!currentCustomer){
    customerAppsBox.style.display="none";
    appListModal.innerHTML="";
    return;
  }

  const t=todayStr();
  const list = appointments
    .filter(a=>a.phone10===currentCustomer.phone10)
    .filter(a=>!a.isLock && (a.status||"active")==="active")
    .filter(a=>a.date && a.date>=t)
    .sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));

  customerAppsBox.style.display="block";

  if(!list.length){
    appListModal.innerHTML = `<li class="app-item"><div class="app-main"><div class="app-title">Aktif randevun yok.</div></div></li>`;
    return;
  }

  appListModal.innerHTML = list.map(a=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${a.date} • ${a.time}</div>
        <div class="app-meta">${a.serviceName} • ${a.barberName}</div>
      </div>
      <div class="app-actions">
        <button class="btn-mini edit" onclick="window.openReschedule('${a.id}')">Değiştir</button>
        <button class="btn-mini del" onclick="window.cancelMyAppointment('${a.id}')">İptal</button>
      </div>
    </li>
  `).join("");
}

/* ===== BOOK (transaction + duration locks) ===== */
async function createAppointmentTx(app){
  const svc = serviceById(app.serviceId);
  const duration = Number(svc?.duration || 30);
  const occupiedTimes = slotsForDuration(app.time, duration);
  if(!occupiedTimes.length) throw new Error("BAD_DURATION");

  const primaryId = slotIdFor(app.date, app.barberId, app.time);
  const primaryRef = dref(COL.apps, primaryId);
  const custRef = dref(COL.customers, app.phone10);

  await runTransaction(db, async (tx)=>{
    const refs = occupiedTimes.map(t=>dref(COL.apps, slotIdFor(app.date, app.barberId, t)));
    for(const r of refs){
      const s = await tx.get(r);
      if(s.exists()) throw new Error("SLOT_TAKEN");
    }

    const custSnap = await tx.get(custRef);
    if(!custSnap.exists()) throw new Error("NO_CUSTOMER");

    tx.set(primaryRef, {
      ...app,
      id: primaryId,
      duration,
      occupiedTimes,
      isLock:false,
      createdAt: serverTimestamp(),
      status:"active"
    });

    for(const t of occupiedTimes.slice(1)){
      const lockId = slotIdFor(app.date, app.barberId, t);
      tx.set(dref(COL.apps, lockId), {
        id: lockId,
        date: app.date,
        time: t,
        barberId: app.barberId,
        primaryId,
        phone10: app.phone10,
        isLock:true,
        createdAt: serverTimestamp(),
        status:"lock"
      });
    }
  });
}

/* ===== Events ===== */
dateInput.addEventListener("change",renderSlots);
servSel.addEventListener("change",renderSlots);

/* randevu al */
btnBook.addEventListener("click", async ()=>{
  const name = nameInput.value.trim();
  const phoneRaw = phoneInput.value.trim();
  const phone10 = cleanPhone10(phoneRaw);
  const serviceId = servSel.value;
  const barberId = selectedBarberId || barbers[0]?.id || null;
  const dateVal = dateInput.value;
  const timeVal = selectedTime;

  if(!currentCustomer){ showToast("Lütfen önce müşteri girişi yap.","err"); return; }
  if(currentCustomer.phone10 !== phone10){
    showToast("Randevu için giriş yaptığın telefon ile aynı telefonu yaz.","err");
    phoneInput.value = currentCustomer.phoneRaw||("0"+currentCustomer.phone10);
    return;
  }

  if(!name||!phone10||!serviceId||!barberId||!dateVal||!timeVal){
    showToast("Lütfen tüm alanları doldur ve saat seç.","err"); return;
  }

  const tStr=todayStr();
  if(dateVal<tStr){ showToast("Geçmiş tarihe randevu alınamaz.","err"); return; }
  const diff=(parseLocalDate(dateVal)-parseLocalDate(tStr))/86400000;
  if(diff>MAX_DAYS_AHEAD){ showToast(`En fazla ${MAX_DAYS_AHEAD} gün sonrasına randevu alabilirsin.`,"err"); return; }
  if(closedDates.includes(dateVal)){ showToast("Bu tarih kapalı.","err"); return; }

  const svc=serviceById(serviceId);
  const brb=barbers.find(b=>b.id===barberId);

  const app={
    id:"",
    name,
    phone10,
    phoneRaw,
    date:dateVal,
    time:timeVal,
    serviceId,
    serviceName:svc?svc.name:"İşlem",
    price:svc?Number(svc.price||0):0,
    barberId,
    barberName:brb?brb.name:"Berber",
  };

  try{
    await createAppointmentTx(app);
    showQuickPopupFor(app);
    showToast("Randevun oluşturuldu.","ok");
  }catch(e){
    if(String(e.message).includes("SLOT_TAKEN")){
      showToast("Bu saat az önce alındı. Başka saat seç.","err");
      renderSlots();
    }else if(String(e.message).includes("NO_CUSTOMER")){
      showToast("Müşteri kaydı bulunamadı.","err");
    }else{
      console.error(e);
      showToast("Kayıt hatası (Rules/izin olabilir).","err");
    }
  }
});

/* müşteri modal */
btnCustomerOpen.addEventListener("click",()=>{customerModal.style.display="flex";});
modalClose.addEventListener("click",()=>{customerModal.style.display="none";});

/* müşteri tablar */
tabBtns.forEach(btn=>{
  btn.addEventListener("click",()=>{
    const t=btn.dataset.tab;
    tabBtns.forEach(b=>b.classList.toggle("active",b===btn));
    loginTab.style.display=t==="login"?"block":"none";
    registerTab.style.display=t==="register"?"block":"none";
  });
});

/* Kayıt (Firestore) */
btnRegister.addEventListener("click", async ()=>{
  const name = regName.value.trim();
  const phoneRaw = regPhone.value.trim();
  const phone10 = cleanPhone10(phoneRaw);
  const pass = regPass.value.trim();

  if(!name||!phone10||!pass){ showToast("Lütfen tüm alanları doldur.","err"); return; }
  if(pass.length<4){ showToast("Şifre en az 4 karakter olmalı.","err"); return; }

  try{
    const ref = dref(COL.customers, phone10);
    const ex = await getDoc(ref);
    if(ex.exists()){ showToast("Bu telefon ile kayıt zaten var.","err"); return; }

    const passHash = await sha256(PASS_SALT + pass);
    await setDoc(ref, {
      name,
      phone10,
      phoneRaw,
      passHash,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });

    currentCustomer = { name, phone10, phoneRaw };
    localStorage.setItem(LS_CURRENT_CUST, phone10);
    refreshCustomerUI();
    showToast("Kayıt oluşturuldu, giriş yapıldı.","ok");
  }catch(e){
    console.error(e);
    showToast("Kayıt hatası (Rules/izin olabilir).","err");
  }
});

/* Giriş (Firestore) */
btnLogin.addEventListener("click", async ()=>{
  const phoneRaw = loginPhone.value.trim();
  const phone10 = cleanPhone10(phoneRaw);
  const pass = loginPass.value.trim();

  if(!phone10||!pass){ showToast("Telefon ve şifre gir.","err"); return; }

  try{
    const ref = dref(COL.customers, phone10);
    const snap = await getDoc(ref);
    if(!snap.exists()){ showToast("Kayıt bulunamadı.","err"); return; }

    const data = snap.data()||{};
    const passHash = await sha256(PASS_SALT + pass);
    if(passHash !== data.passHash){ showToast("Telefon veya şifre hatalı.","err"); return; }

    currentCustomer = {
      name: data.name||"",
      phone10,
      phoneRaw: data.phoneRaw||("0"+phone10),
    };
    localStorage.setItem(LS_CURRENT_CUST, phone10);
    refreshCustomerUI();
    showToast("Giriş başarılı.","ok");
  }catch(e){
    console.error(e);
    showToast("Giriş hatası (Rules/izin olabilir).","err");
  }
});

/* müşteri çıkış */
btnCustomerLogout.addEventListener("click",()=>{
  currentCustomer=null;
  localStorage.removeItem(LS_CURRENT_CUST);
  refreshCustomerUI();
  showToast("Müşteri çıkış yapıldı.","ok");
});

/* ===== Reschedule (değiştir) ===== */
rescheduleClose.addEventListener("click",()=>{ rescheduleModal.style.display="none"; });
rescheduleDate.addEventListener("change",()=>renderRescheduleSlots());

window.openReschedule = (id)=>{
  const a = appointments.find(x=>x.id===id);
  if(!a) return;

  reschedApp = a;
  reschedSelectedTime = null;

  rescheduleDate.value = a.date;
  renderRescheduleSlots();
  rescheduleModal.style.display = "flex";
};

function renderRescheduleSlots(){
  rescheduleSlotGrid.innerHTML = "";
  rescheduleInfo.textContent = "";
  reschedSelectedTime = null;

  if(!reschedApp) return;
  const dateVal = rescheduleDate.value;
  if(!dateVal){ rescheduleInfo.textContent="Tarih seç."; return; }

  const tStr=todayStr();
  if(dateVal<tStr){ rescheduleInfo.textContent="Geçmiş tarihe randevu taşınamaz."; return; }
  const diff=(parseLocalDate(dateVal)-parseLocalDate(tStr))/86400000;
  if(diff>MAX_DAYS_AHEAD){ rescheduleInfo.textContent=`En fazla ${MAX_DAYS_AHEAD} gün sonrasına taşınabilir.`; return; }
  if(closedDates.includes(dateVal)){ rescheduleInfo.textContent="Bu tarih kapalı."; return; }

  const duration = Number(reschedApp.duration || serviceById(reschedApp.serviceId)?.duration || 30);
  const barberId = reschedApp.barberId;

  const oldOcc = Array.isArray(reschedApp.occupiedTimes)
    ? reschedApp.occupiedTimes
    : slotsForDuration(reschedApp.time, duration);

  const picked = parseLocalDate(dateVal);
  const jsDay=picked.getDay();
  const dayIndex=(jsDay+6)%7;
  const daySch = schedules[barberId]?.[dayIndex] || null;

  const now = new Date();
  const isToday = (dateVal===tStr);
  const nowMin = now.getHours()*60 + now.getMinutes();

  const btns=[];
  for(const t of SLOT_TIMES){
    const tm = timeToMinutes(t);
    if(isToday && tm<=nowMin+2) continue;

    const needed = slotsForDuration(t, duration);
    if(!needed.length) continue;

    if(daySch){
      if(!daySch.active) continue;
      const endMin = tm + duration;
      let ok=false;
      for(const it of daySch.intervals){
        const s=timeToMinutes(it.start), e=timeToMinutes(it.end);
        if(tm>=s && endMin<=e){ ok=true; break; }
      }
      if(!ok) continue;
    }

    const disabled = needed.some(tt=>{
      const isOwnOld = (dateVal===reschedApp.date && oldOcc.includes(tt));
      if(isOwnOld) return false;
      return appointments.some(a=>a.date===dateVal && a.barberId===barberId && a.time===tt);
    });

    btns.push(`<button type="button" class="slot ${disabled?"disabled":""}" data-time="${t}" ${disabled?"disabled":""}>${t}</button>`);
  }

  if(!btns.length){ rescheduleInfo.textContent="Uygun saat yok."; return; }
  rescheduleSlotGrid.innerHTML = btns.join("");

  Array.from(rescheduleSlotGrid.querySelectorAll(".slot")).forEach(b=>{
    b.addEventListener("click",()=>{
      Array.from(rescheduleSlotGrid.querySelectorAll(".slot")).forEach(x=>x.classList.remove("selected"));
      b.classList.add("selected");
      reschedSelectedTime = b.getAttribute("data-time");
    });
  });
}

async function moveAppointmentTx(oldApp, newDate, newStartTime){
  const duration = Number(oldApp.duration || serviceById(oldApp.serviceId)?.duration || 30);
  const barberId = oldApp.barberId;

  const oldOcc = Array.isArray(oldApp.occupiedTimes) ? oldApp.occupiedTimes : slotsForDuration(oldApp.time, duration);
  const newOcc = slotsForDuration(newStartTime, duration);
  if(!newOcc.length) throw new Error("BAD_DURATION");

  await runTransaction(db, async (tx)=>{
    for(const t of newOcc){
      const id = slotIdFor(newDate, barberId, t);
      const ref = dref(COL.apps, id);
      const snap = await tx.get(ref);

      const isOwnOld = (newDate===oldApp.date && oldOcc.includes(t));
      if(snap.exists() && !isOwnOld) throw new Error("SLOT_TAKEN");
    }

    for(const t of oldOcc){
      tx.delete(dref(COL.apps, slotIdFor(oldApp.date, barberId, t)));
    }

    const newPrimaryId = slotIdFor(newDate, barberId, newStartTime);
    tx.set(dref(COL.apps, newPrimaryId), {
      ...oldApp,
      id: newPrimaryId,
      date: newDate,
      time: newStartTime,
      duration,
      occupiedTimes: newOcc,
      isLock:false,
      status:"active",
      updatedAt: serverTimestamp()
    });

    for(const t of newOcc.slice(1)){
      const lockId = slotIdFor(newDate, barberId, t);
      tx.set(dref(COL.apps, lockId), {
        id: lockId,
        date: newDate,
        time: t,
        barberId,
        primaryId: newPrimaryId,
        phone10: oldApp.phone10,
        isLock:true,
        createdAt: serverTimestamp(),
        status:"lock"
      });
    }
  });
}

btnRescheduleSave.addEventListener("click", async ()=>{
  if(!reschedApp){ showToast("Seçili randevu yok.","err"); return; }
  const newDate = rescheduleDate.value;
  const newTime = reschedSelectedTime;

  if(!newDate || !newTime){ showToast("Tarih ve saat seç.","err"); return; }

  try{
    await moveAppointmentTx(reschedApp, newDate, newTime);
    rescheduleModal.style.display="none";
    showToast("Randevu değiştirildi.","ok");
  }catch(e){
    if(String(e.message).includes("SLOT_TAKEN")){
      showToast("Bu saat dolu. Başka saat seç.","err");
      renderRescheduleSlots();
    }else{
      console.error(e);
      showToast("Değiştirme hatası.","err");
    }
  }
});

/* ===== Admin modal ===== */
btnAdminOpen.addEventListener("click",()=>{adminModalEl.style.display="flex";});
adminModalClose.addEventListener("click",()=>{adminModalEl.style.display="none";});

/* admin giriş */
btnAdminLogin.addEventListener("click",()=>{
  const phone=adminPhoneInput.value.trim(), pass=adminPassInput.value.trim();
  if(phone===ADMIN_PHONE && pass===ADMIN_PASS){
    isAdminLoggedIn=true; localStorage.setItem(LS_ADMIN,"1");
    adminLoginArea.style.display="none";
    adminPanelArea.style.display="block";
    adminBtnLabel.textContent="Admin Paneli";
    // YENİ: admin tarih filtresi bugüne sabitlenmiş olsun (boş kalmasın)
    if(!adminDateFilter.value) adminDateFilter.value = todayStr();
    showToast("Admin giriş başarılı.","ok");
  }else showToast("Admin bilgileri hatalı.","err");
});

/* admin çıkış */
btnAdminLogout.addEventListener("click",()=>{
  isAdminLoggedIn=false; localStorage.removeItem(LS_ADMIN);
  adminLoginArea.style.display="block";
  adminPanelArea.style.display="none";
  adminBtnLabel.textContent="Admin Girişi";
  showToast("Admin çıkış yapıldı.","ok");
});

/* admin sekmeler */
adminTabBtns.forEach(btn=>{
  btn.addEventListener("click",()=>{
    const id=btn.dataset.adminSection;
    adminTabBtns.forEach(b=>b.classList.toggle("active",b===btn));
    adminSections.forEach(sec=>sec.classList.toggle("active",sec.id===id));
    if(id==="adminSectionMusteri") renderAdminCustomers();
    if(id==="adminSectionRandevu"){
      // YENİ: admin randevu sekmesi açılınca bugünü göster
      if(!adminDateFilter.value) adminDateFilter.value = todayStr();
      renderAdminAppointments();
    }
  });
});

/* admin filtreler */
adminDateFilter.addEventListener("change",renderAdminAppointments);
adminBarberFilter.addEventListener("change",renderAdminAppointments);

/* YENİ: müşteri filtre olayları */
if(adminCustomerSearchEl){
  adminCustomerSearchEl.addEventListener("input", ()=>{
    if(document.getElementById("adminSectionMusteri").classList.contains("active")){
      renderAdminCustomers();
    }
  });
}
if(adminCustomerSegmentEl){
  adminCustomerSegmentEl.addEventListener("change", ()=>{
    if(document.getElementById("adminSectionMusteri").classList.contains("active")){
      renderAdminCustomers();
    }
  });
}

/* Hizmet ekle (FS) */
btnAddService.addEventListener("click", async ()=>{
  const name=newServiceNameEl.value.trim();
  const price=Number(newServicePriceEl.value||0);
  const dur=Number(newServiceDurationEl.value||0);
  if(!name||!dur){ showToast("Hizmet adı ve süre gir.","err"); return; }
  if(dur%30!==0){ showToast("Süre 30 dk katı olmalı (30/60/90).","err"); return; }

  const id="svc_"+Date.now();
  try{
    await setDoc(dref(COL.services, id), { id, name, price, duration:dur });
    newServiceNameEl.value=""; newServicePriceEl.value=""; newServiceDurationEl.value="";
    showToast("Hizmet eklendi.","ok");
  }catch(e){
    console.error(e);
    showToast("Hizmet ekleme hatası (Rules/izin).","err");
  }
});
window.deleteService = async (id)=>{
  try{ await deleteDoc(dref(COL.services, id)); showToast("Hizmet silindi.","ok"); }
  catch(e){ console.error(e); showToast("Silme hatası","err"); }
};

/* Berber ekle (FS) */
btnAddBarber.addEventListener("click", async ()=>{
  const name=newBarberNameEl.value.trim();
  if(!name){ showToast("Berber adı gir.","err"); return; }

  let photo=null;
  const f=newBarberPhotoFileEl.files?.[0];
  if(f){
    try{ photo = await resizeImageToDataURL(f, 256, 0.78); }catch(e){}
  }

  const id="brb_"+Date.now();
  try{
    await setDoc(dref(COL.barbers, id), { id, name, photo: photo||null });
    await setDoc(dref(COL.schedules, id), { barberId:id, days:createDefaultSchedule() });
    newBarberNameEl.value=""; newBarberPhotoFileEl.value="";
    selectedBarberId=id;
    showToast("Berber eklendi.","ok");
  }catch(e){
    console.error(e);
    showToast("Berber ekleme hatası (Rules/izin).","err");
  }
});
window.deleteBarber = async (id)=>{
  try{
    await deleteDoc(dref(COL.barbers, id));
    await deleteDoc(dref(COL.schedules, id));
    if(selectedBarberId===id) selectedBarberId = barbers[0]?.id||null;
    showToast("Berber silindi.","ok");
  }catch(e){
    console.error(e);
    showToast("Silme hatası","err");
  }
};

/* Kapalı günler (FS) */
btnAddClosedDate.addEventListener("click", async ()=>{
  const d=closedDateInput.value;
  if(!d) return;
  try{
    await setDoc(dref(COL.closed, d), { date:d, createdAt: serverTimestamp() });
    showToast("Kapalı gün eklendi.","ok");
  }catch(e){
    console.error(e);
    showToast("Kapalı gün ekleme hatası","err");
  }
});
window.deleteClosedDate = async (d)=>{
  try{ await deleteDoc(dref(COL.closed, d)); showToast("Kapalı gün silindi.","ok"); }
  catch(e){ console.error(e); showToast("Silme hatası","err"); }
};

/* Randevu sil / müşteri iptal (FS) */
async function deleteAppointmentById(id, source="admin"){
  try{
    let app = appointments.find(a=>a.id===id);
    if(!app){ showToast("Randevu bulunamadı.","err"); return; }

    if(app.isLock && app.primaryId){
      const p = appointments.find(x=>x.id===app.primaryId);
      if(p){ app=p; id=p.id; }
    }

    const occ = (app?.occupiedTimes && Array.isArray(app.occupiedTimes))
      ? app.occupiedTimes
      : slotsForDuration(app.time, app.duration || serviceById(app.serviceId)?.duration || 30);

    for(const t of occ){
      const delId = slotIdFor(app.date, app.barberId, t);
      try{ await deleteDoc(dref(COL.apps, delId)); }catch(e){}
    }

    showToast(source==="customer"?"Randevun iptal edildi.":"Randevu silindi.","ok");
  }catch(e){
    console.error(e);
    showToast("Silme hatası (Rules/izin).","err");
  }
}
window.deleteAppointment = (id)=>deleteAppointmentById(id,"admin");
window.cancelMyAppointment = (id)=>deleteAppointmentById(id,"customer");

window.markNoShow = async (id)=>{
  try{
    const app=appointments.find(a=>a.id===id);
    if(!app || app.isLock) return;
    await setDoc(dref(COL.apps, id), { status:"noshow" }, {merge:true});
    showToast("Randevu 'gelmedi' olarak işaretlendi.","ok");
  }catch(e){
    console.error(e);
    showToast("İşaretleme hatası","err");
  }
};

/* WhatsApp */
window.sendWp=(phone,msg)=>{
  const clean=String(phone||"").replace(/\D/g,"").slice(-10);
  const url=`https://wa.me/90${clean}?text=${msg}`;
  window.open(url,"_blank");
};
window.sendWpTemplate=(type,phone,nameEnc)=>{
  const name = decodeURIComponent(nameEnc || "");
  let text = "";
  if(type==="reminder"){
    text=`Merhaba ${name||""}, Ahmet Tekeli Erkek Kuaförü'nden yazıyoruz. Yaklaşan randevunuzu hatırlatmak istedik. Randevu saatinde gelemeyecekseniz lütfen önceden bilgi verin.`;
  }else if(type==="back"){
    text=`Merhaba ${name||""}, bir süredir sizi göremedik 😊 Saç / sakal bakımınız için uygun olduğunuzda online randevu linkimizden kolayca yer ayırtabilirsiniz.`;
  }else if(type==="vip"){
    text=`Merhaba ${name||""}, Ahmet Tekeli Erkek Kuaförü'nü sık tercih ettiğiniz için teşekkür ederiz 🙏 Sadakatiniz bizim için çok değerli.`;
  }else{
    text=`Merhaba ${name||""}, Ahmet Tekeli Erkek Kuaförü'nden yazıyorum.`;
  }
  const clean=String(phone||"").replace(/\D/g,"").slice(-10);
  const url=`https://wa.me/90${clean}?text=${encodeURIComponent(text)}`;
  window.open(url,"_blank");
};

/* ===== Admin Lists ===== */
function renderAdminAppointments(){
  // YENİ: admin tarih filtresi boşsa bugünü baz al
  if(!adminDateFilter.value) adminDateFilter.value = todayStr();

  let list=[...appointments].filter(a=>!a.isLock);
  const fDate=adminDateFilter.value, fBarber=adminBarberFilter.value;
  if(fDate) list=list.filter(a=>a.date===fDate);
  if(fBarber) list=list.filter(a=>a.barberId===fBarber);

  adminAppList.innerHTML = list.map(a=>{
    const status=a.status||"active";
    const statusBadge=status==="noshow"?'<span style="color:#f97373;font-weight:900;">(Gelmedi)</span>':"";
    const noshowBtn=status==="noshow"?"":`<button class="btn-mini note" onclick="window.markNoShow('${a.id}')">Gelmedi</button>`;
    return `<li class="app-item">
      <div class="app-main">
        <div class="app-title">${a.date} • ${a.time} ${statusBadge}</div>
        <div class="app-meta">${a.name} • ${a.phoneRaw||""}</div>
        <div class="app-meta">${a.serviceName} • ${a.price} ₺ • ${a.barberName} • ${Number(a.duration||serviceById(a.serviceId)?.duration||30)} dk</div>
      </div>
      <div class="app-actions">
        ${noshowBtn}
        <button class="btn-mini del" onclick="window.deleteAppointment('${a.id}')">Sil</button>
        <button class="btn-mini wp" onclick="window.sendWp('${a.phoneRaw||""}','${encodeURIComponent("Randevunuz "+a.date+" "+a.time+" için oluşturulmuştur")}')">WP</button>
      </div>
    </li>`;
  }).join("");

  adminCountInfo.textContent=`${list.length} adet randevu listelendi.`;
  updateAdminSummary();
}

function renderReports(){
  const map={};
  appointments
    .filter(a=>!a.isLock && (a.status||"active")!=="noshow")
    .forEach(a=>{
      const key=`${a.date}#${a.serviceName}`;
      if(!map[key]) map[key]={date:a.date, service:a.serviceName, count:0, total:0};
      map[key].count++;
      map[key].total += Number(a.price||0);
    });
  const rows=Object.values(map).sort((a,b)=>a.date.localeCompare(b.date));
  reportListEl.innerHTML = rows.map(r=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${r.date} • ${r.service}</div>
        <div class="app-meta">${r.count} adet • ${r.total} ₺</div>
      </div>
    </li>
  `).join("");
  updateAdminSummary();
}

function updateAdminSummary(){
  const t=todayStr();
  const validPrimary = appointments.filter(a=>!a.isLock);
  const todays=validPrimary.filter(a=>a.date===t && (a.status||"active")!=="noshow");
  let todayRev=0; todays.forEach(a=>todayRev+=Number(a.price||0));

  const valid=validPrimary.filter(a=>(a.status||"active")!=="noshow");
  let allRev=0; valid.forEach(a=>allRev+=Number(a.price||0));

  const now=new Date(); const jsDay=now.getDay(); const idx=(jsDay+6)%7;
  const activeBarbers=barbers.filter(b=>{
    const d=schedules[b.id]?.[idx];
    return d && d.active && d.intervals && d.intervals.length>0;
  }).length;

  sumTodayCountEl.textContent=todays.length;
  sumTodayRevenueEl.textContent=todayRev+" ₺";
  sumAllCountEl.textContent=valid.length;
  sumAllRevenueEl.textContent=allRev+" ₺";
  sumActiveBarberEl.textContent=activeBarbers;

  let topServiceId=null, topCount=0, sCounts={};
  valid.forEach(a=>{ if(a.serviceId) sCounts[a.serviceId]=(sCounts[a.serviceId]||0)+1; });
  Object.keys(sCounts).forEach(id=>{ if(sCounts[id]>topCount){ topCount=sCounts[id]; topServiceId=id; }});
  if(topServiceId){
    const svc=services.find(s=>s.id===topServiceId);
    sumTopServiceNameEl.textContent=svc?svc.name:"Bilinmiyor";
    sumTopServiceCountEl.textContent=topCount+" adet";
  }else{
    sumTopServiceNameEl.textContent="-"; sumTopServiceCountEl.textContent="0 adet";
  }

  let topBarberId=null, topBarberCount=0, bCounts={};
  valid.forEach(a=>{ if(a.barberId) bCounts[a.barberId]=(bCounts[a.barberId]||0)+1; });
  Object.keys(bCounts).forEach(id=>{ if(bCounts[id]>topBarberCount){ topBarberCount=bCounts[id]; topBarberId=id; }});
  if(topBarberId){
    const brb=barbers.find(b=>b.id===topBarberId);
    sumTopBarberNameEl.textContent=brb?brb.name:"Bilinmiyor";
    sumTopBarberCountEl.textContent=topBarberCount+" adet";
  }else{
    sumTopBarberNameEl.textContent="-"; sumTopBarberCountEl.textContent="0 adet";
  }
}

/* ===== Admin Customers ===== */
async function fetchCustomersForAdmin(){
  try{
    const snap = await getDocs(col(COL.customers));
    return snap.docs.map(d=>({phone10:d.id, ...d.data()}));
  }catch(e){ return []; }
}
async function computeCustomerAgg(){
  const cust = await fetchCustomersForAdmin();
  const map={};
  cust.forEach(c=>{
    map[c.phone10]={customer:c, visits:0, spend:0, lastDate:null, cancelCount:0, segment:"Yeni"};
  });

  appointments.filter(a=>!a.isLock).forEach(a=>{
    if(!a.phone10) return;
    if(!map[a.phone10]){
      map[a.phone10]={customer:{name:a.name||"Müşteri", phone10:a.phone10}, visits:0, spend:0, lastDate:null, cancelCount:0, segment:"Yeni"};
    }
    const row=map[a.phone10];
    const st=a.status||"active";
    if(st==="noshow"){ row.cancelCount++; return; }
    row.visits++;
    row.spend+=Number(a.price||0);
    if(a.date && (!row.lastDate || a.date>row.lastDate)) row.lastDate=a.date;
  });

  const now=new Date();
  Object.values(map).forEach(row=>{
    let diff=Infinity;
    if(row.lastDate) diff=(now-parseLocalDate(row.lastDate))/86400000;

    if(row.visits>=20 || row.spend>=5000) row.segment="VIP";
    else if(diff<=60 && row.visits>=3) row.segment="Düzenli";
    else if(diff>90 && row.visits>0) row.segment="Uzun Süredir Gelmeyen";
    else row.segment="Yeni";
  });

  const arr=Object.values(map).sort((a,b)=>(b.lastDate||"0000-00-00").localeCompare(a.lastDate||"0000-00-00"));
  customerAgg=arr;
  return arr;
}

async function renderAdminCustomers(){
  const aggAll = await computeCustomerAgg();

  const q = (adminCustomerSearchEl?.value || "").trim().toLowerCase();
  const seg = (adminCustomerSegmentEl?.value || "").trim();

  let agg = aggAll;

  if(seg){
    agg = agg.filter(r => (r.segment||"") === seg);
  }
  if(q){
    agg = agg.filter(r=>{
      const c=r.customer||{};
      const name=(c.name||"").toLowerCase();
      const phone=(c.phoneRaw||("0"+(c.phone10||""))).toLowerCase();
      const phone10=(c.phone10||"").toLowerCase();
      return name.includes(q) || phone.includes(q) || phone10.includes(q);
    });
  }

  if(!agg.length){
    customerListEl.innerHTML = `<li class="app-item"><div class="app-main"><div class="app-title">Sonuç bulunamadı.</div></div></li>`;
    customerDetailEl.style.display="none";
    customerDetailEl.innerHTML="";
    topCustomerListEl.innerHTML="";
    return;
  }

  customerListEl.innerHTML = agg.map(row=>{
    const c=row.customer;
    const seg=row.segment;
    let color="#60a5fa";
    if(seg==="VIP") color="#facc15";
    else if(seg==="Düzenli") color="#22c55e";
    else if(seg==="Uzun Süredir Gelmeyen") color="#f97373";

    const badge = `<span style="padding:2px 7px;border-radius:999px;font-size:10px;background:${color}22;color:${color};border:1px solid ${color}80;">${seg}</span>`;
    const phoneDisplay = c.phoneRaw || ("0"+c.phone10);

    return `
      <li class="app-item">
        <div class="app-main">
          <div class="app-title">${c.name||"Müşteri"} • ${phoneDisplay}</div>
          <div class="app-meta">${row.visits} randevu • ${row.spend} ₺</div>
          <div class="app-meta">Son gelme: ${row.lastDate || "-"} ${badge}</div>
        </div>
        <div class="app-actions">
          <button class="btn-mini note" onclick="window.openCustomerDetail('${c.phone10}')">Detay</button>
          <button class="btn-mini wp" onclick="window.sendWpTemplate('reminder','${phoneDisplay}','${encodeURIComponent(c.name||"")}')">Hatırlatma</button>
          <button class="btn-mini del" onclick="window.deleteCustomer('${c.phone10}')">Müşteri Sil</button>
        </div>
      </li>
    `;
  }).join("");

  const top=[...aggAll].sort((a,b)=>b.visits-a.visits).slice(0,5);
  topCustomerListEl.innerHTML = top.map(row=>`
    <li class="app-item">
      <div class="app-main">
        <div class="app-title">${row.customer.name||"Müşteri"}</div>
        <div class="app-meta">${row.visits} randevu • ${row.spend} ₺</div>
      </div>
    </li>
  `).join("");
}

window.openCustomerDetail=(phone10)=>{
  const row=customerAgg.find(r=>r.customer.phone10===phone10);
  if(!row){ customerDetailEl.style.display="none"; customerDetailEl.innerHTML=""; return; }

  const c=row.customer;
  const list = appointments
    .filter(a=>!a.isLock && a.phone10===phone10)
    .sort((a,b)=>(b.date+b.time).localeCompare(a.date+a.time))
    .slice(0,10);

  const items = list.length ? list.map(a=>{
    const status=a.status==="noshow"?' • <span style="color:#f97373;">(Gelmedi)</span>':"";
    return `<li class="app-item"><div class="app-main">
      <div class="app-title">${a.date} • ${a.time}${status}</div>
      <div class="app-meta">${a.serviceName} • ${a.price} ₺ • ${a.barberName}</div>
    </div></li>`;
  }).join("") : `<div class="helper">Bu müşteri için kayıtlı randevu bulunmuyor.</div>`;

  const phoneDisplay = c.phoneRaw || ("0"+c.phone10);

  customerDetailEl.style.display="block";
  customerDetailEl.innerHTML=`
    <div class="section-title" style="color:#e5e7eb;">${c.name||"Müşteri"} • ${phoneDisplay}</div>
    <div class="helper">Toplam ${row.visits} randevu • ${row.spend} ₺</div>
    <div class="helper">Segment: ${row.segment}</div>
    <div class="section-title" style="margin-top:8px;color:#e5e7eb;">Son Randevular</div>
    <ul class="app-list">${items}</ul>
  `;
};

window.deleteCustomer = async (phone10)=>{
  const row=customerAgg.find(r=>r.customer.phone10===phone10);
  const name=row?.customer?.name || phone10;
  if(!confirm(`Müşteri silinsin mi?\n${name}\n\nBu işlem müşteri kaydını siler.`)) return;

  try{
    await deleteDoc(dref(COL.customers, phone10));
    if(currentCustomer?.phone10===phone10){
      currentCustomer=null;
      localStorage.removeItem(LS_CURRENT_CUST);
      refreshCustomerUI();
    }
    showToast("Müşteri silindi.","ok");
  }catch(e){
    console.error(e);
    showToast("Müşteri silme hatası (Rules/izin).","err");
  }
};

/* PDF */
btnPrintReports.addEventListener("click",()=>{
  adminTabBtns.forEach(b=>b.classList.remove("active"));
  document.querySelector('[data-admin-section="adminSectionRapor"]').classList.add("active");
  adminSections.forEach(sec=>sec.classList.toggle("active",sec.id==="adminSectionRapor"));
  window.print();
});
btnPrintAppointments.addEventListener("click",()=>{
  adminTabBtns.forEach(b=>b.classList.remove("active"));
  document.querySelector('[data-admin-section="adminSectionRandevu"]').classList.add("active");
  adminSections.forEach(sec=>sec.classList.toggle("active",sec.id==="adminSectionRandevu"));
  window.print();
});

/* Bugün özet */
btnCopyTodaySummary.addEventListener("click",()=>{
  const t=todayStr();
  const todays=appointments.filter(a=>!a.isLock && a.date===t && (a.status||"active")!=="noshow");
  let rev=0; todays.forEach(a=>rev+=Number(a.price||0));
  const sCounts={},bCounts={};
  todays.forEach(a=>{
    if(a.serviceName)sCounts[a.serviceName]=(sCounts[a.serviceName]||0)+1;
    if(a.barberName)bCounts[a.barberName]=(bCounts[a.barberName]||0)+1;
  });
  let topSvc="-",topSvcCount=0;
  Object.keys(sCounts).forEach(n=>{if(sCounts[n]>topSvcCount){topSvcCount=sCounts[n];topSvc=n;}});
  let topBar="-",topBarCount=0;
  Object.keys(bCounts).forEach(n=>{if(bCounts[n]>topBarCount){topBarCount=bCounts[n];topBar=n;}});

  const text=
`Bugün Ahmet Tekeli Erkek Kuaförü'nde toplam ${todays.length} randevu tamamlandı.
Toplam ciro: ${rev} ₺.
En çok tercih edilen işlem: ${topSvc}${topSvc!=="-"?" ("+topSvcCount+" adet)":""}.
En çok randevu alan berber: ${topBar}${topBar!=="-"?" ("+topBarCount+" adet)":""}.

💈 Online randevu için profilimizdeki linke tıkla.`;

  if(navigator.clipboard?.writeText){
    navigator.clipboard.writeText(text).then(()=>showToast("Bugün özeti panoya kopyalandı.","ok"))
      .catch(()=>{showToast("Kopyalama desteklenmiyor.","err");alert(text);});
  }else{ showToast("Kopyalama desteklenmiyor.","err"); alert(text); }
});

/* Schedule modal */
scheduleModalClose.addEventListener("click",()=>{scheduleModal.style.display="none";});
window.openSchedule=(id)=>{
  currentScheduleBarberId=id;
  const brb=barbers.find(b=>b.id===id);
  if(!brb) return;
  scheduleModalTitle.textContent=`${brb.name} • Çalışma Saatleri`;

  const sch = Array.isArray(schedules[id]) ? schedules[id] : createDefaultSchedule();
  scheduleWrapper.innerHTML="";

  for(let i=0;i<7;i++){
    const d=sch[i]||{active:(i<6),intervals:[{start:"09:00",end:"19:00"}]};
    const intervalsHtml=(d.intervals||[]).map(it=>`
      <div class="schedule-interval">
        <select data-role="start">${SLOT_TIMES.map(t=>`<option value="${t}" ${t===it.start?"selected":""}>${t}</option>`).join("")}</select>
        <select data-role="end">${SLOT_TIMES.map(t=>`<option value="${t}" ${t===it.end?"selected":""}>${t}</option>`).join("")}</select>
        <button type="button" onclick="this.closest('.schedule-interval').remove()">Sil</button>
      </div>
    `).join("");

    scheduleWrapper.insertAdjacentHTML("beforeend",`
      <div class="schedule-row" data-day-index="${i}">
        <div class="schedule-row-head">
          <div class="schedule-day-name">${DAY_NAMES[i]}</div>
          <label class="day-active-label">
            <input type="checkbox" ${d.active?"checked":""}>Aktif
          </label>
        </div>
        <div class="schedule-intervals">${intervalsHtml}</div>
        <button class="btn-add-interval" type="button">Aralık Ekle</button>
      </div>
    `);
  }

  Array.from(scheduleWrapper.querySelectorAll(".btn-add-interval")).forEach(btn=>{
    btn.addEventListener("click",()=>{
      const container=btn.closest(".schedule-row").querySelector(".schedule-intervals");
      container.insertAdjacentHTML("beforeend",`
        <div class="schedule-interval">
          <select data-role="start">${SLOT_TIMES.map(t=>`<option value="${t}">${t}</option>`).join("")}</select>
          <select data-role="end">${SLOT_TIMES.map(t=>`<option value="${t}">${t}</option>`).join("")}</select>
          <button type="button" onclick="this.closest('.schedule-interval').remove()">Sil</button>
        </div>
      `);
    });
  });

  scheduleModal.style.display="flex";
};

btnSaveSchedule.addEventListener("click", async ()=>{
  if(!currentScheduleBarberId) return;
  const sch=[];
  for(let i=0;i<7;i++){
    const dayRow=scheduleWrapper.querySelector(`[data-day-index="${i}"]`);
    const active=dayRow.querySelector("input[type=checkbox]").checked;
    const intervalEls=dayRow.querySelectorAll(".schedule-interval");
    const intervals=[];
    intervalEls.forEach(row=>{
      const s=row.querySelector("select[data-role=start]").value;
      const e=row.querySelector("select[data-role=end]").value;
      if(s && e && s<e) intervals.push({start:s,end:e});
    });
    sch.push({active, intervals});
  }
  try{
    await setDoc(dref(COL.schedules, currentScheduleBarberId), { barberId:currentScheduleBarberId, days:sch }, {merge:true});
    scheduleModal.style.display="none";
    showToast("Çalışma saatleri kaydedildi.","ok");
    setSelectedBarber(currentScheduleBarberId);
  }catch(e){
    console.error(e);
    showToast("Kaydetme hatası (Rules/izin).","err");
  }
});

/* Reset local session */
btnResetData.addEventListener("click",()=>{
  localStorage.removeItem(LS_ADMIN);
  localStorage.removeItem(LS_CURRENT_CUST);
  showToast("Bu cihazdaki oturum temizlendi.","ok");
  setTimeout(()=>location.reload(),800);
});

/* renderAll */
async function renderAll(){
  renderServices();
  renderBarbers();
  renderSlots();
  renderAdminAppointments();
  renderMyAppointments();
  renderReports();
  if(document.getElementById("adminSectionMusteri").classList.contains("active")){
    await renderAdminCustomers();
  }
  renderClosedDateList();
}

/* init session */
async function restoreSession(){
  isAdminLoggedIn = localStorage.getItem(LS_ADMIN)==="1";
  const phone10 = localStorage.getItem(LS_CURRENT_CUST);
  if(phone10){
    try{
      const snap = await getDoc(dref(COL.customers, phone10));
      if(snap.exists()){
        const d=snap.data()||{};
        currentCustomer = {
          name: d.name||"",
          phone10,
          phoneRaw: d.phoneRaw||("0"+phone10),
        };
      }
    }catch(e){}
  }
}

/* init */
async function init(){
  const t = todayStr();
  dateInput.value = t;

  await restoreSession();

  // YENİ: admin randevu filtresi bugüne ayarlı (boş kalmasın)
  adminDateFilter.value = t;

  if(isAdminLoggedIn){
    adminLoginArea.style.display="none";
    adminPanelArea.style.display="block";
    adminBtnLabel.textContent="Admin Paneli";
  }

  refreshCustomerUI();

  try{
    await seedIfEmpty();
  }catch(e){
    console.error(e);
    showToast("Firestore izin/Rules sorunu olabilir.","err");
  }

  startRealtime();
}
init();
</script>
</body>
</html>
